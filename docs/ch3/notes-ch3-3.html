<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>notes-ch3-3.md</title>
    <!-- MathJax for LaTeX support -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']]
            }
        };
    </script>
    <style>
        /* Pygments Syntax Highlighting */
        pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.codehilite .hll { background-color: #ffffcc }
.codehilite { background: #f8f8f8; }
.codehilite .c { color: #3D7B7B; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #FF0000 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666666 } /* Operator */
.codehilite .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #9C6500 } /* Comment.Preproc */
.codehilite .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.codehilite .gr { color: #E40000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #008400 } /* Generic.Inserted */
.codehilite .go { color: #717171 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #0044DD } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #687822 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.codehilite .no { color: #880000 } /* Name.Constant */
.codehilite .nd { color: #AA22FF } /* Name.Decorator */
.codehilite .ni { color: #717171; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #0000FF } /* Name.Function */
.codehilite .nl { color: #767600 } /* Name.Label */
.codehilite .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #bbbbbb } /* Text.Whitespace */
.codehilite .mb { color: #666666 } /* Literal.Number.Bin */
.codehilite .mf { color: #666666 } /* Literal.Number.Float */
.codehilite .mh { color: #666666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666666 } /* Literal.Number.Oct */
.codehilite .sa { color: #BA2121 } /* Literal.String.Affix */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .dl { color: #BA2121 } /* Literal.String.Delimiter */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #A45A77 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .fm { color: #0000FF } /* Name.Function.Magic */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .vm { color: #19177C } /* Name.Variable.Magic */
.codehilite .il { color: #666666 } /* Literal.Number.Integer.Long */

        /* Base CSS from markdown_styles.py */
        
        /* Basic reset and fonts */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            padding: 0;
            background-color: #f8f9fa;
        }

        /* Navigation styling */
        .nav {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            padding-bottom: 0.8rem;
            border-bottom: 1px solid #e1e4e8;
        }

        .nav span {
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .nav .activenav {
            background-color: #f1f8ff;
        }

        .nav .activenav a {
            color: #0366d6;
            text-decoration: none;
        }

        .nav .activenav a:hover {
            text-decoration: underline;
        }

        .nav .inactivenav {
            color: #959da5;
            background-color: #f6f8fa;
        }

        /* Center column layout */
        .container {
            max-width: 800px;
            margin: 2rem auto;
            background-color: white;
            padding: 2rem 3rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Typography */
        h1 {
            font-size: 2.2rem;
            margin-bottom: 1.5rem;
            color: #2c3e50;
            border-bottom: 2px solid #eee;
            padding-bottom: 0.5rem;
        }

        h2 {
            font-size: 1.8rem;
            margin: 2rem 0 1rem;
            color: #34495e;
        }

        h3 {
            font-size: 1.5rem;
            margin: 1.8rem 0 1rem;
            color: #34495e;
        }

        h4 {
            font-size: 1.3rem;
            margin: 1.5rem 0 0.8rem;
            color: #34495e;
        }

        h5 {
            font-size: 1.1rem;
            margin: 1.2rem 0 0.8rem;
            color: #34495e;
        }

        /* Table of Contents styling */
        .table-of-contents {
            margin: 0 0 0;
            line-height: 1;
        }

        .toc-list {
            margin: 0;
            padding-left: 20px;
        }

        .toc-list li {
            margin-bottom: 2px;
        }
        .toc-list ul {
            margin-bottom: 2px;
        }

        .exercise-list {
            margin: 0;
            padding-left: 0;
            font-size: 0.95em;
            display: inline;
        }

        .exercise-container {
            display: inline-block;
            margin-top: 2px;
            line-height: 1.2;
        }

        .toc-exercises {
            font-style: italic;
            color: #555;
        }

        .exercise-list a {
            text-decoration: none;
            color: #2070b0;
            margin-right: 0;
        }

        .exercise-list a:hover {
            text-decoration: underline;
        }

        .exercise-list span:not(:last-child):after {
            content: ", ";
            color: #777;
            margin-right: 0;
        }

        /* Blockquote styling */
        blockquote {
            border-left: 4px solid #dfe2e5;
            color: #6a737d;
            padding: 0 1rem;
            margin: 1rem 0 1.5rem;
            background-color: #f6f8fa;
            border-radius: 0 3px 3px 0;
        }

        blockquote p {
            padding: 0.8rem 0;
        }

        blockquote p:first-child {
            margin-top: 0;
        }

        blockquote p:last-child {
            margin-bottom: 0;
        }

        /* Solution styling */
        h5:has(+p:contains("Solution")) {
            margin-bottom: 0;
        }

        h5:has(+p:contains("Solution")) + p {
            font-weight: bold;
            color: #3c8dbc;
            border-left: 3px solid #3c8dbc;
            padding-left: 0.8rem;
            margin: 0.5rem 0 1rem;
        }

        p {
            margin-bottom: 1rem;
        }

        /* List styling */
        ul, ol {
            margin-bottom: 1rem;
            padding-left: 2.5rem;
        }

        ul li, ol li {
            margin-bottom: 0.5rem;
        }

        /* Code blocks */
        .code-box {
            background-color: #f6f8fa;
            border-radius: 6px;
            overflow: hidden;
            margin: 1rem 0 1.5rem;
            border: 1px solid #e1e4e8;
        }

        .code-header {
            font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.75rem;
            color: #6a737d;
            padding: 0.3rem 0 0rem 0.3rem;
            border-bottom: 1px solid #e1e4e8;
            background-color: #fafbfc;
        }

        .code-header a {
            color: #6a737d;
            text-decoration: none;
        }

        .code-header a:hover {
            text-decoration: underline;
            color: #0366d6;
        }

        /* Standalone code blocks (triple backticks) */
        .codehilite {
            background-color: #f6f8fa;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1rem 0 1.5rem;
            border: 1px solid #e1e4e8;
        }

        /* When inside a code-box, remove default styling */
        .code-box .codehilite {
            margin: 0;
            padding: 0;
            border: none;
            border-radius: 0;
        }

        /* Adjust padding for code blocks inside code-box */
        .code-box .codehilite pre {
            padding: 0.2rem 0 0.3rem 0.3rem;
            overflow-x: auto;
            margin: 0;
        }

        /* Normal padding for standalone code blocks */
        .codehilite pre {
            padding: 1rem;
            overflow-x: auto;
            margin: 0;
        }

        .code-output {
            font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.75rem;
            color: #6a737d;
            padding: 0.2rem 0 0.3rem 0.3rem;
            border-top: 1px solid #e1e4e8;
            background-color: #fafbfc;
        }
        .code-output span {
            color: #de37cc;
        }

        .code-output pre {
            margin: 0;
            white-space: pre-wrap;
            font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
        }
        /* --- Styles for Collapsible Code Blocks --- */
        .collapsible-code {
            border: none; /* Remove default border from details */
            margin-top: 0; /* Adjust spacing if needed */
            margin-bottom: 0; /* Adjust spacing if needed */
        }

        .code-summary {
            font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.75rem;
            color: #6a737d;
            padding: 0.5rem 0.8rem; /* Adjusted padding */
            border-bottom: 1px solid #e1e4e8;
            background-color: #fafbfc;
            cursor: pointer;
            list-style: none; /* Hide default marker */
            display: block; /* Make it block level */
            border-radius: 6px 6px 0 0; /* Round top corners like header */
            position: relative; /* For positioning the marker */
            transition: background-color 0.1s ease-in-out;
        }

        .code-summary:hover {
            background-color: #f1f3f5; /* Slight hover effect */
        }

        /* Add custom marker */
        .code-summary::before {
            content: '►'; /* Collapsed marker */
            position: absolute;
            left: 0.8rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.6em;
            color: #6a737d;
            margin-right: 0.5rem;
            transition: transform 0.2s ease-in-out;
        }

        .collapsible-code[open] > .code-summary::before {
            transform: translateY(-50%) rotate(90deg); /* Expanded marker */
        }

        .collapsible-code[open] > .code-summary {
             border-bottom: 1px solid #e1e4e8; /* Ensure border shows when open */
             border-radius: 6px 6px 0 0; /* Keep top rounding when open */
        }

        /* Adjust summary content positioning relative to marker */
        .code-summary a {
            margin-left: 1.2rem; /* Space for the marker */
            color: #6a737d;
            text-decoration: none;
        }
        .code-summary a:hover {
            text-decoration: underline;
            color: #0366d6;
        }

        /* New style for the expand hint */
        .expand-hint {
            font-style: italic;
            font-size: 0.85em;
            color: #888;
            margin-left: 0.5rem;
        }

        /* Ensure content inside details has appropriate spacing/styling */
        .collapsible-code > .codehilite {
            margin: 0;
            border-radius: 0 0 6px 6px; /* Round bottom corners */
            border: none; /* Remove border from codehilite itself */
            border-top: none; /* Remove top border */
        }

        /* Since code output is now outside the details element,
           we need to adjust its styling */
        .collapsible-code + .code-output {
            border-radius: 0 0 6px 6px; /* Round bottom corners */
            margin-top: 0; /* Remove gap */
            border-top: 1px solid #e1e4e8;
        }

        /* Ensure code output has proper border when outside details */
        .code-box > .code-output {
            border-top: 1px solid #e1e4e8;
        }

        .collapsible-code > .run-racket {
             margin-left: 1rem; /* Indent run button */
             margin-bottom: 1rem; /* Add bottom margin */
        }
        /* --- End Collapsible Styles --- */

        code {
            font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.9em;
            padding: 0.2em 0.4em;
            background-color: #f6f8fa;
            border-radius: 3px;
        }

        .codehilite code {
            padding: 0;
            background-color: transparent;
        }

        /* Links */
        a {
            color: #0366d6;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        /* Run button */
        .run-racket {
            display: inline-block;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.4rem 0.8rem;
            background-color: #3c8dbc;
            color: white;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .run-racket:hover {
            background-color: #367fa9;
            text-decoration: none;
        }

        /* Make LaTeX display nicely */
        .MathJax {
            overflow-x: auto;
            overflow-y: hidden;
        }
    
    </style>
</head>
<body>
    <div class="container">
        <div class="nav">
    <span class="activenav"><a href="notes-ch3-2.html">← Previous</a></span>
    <span class="activenav"><a href="../index.html">↑ Up</a></span>
    <span class="activenav"><a href="notes-ch3-4.html">Next →</a></span>
</div>

<p><a href="https://sarabander.github.io/sicp/html/3_002e3.xhtml#g_t3_002e3">HTML Book Chapter 3.3 Link</a></p>
<p><div class="table-of-contents">
<h2>Directory</h2>
<ul class="toc-list">
<ul>
<li><a href="#section-33">Section 3.3</a></li>
<ul>
<li><a href="#notes">Notes</a></li>
<li><a href="#meeting-05-25-2025">Meeting 05-25-2025</a></li>
<li><a href="#exercises" class="toc-exercises">Exercises</a>
<div class="exercise-container">(
<span class="exercise-list">
<span><a href="#exercise-312">Exercise 3.12</a></span>
<span><a href="#exercise-313">Exercise 3.13</a></span>
<span><a href="#exercise-314">Exercise 3.14</a></span>
<span><a href="#exercise-315">Exercise 3.15</a></span>
<span><a href="#exercise-316">Exercise 3.16</a></span>
<span><a href="#exercise-317">Exercise 3.17</a></span>
<span><a href="#exercise-318">Exercise 3.18</a></span>
<span><a href="#exercise-319">Exercise 3.19</a></span>
<span><a href="#exercise-320">Exercise 3.20</a></span>
<span><a href="#exercise-321">Exercise 3.21</a></span>
<span><a href="#exercise-322">Exercise 3.22</a></span>
<span><a href="#exercise-323">Exercise 3.23</a></span>
<span><a href="#exercise-324">Exercise 3.24</a></span>
<span><a href="#exercise-325">Exercise 3.25</a></span>
<span><a href="#exercise-326">Exercise 3.26</a></span>
<span><a href="#exercise-327">Exercise 3.27</a></span>
<span><a href="#exercise-328">Exercise 3.28</a></span>
<span><a href="#exercise-329">Exercise 3.29</a></span>
<span><a href="#exercise-330">Exercise 3.30</a></span>
<span><a href="#exercise-331">Exercise 3.31</a></span>
<span><a href="#exercise-332">Exercise 3.32</a></span>
<span><a href="#exercise-333">Exercise 3.33</a></span>
<span><a href="#exercise-334">Exercise 3.34</a></span>
<span><a href="#exercise-335">Exercise 3.35</a></span>
<span><a href="#exercise-336">Exercise 3.36</a></span>
<span><a href="#exercise-337">Exercise 3.37</a></span>
</span>)
</div></li>
</ul>
</ul>
</ul>
</div></p>
<h2 id="section-33">Section 3.3</h2>
<h3 id="notes">Notes</h3>
<div class="code-box">
<div class="code-header"><a href="code/examples-3-3.rkt">code/examples-3-3.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>



<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="p">)</span><span class="w"> </span><span class="ss">c</span><span class="w"> </span><span class="ss">d</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">e</span><span class="w"> </span><span class="ss">f</span><span class="p">))</span>

<span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>

<span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">h</span><span class="p">)</span>
<span class="n">x</span>
<span class="n">y</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>((h f) c d)
(h f)
</pre>
</div>
</div>

<ul>
<li>It would be nice to have a proof that we can't construct an (efficient) queue
without <code>set!</code>, or if that's true.</li>
</ul>
<h3 id="meeting-05-25-2025">Meeting 05-25-2025</h3>
<ul>
<li>Eric Grimson 2004 MIT lectures on SICP <a href="https://www.youtube.com/watch?v=SDsxFreEYsc&amp;list=PL7BcsI5ueSNFPCEisbaoQ0kXIDX9rR5FF&amp;t=1962s">13. Environment Model</a>.</li>
<li><a href="https://www.youtube.com/watch?v=vMDHpPN_p08">From here to lambda and back again - Douglas Crockford at RacketCon</a></li>
<li>p-list vs a-list</li>
<li>
<p>In the context of the end of chapter 3-3, constraint solvers: First order predicate and expert systems.</p>
</li>
<li>
<p>Note on one of the problems: Given the implementation of <code>append!</code>, I had to intialize a supposedly empty list to a dummy pair <code>(list dummy '())</code>. Specifically I was referring to the line <code>(define tracker (list 'first-element))</code> in my solution to <a href="https://physbuzz.github.io/sicp/ch3/notes-ch3-3.html#exercise-317">exercise 17</a></p>
</li>
<li><a href="http://clqr.boundp.org/">Common lisp quick reference</a></li>
</ul>
<h3 id="exercises">Exercises</h3>
<h4 id="exercise-312">Exercise 3.12</h4>
<p>The following procedure for
appending lists was introduced in 2.2.1:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">      </span><span class="n">y</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
</code></pre></div>

<p><code>Append</code> forms a new list by successively <code>cons</code>ing the elements of
<code>x</code> onto <code>y</code>.  The procedure <code>append!</code> is similar to
<code>append</code>, but it is a mutator rather than a constructor.  It appends the
lists by splicing them together, modifying the final pair of <code>x</code> so that
its <code>cdr</code> is now <code>y</code>.  (It is an error to call <code>append!</code> with an
empty <code>x</code>.)</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">append!</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="p">(</span><span class="nb">last-pair</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">  </span><span class="n">x</span><span class="p">)</span>
</code></pre></div>

<p>Here <code>last-pair</code> is a procedure that returns the last pair in its
argument:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">last-pair</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">      </span><span class="n">x</span>
<span class="w">      </span><span class="p">(</span><span class="nb">last-pair</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))))</span>
</code></pre></div>

<p>Consider the interaction</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">c</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">d</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>

<span class="n">z</span>
<span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>

<span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="n">⟨response⟩</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="p">(</span><span class="n">append!</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>

<span class="n">w</span>
<span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>

<span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="n">⟨response⟩</span>
</code></pre></div>

<p>What are the missing <code>⟨response⟩</code>s?  Draw box-and-pointer diagrams to
explain your answer.</p>
<h5>Solution</h5>
<div class="code-box">
<div class="code-header"><a href="code/ex3-12.rkt">code/ex3-12.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">append!</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="p">(</span><span class="nb">last-pair</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">  </span><span class="n">x</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">last-pair</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">      </span><span class="n">x</span>
<span class="w">      </span><span class="p">(</span><span class="nb">last-pair</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">c</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">d</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>

<span class="n">z</span>
<span class="c1">; (a b c d)</span>

<span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="c1">; (b)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="p">(</span><span class="n">append!</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="c1">; (last-pair x) gives (cons &#39;b nil)</span>
<span class="c1">; We set this pair&#39;s 2nd element to y, which is (cons &#39;c (cons &#39;d nil))</span>
<span class="c1">; So x is now &#39;(a b c d)</span>

<span class="n">w</span>
<span class="c1">; (a b c d)</span>

<span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="c1">; (b c d)</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>(a b c d)
(b)
(a b c d)
(b c d)
</pre>
</div>
</div>

<div style="text-align: center; margin: 20px 0;">
  <img src="img/ex3-12.svg" style="width: 70%; max-width: 800px;" alt="A box-and-pointer diagram, what do you want?">
</div>

<h4 id="exercise-313">Exercise 3.13</h4>
<p>Consider the following
<code>make-cycle</code> procedure, which uses the <code>last-pair</code> procedure defined
in Exercise 3.12:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-cycle</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="p">(</span><span class="nb">last-pair</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="n">x</span><span class="p">)</span>
</code></pre></div>

<p>Draw a box-and-pointer diagram that shows the structure <code>z</code> created by</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="p">(</span><span class="n">make-cycle</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">b</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">c</span><span class="p">)))</span>
</code></pre></div>

<p>What happens if we try to compute <code>(last-pair z)</code>?</p>
<h5>Solution</h5>
<p>If we try to compute <code>(last-pair z)</code>, the algorithm will run
until it finds a pair which has a cdr equal to nil. Unfortunately this will never happen!</p>
<div style="text-align: center; margin: 20px 0;">
  <img src="img/ex3-13.svg" style="width: 70%; max-width: 800px;" alt="A box-and-pointer diagram, what do you want?">
</div>

<h4 id="exercise-314">Exercise 3.14</h4>
<p>The following procedure is quite
useful, although obscure:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mystery</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">loop</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">        </span><span class="n">y</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">temp</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="n">loop</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="n">x</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">loop</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()))</span>
</code></pre></div>

<p><code>Loop</code> uses the "temporary" variable <code>temp</code> to hold the old value
of the <code>cdr</code> of <code>x</code>, since the <code>set-cdr!</code>  on the next line
destroys the <code>cdr</code>.  Explain what <code>mystery</code> does in general.  Suppose
<code>v</code> is defined by <code>(define v (list 'a 'b 'c 'd))</code>. Draw the
box-and-pointer diagram that represents the list to which <code>v</code> is bound.
Suppose that we now evaluate <code>(define w (mystery v))</code>. Draw
box-and-pointer diagrams that show the structures <code>v</code> and <code>w</code> after
evaluating this expression.  What would be printed as the values of <code>v</code>
and <code>w</code>?</p>
<h5>Solution</h5>
<div class="code-box">
<div class="code-header"><a href="code/ex3-14.rkt">code/ex3-14.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="c1">; invariants: </span>
<span class="c1">;   x and y together contain all original elements of x</span>
<span class="c1">;   y contains elements of the original x in reversed order</span>
<span class="c1">;   </span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mystery</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">loop</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">        </span><span class="n">y</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">temp</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="n">loop</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="n">x</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">loop</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">b</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">c</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">d</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="p">(</span><span class="n">mystery</span><span class="w"> </span><span class="n">v</span><span class="p">))</span>

<span class="n">w</span>
<span class="n">v</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>(d c b a)
(a)
</pre>
</div>
</div>

<p>This is a recursive algorithm for reversing a linked list. One way to see this is
to look at the invariant <code>(append (reverse y) x)</code>, which will always be equal to
the original list. Certainly it's true for <code>y='()</code> and <code>x=list</code>. On subsequent steps,
we can look at the function call <code>(loop temp x-modified)</code> and work backwards 
(where I use <code>x-modified</code> to refer to x after being mutated with <code>set-cdr!</code></p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="p">(</span><span class="nb">reverse</span><span class="w"> </span><span class="n">x-modified</span><span class="p">)</span><span class="w"> </span><span class="n">temp</span><span class="p">)</span>
<span class="nb">=</span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="p">(</span><span class="nb">reverse</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">y</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="nb">=</span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="p">(</span><span class="nb">reverse</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="nb">=</span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="p">(</span><span class="nb">reverse</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
</code></pre></div>

<p>So the loop invariant is preserved, the length of the first argument decreases by one
each step, and at the end when <code>x='()</code> we have <code>list = (reverse y)</code> so the list is reversed.</p>
<p>Less proof-ey, more intuitively, recall that every pair in the linked list has a pointer to the element stored
and a pointer to the next element stored. We want to change this second pointer 
to point towards the previous element in the list. We do this by storing 
the previous pair in the list as <code>y</code> and the rest of the not-updated list as <code>x</code>.</p>
<div style="text-align: center; margin: 20px 0;">
  <img src="img/ex3-14.svg" style="width: 70%; max-width: 800px;" alt="A box-and-pointer diagram, what do you want?">
</div>

<h4 id="exercise-315">Exercise 3.15</h4>
<p>Draw box-and-pointer diagrams to
explain the effect of <code>set-to-wow!</code> on the structures <code>z1</code> and
<code>z2</code> above.</p>
<h5>Solution</h5>
<div style="text-align: center; margin: 20px 0;">
  <img src="img/ex3-15.svg" style="width: 70%; max-width: 800px;" alt="A box-and-pointer diagram, what do you want?">
</div>

<p>So this explains why in the first case when we call <code>set-to-wow!</code> it seems like
"both pairs" are changed. In fact we are changing the first pair, x, and it is pointed to
twice.</p>
<p>In the case of <code>z2</code>, these point to two separate lists.</p>
<h4 id="exercise-316">Exercise 3.16</h4>
<p>Ben Bitdiddle decides to write a
procedure to count the number of pairs in any list structure.  <code>It's easy,''
he reasons.</code>The number of pairs in any structure is the number in the
<code>car</code> plus the number in the <code>cdr</code> plus one more to count the current
pair.''  So Ben writes the following procedure:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">count-pairs</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nb">pair?</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">      </span><span class="mi">0</span>
<span class="w">      </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">count-pairs</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="n">count-pairs</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">         </span><span class="mi">1</span><span class="p">)))</span>
</code></pre></div>

<p>Show that this procedure is not correct.  In particular, draw box-and-pointer
diagrams representing list structures made up of exactly three pairs for which
Ben's procedure would return 3; return 4; return 7; never return at all.</p>
<h5>Solution</h5>
<div class="code-box">
<div class="code-header"><a href="code/ex3-16.rkt">code/ex3-16.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">count-pairs</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nb">pair?</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">      </span><span class="mi">0</span>
<span class="w">      </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">count-pairs</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="n">count-pairs</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">         </span><span class="mi">1</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">list1</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="p">))</span>
<span class="p">(</span><span class="n">count-pairs</span><span class="w"> </span><span class="n">list1</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">list2</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="p">))</span>
<span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="n">list2</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">list2</span><span class="p">))</span>
<span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="n">list2</span><span class="w"> </span><span class="p">(</span><span class="nb">cddr</span><span class="w"> </span><span class="n">list2</span><span class="p">))</span>
<span class="p">(</span><span class="n">count-pairs</span><span class="w"> </span><span class="n">list2</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">list3</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="p">))</span>
<span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">list3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cddr</span><span class="w"> </span><span class="n">list3</span><span class="p">))</span>
<span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="n">list3</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">list3</span><span class="p">))</span>
<span class="p">(</span><span class="n">count-pairs</span><span class="w"> </span><span class="n">list3</span><span class="p">)</span>

<span class="c1">;; We could do the following, but it would never halt so I&#39;m not doing it</span>
<span class="c1">;; (define list4 &#39;(a c))</span>
<span class="c1">;; (set-cdr! (cdr list4) list4)</span>
<span class="c1">;; (count-pairs list4)</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>3
4
7
</pre>
</div>
</div>

<p>The explanation of the construction of the four different lists is explained
in this image:</p>
<div style="text-align: center; margin: 20px 0;">
  <img src="img/ex3-16.svg" style="width: 70%; max-width: 800px;" alt="A box-and-pointer diagram, what do you want?">
</div>

<h4 id="exercise-317">Exercise 3.17</h4>
<p>Devise a correct version of the
<code>count-pairs</code> procedure of Exercise 3.16 that returns the number of
distinct pairs in any structure.  (Hint: Traverse the structure, maintaining an
auxiliary data structure that is used to keep track of which pairs have already
been counted.)</p>
<h5>Solution</h5>
<div class="code-box">
<div class="code-header"><a href="code/ex3-17.rkt">code/ex3-17.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">last-pair</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">      </span><span class="n">x</span>
<span class="w">      </span><span class="p">(</span><span class="nb">last-pair</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">append!</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="p">(</span><span class="nb">last-pair</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">  </span><span class="n">x</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">member?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">lst</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">lst</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">eq?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">lst</span><span class="p">))</span><span class="w"> </span><span class="no">#t</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">member?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">lst</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">count-pairs</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">tracker</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">first-element</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">count-pairs-inner</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">tracker</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nb">pair?</span><span class="w"> </span><span class="n">x</span><span class="p">))</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">          </span><span class="p">((</span><span class="n">member?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">tracker</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="k">begin</span><span class="w"> </span>
<span class="w">            </span><span class="p">(</span><span class="n">append!</span><span class="w"> </span><span class="n">tracker</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">               </span><span class="p">(</span><span class="n">count-pairs-inner</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">tracker</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="n">count-pairs-inner</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">tracker</span><span class="p">))))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">count-pairs-inner</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">tracker</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">list1</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="p">))</span>
<span class="p">(</span><span class="n">count-pairs</span><span class="w"> </span><span class="n">list1</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">list2</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="p">))</span>
<span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="n">list2</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">list2</span><span class="p">))</span>
<span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="n">list2</span><span class="w"> </span><span class="p">(</span><span class="nb">cddr</span><span class="w"> </span><span class="n">list2</span><span class="p">))</span>
<span class="p">(</span><span class="n">count-pairs</span><span class="w"> </span><span class="n">list2</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">list3</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="p">))</span>
<span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">list3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cddr</span><span class="w"> </span><span class="n">list3</span><span class="p">))</span>
<span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="n">list3</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">list3</span><span class="p">))</span>
<span class="p">(</span><span class="n">count-pairs</span><span class="w"> </span><span class="n">list3</span><span class="p">)</span>

<span class="c1">;; No more infinite looping!</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">list4</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="p">))</span>
<span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="p">(</span><span class="nb">cddr</span><span class="w"> </span><span class="n">list4</span><span class="p">)</span><span class="w"> </span><span class="n">list4</span><span class="p">)</span>
<span class="p">(</span><span class="n">count-pairs</span><span class="w"> </span><span class="n">list4</span><span class="p">)</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>3
3
3
3
</pre>
</div>
</div>

<h4 id="exercise-318">Exercise 3.18</h4>
<p>Write a procedure that examines a
list and determines whether it contains a cycle, that is, whether a program
that tried to find the end of the list by taking successive <code>cdr</code>s would
go into an infinite loop.  Exercise 3.13 constructed such lists.</p>
<h5>Solution</h5>
<div class="code-box">
<div class="code-header"><a href="code/ex3-18.rkt">code/ex3-18.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">last-pair</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">      </span><span class="n">x</span>
<span class="w">      </span><span class="p">(</span><span class="nb">last-pair</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">append!</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="p">(</span><span class="nb">last-pair</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">  </span><span class="n">x</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">member?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">lst</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">lst</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">eq?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">lst</span><span class="p">))</span><span class="w"> </span><span class="no">#t</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">member?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">lst</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">contains-loop?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">loop-inner</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">tracker</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">          </span><span class="p">((</span><span class="n">member?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">tracker</span><span class="p">)</span><span class="w"> </span><span class="no">#t</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">loop-inner</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="n">tracker</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">x</span><span class="p">))))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">loop-inner</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">list1</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="p">))</span>
<span class="p">(</span><span class="n">contains-loop?</span><span class="w"> </span><span class="n">list1</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">list2</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="p">))</span>
<span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="n">list2</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">list2</span><span class="p">))</span>
<span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="n">list2</span><span class="w"> </span><span class="p">(</span><span class="nb">cddr</span><span class="w"> </span><span class="n">list2</span><span class="p">))</span>
<span class="p">(</span><span class="n">contains-loop?</span><span class="w"> </span><span class="n">list2</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">list3</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="p">))</span>
<span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">list3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cddr</span><span class="w"> </span><span class="n">list3</span><span class="p">))</span>
<span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="n">list3</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">list3</span><span class="p">))</span>
<span class="p">(</span><span class="n">contains-loop?</span><span class="w"> </span><span class="n">list3</span><span class="p">)</span>

<span class="c1">;; No more infinite looping!</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">list4</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="p">))</span>
<span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="p">(</span><span class="nb">cddr</span><span class="w"> </span><span class="n">list4</span><span class="p">)</span><span class="w"> </span><span class="n">list4</span><span class="p">)</span>
<span class="p">(</span><span class="n">contains-loop?</span><span class="w"> </span><span class="n">list4</span><span class="p">)</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>#f
#f
#f
#t
</pre>
</div>
</div>

<h4 id="exercise-319">Exercise 3.19</h4>
<p>Redo Exercise 3.18 using an
algorithm that takes only a constant amount of space.  (This requires a very
clever idea.)</p>
<h5>Solution</h5>
<div class="code-box">
<div class="code-header"><a href="code/ex3-19.rkt">code/ex3-19.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">last-pair</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">      </span><span class="n">x</span>
<span class="w">      </span><span class="p">(</span><span class="nb">last-pair</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">append!</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="p">(</span><span class="nb">last-pair</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">  </span><span class="n">x</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">member?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">lst</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">lst</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">eq?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">lst</span><span class="p">))</span><span class="w"> </span><span class="no">#t</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">member?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">lst</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">contains-loop?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; Checks if we can cdr x n times</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">try-step</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">          </span><span class="p">((</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nb">pair?</span><span class="w"> </span><span class="n">x</span><span class="p">))</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">try-step</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">1</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">loop-inner</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">xnew</span><span class="w"> </span><span class="p">(</span><span class="n">try-step</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="n">ynew</span><span class="w"> </span><span class="p">(</span><span class="n">try-step</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="mi">2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="n">ynew</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="n">xnew</span><span class="p">))</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">            </span><span class="p">((</span><span class="nb">eq?</span><span class="w"> </span><span class="n">xnew</span><span class="w"> </span><span class="n">ynew</span><span class="p">)</span><span class="w"> </span><span class="no">#t</span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">loop-inner</span><span class="w"> </span><span class="n">xnew</span><span class="w"> </span><span class="n">ynew</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">loop-inner</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">list1</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="p">))</span>
<span class="p">(</span><span class="n">contains-loop?</span><span class="w"> </span><span class="n">list1</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">list2</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="p">))</span>
<span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="n">list2</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">list2</span><span class="p">))</span>
<span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="n">list2</span><span class="w"> </span><span class="p">(</span><span class="nb">cddr</span><span class="w"> </span><span class="n">list2</span><span class="p">))</span>
<span class="p">(</span><span class="n">contains-loop?</span><span class="w"> </span><span class="n">list2</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">list3</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="p">))</span>
<span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">list3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cddr</span><span class="w"> </span><span class="n">list3</span><span class="p">))</span>
<span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="n">list3</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">list3</span><span class="p">))</span>
<span class="p">(</span><span class="n">contains-loop?</span><span class="w"> </span><span class="n">list3</span><span class="p">)</span>

<span class="c1">;; No more infinite looping!</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">list4</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="p">))</span>
<span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="p">(</span><span class="nb">cddr</span><span class="w"> </span><span class="n">list4</span><span class="p">)</span><span class="w"> </span><span class="n">list4</span><span class="p">)</span>
<span class="p">(</span><span class="n">contains-loop?</span><span class="w"> </span><span class="n">list4</span><span class="p">)</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>#f
#f
#f
#t
</pre>
</div>
</div>

<p>The idea here is to use two "racers", racer x takes one step every turn, 
racer y takes two steps. If racer y ever passes racer x, there's a loop. </p>
<h4 id="exercise-320">Exercise 3.20</h4>
<p>Draw environment diagrams to
illustrate the evaluation of the sequence of expressions</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>

<span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">17</span><span class="p">)</span>

<span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="mi">17</span>
</code></pre></div>

<p>using the procedural implementation of pairs given above.  (Compare
Exercise 3.11.)</p>
<h5>Solution</h5>
<div style="text-align: center; margin: 20px 0;">
  <img src="img/ex3-20.svg" style="width: 70%; max-width: 800px;" alt="A box-and-pointer diagram, what do you want?">
</div>

<p>Here's an incomplete answer to the question based on just some of the diagrams that I could have written.</p>
<p>The blue E1 and E2 are created by the calls to cons. </p>
<p>The red environments are created by <code>set-car!</code>, <code>dispatch</code> and cons's version of 
<code>set-x!</code>. I ignore the small environments created by calling <code>(car z)</code>, which would involve another call to <code>dispatch</code>. </p>
<h4 id="exercise-321">Exercise 3.21</h4>
<p>Ben Bitdiddle decides to test the
queue implementation described above.  He types in the procedures to the Lisp
interpreter and proceeds to try them out:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">q1</span><span class="w"> </span><span class="p">(</span><span class="n">make-queue</span><span class="p">))</span>

<span class="p">(</span><span class="n">insert-queue!</span><span class="w"> </span><span class="n">q1</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="p">)</span>
<span class="p">((</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>

<span class="p">(</span><span class="n">insert-queue!</span><span class="w"> </span><span class="n">q1</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">b</span><span class="p">)</span>
<span class="p">((</span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>

<span class="p">(</span><span class="n">delete-queue!</span><span class="w"> </span><span class="n">q1</span><span class="p">)</span>
<span class="p">((</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>

<span class="p">(</span><span class="n">delete-queue!</span><span class="w"> </span><span class="n">q1</span><span class="p">)</span>
<span class="p">(()</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
</code></pre></div>

<p>"It's all wrong!" he complains.  "The interpreter's response shows that the
last item is inserted into the queue twice.  And when I delete both items, the
second <code>b</code> is still there, so the queue isn't empty, even though it's
supposed to be."  Eva Lu Ator suggests that Ben has misunderstood what is
happening. "It's not that the items are going into the queue twice," she
explains.  "It's just that the standard Lisp printer doesn't know how to make
sense of the queue representation. If you want to see the queue printed
correctly, you'll have to define your own print procedure for queues." Explain
what Eva Lu is talking about.  In particular, show why Ben's examples produce
the printed results that they do.  Define a procedure <code>print-queue</code> that
takes a queue as input and prints the sequence of items in the queue.</p>
<h5>Solution</h5>
<div class="code-box">
<div class="code-header"><a href="code/ex3-21.rkt">code/ex3-21.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">front-ptr</span><span class="w"> </span><span class="n">queue</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">queue</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">rear-ptr</span><span class="w"> </span><span class="n">queue</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">queue</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">set-front-ptr!</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="n">item</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="n">item</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">set-rear-ptr!</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="n">item</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="n">item</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">empty-queue?</span><span class="w"> </span><span class="n">queue</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="p">(</span><span class="n">front-ptr</span><span class="w"> </span><span class="n">queue</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-queue</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">front-queue</span><span class="w"> </span><span class="n">queue</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-queue?</span><span class="w"> </span><span class="n">queue</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;FRONT called with an</span>
<span class="s2">              empty queue&quot;</span><span class="w"> </span><span class="n">queue</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="p">(</span><span class="n">front-ptr</span><span class="w"> </span><span class="n">queue</span><span class="p">))))</span>


<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">insert-queue!</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="n">item</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">new-pair</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())))</span>
<span class="w">    </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="n">empty-queue?</span><span class="w"> </span><span class="n">queue</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="n">set-front-ptr!</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="n">new-pair</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="n">set-rear-ptr!</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="n">new-pair</span><span class="p">)</span>
<span class="w">           </span><span class="n">queue</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="p">(</span><span class="n">rear-ptr</span><span class="w"> </span><span class="n">queue</span><span class="p">)</span><span class="w"> </span>
<span class="w">                          </span><span class="n">new-pair</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="n">set-rear-ptr!</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="n">new-pair</span><span class="p">)</span>
<span class="w">                </span><span class="n">queue</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">delete-queue!</span><span class="w"> </span><span class="n">queue</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="n">empty-queue?</span><span class="w"> </span><span class="n">queue</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;DELETE! called with </span>
<span class="s2">                 an empty queue&quot;</span><span class="w"> </span><span class="n">queue</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">set-front-ptr!</span><span class="w"> </span>
<span class="w">               </span><span class="n">queue</span><span class="w"> </span>
<span class="w">               </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="p">(</span><span class="n">front-ptr</span><span class="w"> </span><span class="n">queue</span><span class="p">)))</span>
<span class="w">              </span><span class="n">queue</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">print-queue</span><span class="w"> </span><span class="n">queue</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">front-ptr</span><span class="w"> </span><span class="n">queue</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">q1</span><span class="w"> </span><span class="p">(</span><span class="n">make-queue</span><span class="p">))</span>

<span class="p">(</span><span class="n">insert-queue!</span><span class="w"> </span><span class="n">q1</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="p">)</span>
<span class="c1">;; ((a) a)</span>
<span class="p">(</span><span class="n">print-queue</span><span class="w"> </span><span class="n">q1</span><span class="p">)(</span><span class="nb">newline</span><span class="p">)</span>
<span class="c1">;; (a)</span>

<span class="p">(</span><span class="n">insert-queue!</span><span class="w"> </span><span class="n">q1</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">b</span><span class="p">)</span>
<span class="c1">;; ((a b) b)</span>
<span class="p">(</span><span class="n">print-queue</span><span class="w"> </span><span class="n">q1</span><span class="p">)(</span><span class="nb">newline</span><span class="p">)</span>
<span class="c1">;; (a )</span>

<span class="p">(</span><span class="n">delete-queue!</span><span class="w"> </span><span class="n">q1</span><span class="p">)</span>
<span class="c1">;; ((b) b)</span>
<span class="p">(</span><span class="n">print-queue</span><span class="w"> </span><span class="n">q1</span><span class="p">)(</span><span class="nb">newline</span><span class="p">)</span>
<span class="c1">;; (b)</span>

<span class="p">(</span><span class="n">delete-queue!</span><span class="w"> </span><span class="n">q1</span><span class="p">)</span>
<span class="c1">;; (() b)</span>
<span class="p">(</span><span class="n">print-queue</span><span class="w"> </span><span class="n">q1</span><span class="p">)(</span><span class="nb">newline</span><span class="p">)</span>
<span class="c1">;; ()</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>((a) a)
(a)

((a b) b)
(a b)

((b) b)
(b)

(() b)
()

</pre>
</div>
</div>

<h4 id="exercise-322">Exercise 3.22</h4>
<p>Instead of representing a queue
as a pair of pointers, we can build a queue as a procedure with local state.
The local state will consist of pointers to the beginning and the end of an
ordinary list.  Thus, the <code>make-queue</code> procedure will have the form</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-queue</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">front-ptr</span><span class="w"> </span><span class="n">…</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="n">rear-ptr</span><span class="w"> </span><span class="n">…</span><span class="w"> </span><span class="p">))</span>
<span class="w">    </span><span class="n">⟨@var</span><span class="p">{</span><span class="n">definitions</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">internal</span><span class="w"> </span><span class="n">procedures</span><span class="p">}</span><span class="n">⟩</span>
<span class="w">    </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">dispatch</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="n">…</span><span class="p">)</span>
<span class="w">    </span><span class="n">dispatch</span><span class="p">))</span>
</code></pre></div>

<p>Complete the definition of <code>make-queue</code> and provide implementations of the
queue operations using this representation.</p>
<h5>Solution</h5>
<div class="code-box">
<div class="code-header"><a href="code/ex3-22.rkt">code/ex3-22.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-queue</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">front-ptr</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>
<span class="w">        </span><span class="p">(</span><span class="n">rear-ptr</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()))</span>

<span class="w">    </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">set-front-ptr!</span><span class="w"> </span><span class="n">item</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="p">(</span><span class="k">set!</span><span class="w"> </span><span class="n">front-ptr</span><span class="w"> </span><span class="n">item</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">set-rear-ptr!</span><span class="w"> </span><span class="n">item</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="p">(</span><span class="k">set!</span><span class="w"> </span><span class="n">rear-ptr</span><span class="w"> </span><span class="n">item</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">empty-queue?</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">front-ptr</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">front-queue</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-queue?</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;FRONT called with an</span>
<span class="s2">               empty queue&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">front-ptr</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">insert-queue!</span><span class="w"> </span><span class="n">item</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">new-pair</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())))</span>
<span class="w">        </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="n">empty-queue?</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="n">set-front-ptr!</span><span class="w"> </span><span class="n">new-pair</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="n">set-rear-ptr!</span><span class="w"> </span><span class="n">new-pair</span><span class="p">)</span>
<span class="w">               </span><span class="n">dispatch</span><span class="p">)</span><span class="w"> </span><span class="c1">;; Instead of queue, we return dispatch</span>
<span class="w">                         </span><span class="c1">;; I&#39;m using this analogous to C++ &quot;this&quot; </span>
<span class="w">          </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="n">rear-ptr</span><span class="w"> </span>
<span class="w">                          </span><span class="n">new-pair</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="n">set-rear-ptr!</span><span class="w"> </span><span class="n">new-pair</span><span class="p">)</span>
<span class="w">                </span><span class="n">dispatch</span><span class="p">))))</span>
<span class="w">    </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">delete-queue!</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="n">empty-queue?</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;DELETE! called with </span>
<span class="s2">                    an empty queue&quot;</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">set-front-ptr!</span><span class="w"> </span>
<span class="w">                            </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">front-ptr</span><span class="p">))))</span>
<span class="w">      </span><span class="n">dispatch</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">print-queue</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="n">front-ptr</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">dispatch</span><span class="w"> </span><span class="n">m</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">eq?</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">set-front-ptr!</span><span class="p">)</span><span class="w"> </span><span class="n">set-front-ptr!</span><span class="p">)</span>
<span class="w">            </span><span class="p">((</span><span class="nb">eq?</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">set-rear-ptr!</span><span class="p">)</span><span class="w"> </span><span class="n">set-rear-ptr!</span><span class="p">)</span>
<span class="w">            </span><span class="p">((</span><span class="nb">eq?</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">empty-queue?</span><span class="p">)</span><span class="w"> </span><span class="n">empty-queue?</span><span class="p">)</span>
<span class="w">            </span><span class="p">((</span><span class="nb">eq?</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">front-queue</span><span class="p">)</span><span class="w"> </span><span class="n">front-queue</span><span class="p">)</span>
<span class="w">            </span><span class="p">((</span><span class="nb">eq?</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">insert-queue!</span><span class="p">)</span><span class="w"> </span><span class="n">insert-queue!</span><span class="p">)</span>
<span class="w">            </span><span class="p">((</span><span class="nb">eq?</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">delete-queue!</span><span class="p">)</span><span class="w"> </span><span class="n">delete-queue!</span><span class="p">)</span>
<span class="w">            </span><span class="p">((</span><span class="nb">eq?</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">print-queue</span><span class="p">)</span><span class="w"> </span><span class="n">print-queue</span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;DELETE! called with </span>
<span class="s2">                    an empty queue&quot;</span><span class="p">))))</span>
<span class="w">    </span><span class="n">dispatch</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">set-front-ptr!</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="n">item</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="p">((</span><span class="n">q</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">set-front-ptr!</span><span class="p">)</span><span class="w"> </span><span class="n">item</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">set-rear-ptr!</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="n">item</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">q</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">set-rear-ptr!</span><span class="p">)</span><span class="w"> </span><span class="n">item</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">empty-queue?</span><span class="w"> </span><span class="n">q</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">q</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">empty-queue?</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">front-queue</span><span class="w"> </span><span class="n">q</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">q</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">front-queue</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">insert-queue!</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="n">item</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">q</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">insert-queue!</span><span class="p">)</span><span class="w"> </span><span class="n">item</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">delete-queue!</span><span class="w"> </span><span class="n">q</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">q</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">delete-queue!</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">print-queue</span><span class="w"> </span><span class="n">q</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">q</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">print-queue</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">q1</span><span class="w"> </span><span class="p">(</span><span class="n">make-queue</span><span class="p">))</span>
<span class="p">(</span><span class="n">print-queue</span><span class="w"> </span><span class="p">(</span><span class="n">insert-queue!</span><span class="w"> </span><span class="n">q1</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="p">))</span>
<span class="p">(</span><span class="n">print-queue</span><span class="w"> </span><span class="p">(</span><span class="n">insert-queue!</span><span class="w"> </span><span class="n">q1</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">b</span><span class="p">))</span>
<span class="p">(</span><span class="n">print-queue</span><span class="w"> </span><span class="p">(</span><span class="n">delete-queue!</span><span class="w"> </span><span class="n">q1</span><span class="p">))</span>
<span class="p">(</span><span class="n">print-queue</span><span class="w"> </span><span class="p">(</span><span class="n">delete-queue!</span><span class="w"> </span><span class="n">q1</span><span class="p">))</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>(a)
(a b)
(b)
()
</pre>
</div>
</div>

<h4 id="exercise-323">Exercise 3.23</h4>
<p>A deque (<code>double-ended queue</code>) is a sequence in which items can be inserted and deleted at either the
front or the rear.  Operations on deques are the constructor <code>make-deque</code>,
the predicate <code>empty-deque?</code>, selectors <code>front-deque</code> and
<code>rear-deque</code>, and mutators <code>front-insert-deque!</code>,
<code>rear-insert-deque!</code>, <code>front-delete-deque!</code>, 
<code>rear-delete-deque!</code>.  Show how to represent deques using pairs, and give
implementations of the operations.<br />
All operations should be accomplished in ${\Theta(1)$} steps.</p>
<h5>Solution</h5>
<h4 id="exercise-324">Exercise 3.24</h4>
<p>In the table implementations
above, the keys are tested for equality using <code>equal?</code> (called by
<code>assoc</code>).  This is not always the appropriate test.  For instance, we
might have a table with numeric keys in which we don't need an exact match to
the number we're looking up, but only a number within some tolerance of it.
Design a table constructor <code>make-table</code> that takes as an argument a
<code>same-key?</code> procedure that will be used to test <code>`equality'' of keys.</code>Make-table<code>should return a</code>dispatch<code>procedure that can be used to
access appropriate</code>lookup<code>and</code>insert!` procedures for a local
table.</p>
<h5>Solution</h5>
<h4 id="exercise-325">Exercise 3.25</h4>
<p>Generalizing one- and
two-dimensional tables, show how to implement a table in which values are
stored under an arbitrary number of keys and different values may be stored
under different numbers of keys.  The <code>lookup</code> and <code>insert!</code>
procedures should take as input a list of keys used to access the table.</p>
<h5>Solution</h5>
<h4 id="exercise-326">Exercise 3.26</h4>
<p>To search a table as implemented
above, one needs to scan through the list of records.  This is basically the
unordered list representation of 2.3.3.  For large tables, it may
be more efficient to structure the table in a different manner.  Describe a
table implementation where the (key, value) records are organized using a
binary tree, assuming that keys can be ordered in some way (e.g., numerically
or alphabetically).  (Compare Exercise 2.66 of Chapter 2.)</p>
<h5>Solution</h5>
<h4 id="exercise-327">Exercise 3.27</h4>
<p>Memoization (also
called tabulation) is a technique that enables a procedure to record,
in a local table, values that have previously been computed.  This technique
can make a vast difference in the performance of a program.  A memoized
procedure maintains a table in which values of previous calls are stored using
as keys the arguments that produced the values.  When the memoized procedure is
asked to compute a value, it first checks the table to see if the value is
already there and, if so, just returns that value.  Otherwise, it computes the
new value in the ordinary way and stores this in the table.  As an example of
memoization, recall from 1.2.2 the exponential process for
computing Fibonacci numbers:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">fib</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">fib</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="n">fib</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">2</span><span class="p">))))))</span>
</code></pre></div>

<p>The memoized version of the same procedure is</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">memo-fib</span>
<span class="w">  </span><span class="p">(</span><span class="n">memoize</span><span class="w"> </span>
<span class="w">   </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="w">     </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">           </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="k">else</span><span class="w"> </span>
<span class="w">            </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">memo-fib</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">               </span><span class="p">(</span><span class="n">memo-fib</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">2</span><span class="p">))))))))</span>
</code></pre></div>

<p>where the memoizer is defined as</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">memoize</span><span class="w"> </span><span class="n">f</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">table</span><span class="w"> </span><span class="p">(</span><span class="n">make-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">previously-computed-result</span><span class="w"> </span>
<span class="w">             </span><span class="p">(</span><span class="n">lookup</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">table</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="k">or</span><span class="w"> </span><span class="n">previously-computed-result</span>
<span class="w">            </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">result</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="n">insert!</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="n">table</span><span class="p">)</span>
<span class="w">              </span><span class="n">result</span><span class="p">))))))</span>
</code></pre></div>

<p>Draw an environment diagram to analyze the computation of <code>(memo-fib 3)</code>.
Explain why <code>memo-fib</code> computes the $n^{\text{th}}$ Fibonacci number in a number
of steps proportional to $n$.  Would the scheme still work if we had simply
defined <code>memo-fib</code> to be <code>(memoize fib)</code>?</p>
<h5>Solution</h5>
<h4 id="exercise-328">Exercise 3.28</h4>
<p>Define an or-gate as a primitive
function box.  Your <code>or-gate</code> constructor should be similar to
<code>and-gate</code>.</p>
<h5>Solution</h5>
<h4 id="exercise-329">Exercise 3.29</h4>
<p>Another way to construct an
or-gate is as a compound digital logic device, built from and-gates and
inverters.  Define a procedure <code>or-gate</code> that accomplishes this.  What is
the delay time of the or-gate in terms of <code>and-gate-delay</code> and
<code>inverter-delay</code>?</p>
<h5>Solution</h5>
<h4 id="exercise-330">Exercise 3.30</h4>
<p>Figure 3.27 shows a
ripple-carry adder formed by stringing together $n$ full-adders.
This is the simplest form of parallel adder for adding two $n$-bit binary
numbers.  The inputs $A_1$, $A_2$, $A_3$, @dots{}, $A_n$ and 
$B_1$, $B_2$, $B_3$,
@dots{}, $B_n$ are the two binary numbers to be added (each $A_k$ and
$B_k$ is a 0 or a 1).  The circuit generates $S_1$, $S_2$, 
$S_3$, @dots{}, $S_n$,
the $n$ bits of the sum, and $C$, the carry from the addition.  Write a
procedure <code>ripple-carry-adder</code> that generates this circuit.  The procedure
should take as arguments three lists of $n$ wires each---the $A_k$, the
$B_k$, and the $S_k$---and also another wire $C$.  The major drawback of the
ripple-carry adder is the need to wait for the carry signals to propagate.
What is the delay needed to obtain the complete output from an $n$-bit
ripple-carry adder, expressed in terms of the delays for and-gates, or-gates,
and inverters?</p>
<h5>Solution</h5>
<h4 id="exercise-331">Exercise 3.31</h4>
<p>The internal procedure
<code>accept-action-procedure!</code> defined in <code>make-wire</code> specifies that when
a new action procedure is added to a wire, the procedure is immediately run.
Explain why this initialization is necessary.  In particular, trace through the
half-adder example in the paragraphs above and say how the system's response
would differ if we had defined <code>accept-action-procedure!</code> as</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">accept-action-procedure!</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">set!</span><span class="w"> </span><span class="n">action-procedures</span><span class="w"> </span>
<span class="w">        </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="n">action-procedures</span><span class="p">)))</span>
</code></pre></div>

<h5>Solution</h5>
<h4 id="exercise-332">Exercise 3.32</h4>
<p>The procedures to be run during
each time segment of the agenda are kept in a queue.  Thus, the procedures for
each segment are called in the order in which they were added to the agenda
(first in, first out).  Explain why this order must be used.  In particular,
trace the behavior of an and-gate whose inputs change from 0, 1 to 1, 0 in the
same segment and say how the behavior would differ if we stored a segment's
procedures in an ordinary list, adding and removing procedures only at the
front (last in, first out).</p>
<h5>Solution</h5>
<h4 id="exercise-333">Exercise 3.33</h4>
<p>Using primitive multiplier,
adder, and constant constraints, define a procedure <code>averager</code> that takes
three connectors <code>a</code>, <code>b</code>, and <code>c</code> as inputs and establishes the
constraint that the value of <code>c</code> is the average of the values of <code>a</code>
and <code>b</code>.</p>
<h5>Solution</h5>
<h4 id="exercise-334">Exercise 3.34</h4>
<p>Louis Reasoner wants to build a
squarer, a constraint device with two terminals such that the value of
connector <code>b</code> on the second terminal will always be the square of the
value <code>a</code> on the first terminal.  He proposes the following simple device
made from a multiplier:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">squarer</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">multiplier</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
</code></pre></div>

<p>There is a serious flaw in this idea.  Explain.</p>
<h5>Solution</h5>
<h4 id="exercise-335">Exercise 3.35</h4>
<p>Ben Bitdiddle tells Louis that
one way to avoid the trouble in Exercise 3.34 is to define a squarer as a
new primitive constraint.  Fill in the missing portions in Ben's outline for a
procedure to implement such a constraint:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">squarer</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">process-new-value</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">has-value?</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">get-value</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;square less than 0: </span>
<span class="s2">                    SQUARER&quot;</span><span class="w"> </span>
<span class="w">                   </span><span class="p">(</span><span class="n">get-value</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="w">            </span><span class="n">⟨@var</span><span class="p">{</span><span class="n">alternative1</span><span class="p">}</span><span class="n">⟩</span><span class="p">)</span>
<span class="w">        </span><span class="n">⟨@var</span><span class="p">{</span><span class="n">alternative2</span><span class="p">}</span><span class="n">⟩</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">process-forget-value</span><span class="p">)</span><span class="w"> </span><span class="n">⟨@var</span><span class="p">{</span><span class="n">body1</span><span class="p">}</span><span class="n">⟩</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">me</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="n">⟨@var</span><span class="p">{</span><span class="n">body2</span><span class="p">}</span><span class="n">⟩</span><span class="p">)</span>
<span class="w">  </span><span class="n">⟨@var</span><span class="p">{</span><span class="nb">rest</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">definition</span><span class="p">}</span><span class="n">⟩</span>
<span class="w">  </span><span class="n">me</span><span class="p">)</span>
</code></pre></div>

<h5>Solution</h5>
<h4 id="exercise-336">Exercise 3.36</h4>
<p>Suppose we evaluate the following
sequence of expressions in the global environment:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">(</span><span class="n">make-connector</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">(</span><span class="n">make-connector</span><span class="p">))</span>
<span class="p">(</span><span class="n">set-value!</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">user</span><span class="p">)</span>
</code></pre></div>

<p>At some time during evaluation of the <code>set-value!</code>, the following
expression from the connector's local procedure is evaluated:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="n">for-each-except</span><span class="w"> </span>
<span class="w">  </span><span class="n">setter</span><span class="w"> </span><span class="n">inform-about-value</span><span class="w"> </span><span class="n">constraints</span><span class="p">)</span>
</code></pre></div>

<p>Draw an environment diagram showing the environment in which the above
expression is evaluated.</p>
<h5>Solution</h5>
<h4 id="exercise-337">Exercise 3.37</h4>
<p>The
<code>celsius-fahrenheit-converter</code> procedure is cumbersome when compared with
a more expression-oriented style of definition, such as</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">celsius-fahrenheit-converter</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">c+</span><span class="w"> </span><span class="p">(</span><span class="n">c*</span><span class="w"> </span><span class="p">(</span><span class="n">c/</span><span class="w"> </span><span class="p">(</span><span class="n">cv</span><span class="w"> </span><span class="mi">9</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">cv</span><span class="w"> </span><span class="mi">5</span><span class="p">))</span>
<span class="w">          </span><span class="n">x</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">cv</span><span class="w"> </span><span class="mi">32</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="p">(</span><span class="n">make-connector</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="p">(</span><span class="n">celsius-fahrenheit-converter</span><span class="w"> </span><span class="n">C</span><span class="p">))</span>
</code></pre></div>

<p>Here <code>c+</code>, <code>c*</code>, etc. are the <code>`constraint'' versions of the
arithmetic operations.  For example,</code>c+` takes two connectors as
arguments and returns a connector that is related to these by an adder
constraint:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">c+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">z</span><span class="w"> </span><span class="p">(</span><span class="n">make-connector</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="n">adder</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="n">z</span><span class="p">))</span>
</code></pre></div>

<p>Define analogous procedures <code>c-</code>, <code>c*</code>, <code>c/</code>, and <code>cv</code>
(constant value) that enable us to define compound constraints as in the
converter example above.</p>
<h5>Solution</h5>
    </div>
</body>
</html>
