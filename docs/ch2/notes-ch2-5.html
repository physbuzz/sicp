<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>notes-ch2-5.md</title>
    <!-- MathJax for LaTeX support -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']]
            }
        };
    </script>
    <style>
        /* Pygments Syntax Highlighting */
        pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.codehilite .hll { background-color: #ffffcc }
.codehilite { background: #f8f8f8; }
.codehilite .c { color: #3D7B7B; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #FF0000 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666666 } /* Operator */
.codehilite .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #9C6500 } /* Comment.Preproc */
.codehilite .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.codehilite .gr { color: #E40000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #008400 } /* Generic.Inserted */
.codehilite .go { color: #717171 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #0044DD } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #687822 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.codehilite .no { color: #880000 } /* Name.Constant */
.codehilite .nd { color: #AA22FF } /* Name.Decorator */
.codehilite .ni { color: #717171; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #0000FF } /* Name.Function */
.codehilite .nl { color: #767600 } /* Name.Label */
.codehilite .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #bbbbbb } /* Text.Whitespace */
.codehilite .mb { color: #666666 } /* Literal.Number.Bin */
.codehilite .mf { color: #666666 } /* Literal.Number.Float */
.codehilite .mh { color: #666666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666666 } /* Literal.Number.Oct */
.codehilite .sa { color: #BA2121 } /* Literal.String.Affix */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .dl { color: #BA2121 } /* Literal.String.Delimiter */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #A45A77 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .fm { color: #0000FF } /* Name.Function.Magic */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .vm { color: #19177C } /* Name.Variable.Magic */
.codehilite .il { color: #666666 } /* Literal.Number.Integer.Long */

        /* Base CSS from markdown_styles.py */
        
        /* Basic reset and fonts */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            padding: 0;
            background-color: #f8f9fa;
        }

        /* Navigation styling */
        .nav {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            padding-bottom: 0.8rem;
            border-bottom: 1px solid #e1e4e8;
        }

        .nav span {
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .nav .activenav {
            background-color: #f1f8ff;
        }

        .nav .activenav a {
            color: #0366d6;
            text-decoration: none;
        }

        .nav .activenav a:hover {
            text-decoration: underline;
        }

        .nav .inactivenav {
            color: #959da5;
            background-color: #f6f8fa;
        }

        /* Center column layout */
        .container {
            max-width: 800px;
            margin: 2rem auto;
            background-color: white;
            padding: 2rem 3rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Typography */
        h1 {
            font-size: 2.2rem;
            margin-bottom: 1.5rem;
            color: #2c3e50;
            border-bottom: 2px solid #eee;
            padding-bottom: 0.5rem;
        }

        h2 {
            font-size: 1.8rem;
            margin: 2rem 0 1rem;
            color: #34495e;
        }

        h3 {
            font-size: 1.5rem;
            margin: 1.8rem 0 1rem;
            color: #34495e;
        }

        h4 {
            font-size: 1.3rem;
            margin: 1.5rem 0 0.8rem;
            color: #34495e;
        }

        h5 {
            font-size: 1.1rem;
            margin: 1.2rem 0 0.8rem;
            color: #34495e;
        }

        /* Table of Contents styling */
        .table-of-contents {
            margin: 0 0 0;
            line-height: 1;
        }

        .toc-list {
            margin: 0;
            padding-left: 20px;
        }

        .toc-list li {
            margin-bottom: 2px;
        }
        .toc-list ul {
            margin-bottom: 2px;
        }

        .exercise-list {
            margin: 0;
            padding-left: 0;
            font-size: 0.95em;
            display: inline;
        }

        .exercise-container {
            display: inline-block;
            margin-top: 2px;
            line-height: 1.2;
        }

        .toc-exercises {
            font-style: italic;
            color: #555;
        }

        .exercise-list a {
            text-decoration: none;
            color: #2070b0;
            margin-right: 0;
        }

        .exercise-list a:hover {
            text-decoration: underline;
        }

        .exercise-list span:not(:last-child):after {
            content: ", ";
            color: #777;
            margin-right: 0;
        }

        /* Blockquote styling */
        blockquote {
            border-left: 4px solid #dfe2e5;
            color: #6a737d;
            padding: 0 1rem;
            margin: 1rem 0 1.5rem;
            background-color: #f6f8fa;
            border-radius: 0 3px 3px 0;
        }

        blockquote p {
            padding: 0.8rem 0;
        }

        blockquote p:first-child {
            margin-top: 0;
        }

        blockquote p:last-child {
            margin-bottom: 0;
        }

        /* Solution styling */
        h5:has(+p:contains("Solution")) {
            margin-bottom: 0;
        }

        h5:has(+p:contains("Solution")) + p {
            font-weight: bold;
            color: #3c8dbc;
            border-left: 3px solid #3c8dbc;
            padding-left: 0.8rem;
            margin: 0.5rem 0 1rem;
        }

        p {
            margin-bottom: 1rem;
        }

        /* List styling */
        ul, ol {
            margin-bottom: 1rem;
            padding-left: 2.5rem;
        }

        ul li, ol li {
            margin-bottom: 0.5rem;
        }

        /* Code blocks */
        .code-box {
            background-color: #f6f8fa;
            border-radius: 6px;
            overflow: hidden;
            margin: 1rem 0 1.5rem;
            border: 1px solid #e1e4e8;
        }

        .code-header {
            font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.75rem;
            color: #6a737d;
            padding: 0.3rem 0 0rem 0.3rem;
            border-bottom: 1px solid #e1e4e8;
            background-color: #fafbfc;
        }

        .code-header a {
            color: #6a737d;
            text-decoration: none;
        }

        .code-header a:hover {
            text-decoration: underline;
            color: #0366d6;
        }

        /* Standalone code blocks (triple backticks) */
        .codehilite {
            background-color: #f6f8fa;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1rem 0 1.5rem;
            border: 1px solid #e1e4e8;
        }

        /* When inside a code-box, remove default styling */
        .code-box .codehilite {
            margin: 0;
            padding: 0;
            border: none;
            border-radius: 0;
        }

        /* Adjust padding for code blocks inside code-box */
        .code-box .codehilite pre {
            padding: 0.2rem 0 0.3rem 0.3rem;
            overflow-x: auto;
            margin: 0;
        }

        /* Normal padding for standalone code blocks */
        .codehilite pre {
            padding: 1rem;
            overflow-x: auto;
            margin: 0;
        }

        .code-output {
            font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.75rem;
            color: #6a737d;
            padding: 0.2rem 0 0.3rem 0.3rem;
            border-top: 1px solid #e1e4e8;
            background-color: #fafbfc;
        }
        .code-output span {
            color: #de37cc;
        }

        .code-output pre {
            margin: 0;
            white-space: pre-wrap;
            font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
        }
        /* --- Styles for Collapsible Code Blocks --- */
        .collapsible-code {
            border: none; /* Remove default border from details */
            margin-top: 0; /* Adjust spacing if needed */
            margin-bottom: 0; /* Adjust spacing if needed */
        }

        .code-summary {
            font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.75rem;
            color: #6a737d;
            padding: 0.5rem 0.8rem; /* Adjusted padding */
            border-bottom: 1px solid #e1e4e8;
            background-color: #fafbfc;
            cursor: pointer;
            list-style: none; /* Hide default marker */
            display: block; /* Make it block level */
            border-radius: 6px 6px 0 0; /* Round top corners like header */
            position: relative; /* For positioning the marker */
            transition: background-color 0.1s ease-in-out;
        }

        .code-summary:hover {
            background-color: #f1f3f5; /* Slight hover effect */
        }

        /* Add custom marker */
        .code-summary::before {
            content: '►'; /* Collapsed marker */
            position: absolute;
            left: 0.8rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.6em;
            color: #6a737d;
            margin-right: 0.5rem;
            transition: transform 0.2s ease-in-out;
        }

        .collapsible-code[open] > .code-summary::before {
            transform: translateY(-50%) rotate(90deg); /* Expanded marker */
        }

        .collapsible-code[open] > .code-summary {
             border-bottom: 1px solid #e1e4e8; /* Ensure border shows when open */
             border-radius: 6px 6px 0 0; /* Keep top rounding when open */
        }

        /* Adjust summary content positioning relative to marker */
        .code-summary a {
            margin-left: 1.2rem; /* Space for the marker */
            color: #6a737d;
            text-decoration: none;
        }
        .code-summary a:hover {
            text-decoration: underline;
            color: #0366d6;
        }

        /* New style for the expand hint */
        .expand-hint {
            font-style: italic;
            font-size: 0.85em;
            color: #888;
            margin-left: 0.5rem;
        }

        /* Ensure content inside details has appropriate spacing/styling */
        .collapsible-code > .codehilite {
            margin: 0;
            border-radius: 0 0 6px 6px; /* Round bottom corners */
            border: none; /* Remove border from codehilite itself */
            border-top: none; /* Remove top border */
        }

        /* Since code output is now outside the details element,
           we need to adjust its styling */
        .collapsible-code + .code-output {
            border-radius: 0 0 6px 6px; /* Round bottom corners */
            margin-top: 0; /* Remove gap */
            border-top: 1px solid #e1e4e8;
        }

        /* Ensure code output has proper border when outside details */
        .code-box > .code-output {
            border-top: 1px solid #e1e4e8;
        }

        .collapsible-code > .run-racket {
             margin-left: 1rem; /* Indent run button */
             margin-bottom: 1rem; /* Add bottom margin */
        }
        /* --- End Collapsible Styles --- */

        code {
            font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.9em;
            padding: 0.2em 0.4em;
            background-color: #f6f8fa;
            border-radius: 3px;
        }

        .codehilite code {
            padding: 0;
            background-color: transparent;
        }

        /* Links */
        a {
            color: #0366d6;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        /* Run button */
        .run-racket {
            display: inline-block;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.4rem 0.8rem;
            background-color: #3c8dbc;
            color: white;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .run-racket:hover {
            background-color: #367fa9;
            text-decoration: none;
        }

        /* Make LaTeX display nicely */
        .MathJax {
            overflow-x: auto;
            overflow-y: hidden;
        }
    
    </style>
</head>
<body>
    <div class="container">
        <div class="nav">
    <span class="activenav"><a href="notes-ch2-4.html">← Previous</a></span>
    <span class="activenav"><a href="../index.html">↑ Up</a></span>
    <span class="inactivenav">Next →</span>
    <!--<span class="activenav"><a href="notes-ch2-5.html">Next →</a></span>-->
</div>

<p><a href="https://sarabander.github.io/sicp/html/2_002e5.xhtml#g_t2_002e5">HTML Book Chapter 2.5 Link</a></p>
<p><div class="table-of-contents">
<h2>Directory</h2>
<ul class="toc-list">
<ul>
<li><a href="#section-25">Section 2.5</a></li>
<ul>
<li><a href="#meeting-05-04-2025">Meeting 05-04-2025</a></li>
<ul>
<li><a href="#relevant-wiki-pages">Relevant Wiki Pages:</a></li>
<li><a href="#info-about-julia">Info about Julia:</a></li>
</ul>
<li><a href="#goofiness">Goofiness</a></li>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#exercises" class="toc-exercises">Exercises</a>
<div class="exercise-container">(
<span class="exercise-list">
<span><a href="#exercise-277">Exercise 2.77</a></span>
<span><a href="#exercise-278">Exercise 2.78</a></span>
<span><a href="#exercise-279">Exercise 2.79</a></span>
<span><a href="#exercise-280">Exercise 2.80</a></span>
<span><a href="#exercise-281">Exercise 2.81</a></span>
<span><a href="#exercise-282">Exercise 2.82</a></span>
<span><a href="#exercise-283">Exercise 2.83</a></span>
<span><a href="#exercise-284">Exercise 2.84</a></span>
<span><a href="#exercise-285">Exercise 2.85</a></span>
<span><a href="#exercise-286">Exercise 2.86</a></span>
<span><a href="#exercise-287">Exercise 2.87</a></span>
<span><a href="#exercise-288">Exercise 2.88</a></span>
<span><a href="#exercise-289">Exercise 2.89</a></span>
<span><a href="#exercise-290">Exercise 2.90</a></span>
<span><a href="#exercise-291">Exercise 2.91</a></span>
<span><a href="#exercise-292">Exercise 2.92</a></span>
<span><a href="#exercise-293">Exercise 2.93</a></span>
<span><a href="#exercise-294">Exercise 2.94</a></span>
<span><a href="#exercise-295">Exercise 2.95</a></span>
<span><a href="#exercise-296">Exercise 2.96</a></span>
<span><a href="#exercise-297">Exercise 2.97</a></span>
</span>)
</div></li>
</ul>
</ul>
</ul>
</div></p>
<h2 id="section-25">Section 2.5</h2>
<p>Note: At the end it looks like we talk about polynomials, it might be worth skimming over some simple algorithms from Ideals, Varieties, and Algorithms and maybe implementing a simple one. </p>
<p>Note: Lagrange interpolating polynomials are cool. <a href="https://en.wikipedia.org/wiki/Lagrange_polynomial">https://en.wikipedia.org/wiki/Lagrange_polynomial</a></p>
<p>TODO: Skip 86</p>
<h3 id="meeting-05-04-2025">Meeting 05-04-2025</h3>
<p>https://sarabander.github.io/sicp/html/2_002e5.xhtml#g_t2_002e5</p>
<ul>
<li><a href="The Unreasonable Effectiveness of Multiple Dispatch">https://www.youtube.com/watch?v=kc9HwsxE1OY</a> and <a href="https://www.juliaopt.org/meetings/santiago2019/slides/stefan_karpinski.pdf">the slides to the talk</a></li>
<li>Take a look at this <a href="https://cs.brown.edu/~sk/Publications/Papers/Published/fffk-htdp-vs-sicp-journal/paper.pdf">curriculum document</a></li>
</ul>
<h4 id="relevant-wiki-pages">Relevant Wiki Pages:</h4>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Numerical_tower">Numerical tower</a>. A more formal version of the integer &lt; rational &lt; real &lt; complex.</li>
<li><a href="https://en.wikipedia.org/wiki/Expression_problem">Expression problem</a></li>
<li><a href="https://en.wikipedia.org/wiki/Multiple_inheritance">Multiple inheritance</a></li>
<li><a href="https://en.wikipedia.org/wiki/Common_Lisp_Object_System">Common Lisp Object System</a></li>
<li><a href="https://en.wikipedia.org/wiki/Metaobject#Metaobject_protocol">Metaobject protocol</a></li>
<li><a href="https://en.wikipedia.org/wiki/Greenspun%27s_tenth_rule">Greenspun's tenth rule</a></li>
</ul>
<h4 id="info-about-julia">Info about Julia:</h4>
<ul>
<li><a href="https://juliacon.org/2025/">https://juliacon.org/2025/</a></li>
</ul>
<h3 id="goofiness">Goofiness</h3>
<ul>
<li>turn music back on (DONE!!!!)</li>
<li>Ad break / stretch (DONE) </li>
<li>Finish recording the links (YEP YOU GUESSED IT)</li>
<li>try to take over the world (seems to0 hard)</li>
<li>fail (IN THE BAG!!!)</li>
<li>Learn two spell</li>
<li>fail</li>
<li>keep doing problems</li>
</ul>
<h3 id="introduction">Introduction</h3>
<h3 id="exercises">Exercises</h3>
<h5>Solution</h5>
<h4 id="exercise-277">Exercise 2.77</h4>
<p>Louis Reasoner tries to evaluate
the expression <code>(magnitude z)</code> where <code>z</code> is the object shown in
Figure 2.24.  To his surprise, instead of the answer 5 he gets an error
message from <code>apply-generic</code>, saying there is no method for the operation
<code>magnitude</code> on the types <code>(complex)</code>.  He shows this interaction to
Alyssa P. Hacker, who says "The problem is that the complex-number selectors
were never defined for <code>complex</code> numbers, just for <code>polar</code> and
<code>rectangular</code> numbers.  All you have to do to make this work is add the
following to the <code>complex</code> package:"</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
</code></pre></div>

<p>Describe in detail why this works.  As an example, trace through all the
procedures called in evaluating the expression <code>(magnitude z)</code> where
<code>z</code> is the object shown in Figure 2.24.  In particular, how many
times is <code>apply-generic</code> invoked?  What procedure is dispatched to in each
case?</p>
<h5>Solution</h5>
<p>Implicitly, we must mean that we have also defined:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
</code></pre></div>

<p>So then the sequence of calls looks as follows. We make two calls to
<code>apply-generic</code>, on the first call we wind up inside the complex package,
and on the second call we wind up inside the rectangular package.</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="c1">;; This calls the following inside apply-generic:</span>
<span class="c1">;;   (apply (get op type-tags) (map contents args))</span>
<span class="c1">;; type-tags is just equal to &#39;complex, so we call magnitude again, </span>
<span class="c1">;; this time it was the magnitude scoped inside the complex package. </span>
<span class="c1">;; The argument to this function is the contents of args, so inside</span>
<span class="c1">;; the structure (&#39;complex . (&#39;rectangular . (3 . 4))) we&#39;ve stripped away the &#39;complex.</span>
<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="p">(</span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="mi">4</span><span class="p">)))</span>
<span class="c1">;; Inside install-rectangular-package</span>
<span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span>
<span class="mi">5</span>
</code></pre></div>

<p>Full working example:</p>
<div class="code-box">
<details class="collapsible-code">
<summary class="code-summary"><a href="code/ex2-77.rkt">code/ex2-77.rkt</a> <span class="expand-hint">(click to expand)</span></summary>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="c1">;; ===================================================================</span>
<span class="c1">;; =========================== generic ops ===========================</span>
<span class="c1">;; ===================================================================</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">operation-table</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">         </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">           </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)</span>
<span class="w">                           </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))))</span>
<span class="w">        </span><span class="p">(</span><span class="k">set!</span><span class="w"> </span><span class="n">operation-table</span>
<span class="w">              </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)))</span>
<span class="w">                    </span><span class="n">operation-table</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="p">)</span>
<span class="w">                </span><span class="no">#f</span><span class="p">)))</span>
<span class="w">        </span><span class="no">#f</span><span class="p">)))</span>

<span class="c1">;; Modified for ex2-78. </span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="n">contents</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: TYPE-TAG&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: CONTENTS&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type-tags</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc</span>
<span class="w">          </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="n">args</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">error</span>
<span class="w">            </span><span class="s2">&quot;No method for these types: APPLY-GENERIC&quot;</span>
<span class="w">            </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))))))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ================= Complex polar and rectangular ===================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="n">a</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>


<span class="c1">;; ===================================================================</span>
<span class="c1">;; ========================= Complex package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; imported procedures from rectangular </span>
<span class="w">  </span><span class="c1">;; and polar packages</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span>
<span class="w">          </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>

<span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span>
<span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
</code></pre></div>


</details>
<div class="code-output">
<span>Output:</span>
<pre>done
done
done
5
(complex rectangular 3 . 4)</pre>
</div>
</div>

<h4 id="exercise-278">Exercise 2.78</h4>
<p>The internal procedures in the
<code>scheme-number</code> package are essentially nothing more than calls to the
primitive procedures <code>+</code>, <code>-</code>, etc.  It was not possible to use the
primitives of the language directly because our type-tag system requires that
each data object have a type attached to it.  In fact, however, all Lisp
implementations do have a type system, which they use internally.  Primitive
predicates such as <code>symbol?</code> and <code>number?</code>  determine whether data
objects have particular types.  Modify the definitions of <code>type-tag</code>,
<code>contents</code>, and <code>attach-tag</code> from 2.4.2 so that our
generic system takes advantage of Scheme's internal type system.  That is to
say, the system should work as before except that ordinary numbers should be
represented simply as Scheme numbers rather than as pairs whose <code>car</code> is
the symbol <code>scheme-number</code>.</p>
<h5>Solution</h5>
<p>So, the point of this problem is that we can make these modifications
and that's all we need to do: we need no modifications to the 
scheme-number package.</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="n">contents</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: TYPE-TAG&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: CONTENTS&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
</code></pre></div>

<p>Working example:</p>
<div class="code-box">
<details class="collapsible-code">
<summary class="code-summary"><a href="code/ex2-78.rkt">code/ex2-78.rkt</a> <span class="expand-hint">(click to expand)</span></summary>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="c1">;; get and put definitions</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">operation-table</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">         </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">           </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)</span>
<span class="w">                           </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))))</span>
<span class="w">        </span><span class="p">(</span><span class="k">set!</span><span class="w"> </span><span class="n">operation-table</span>
<span class="w">              </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)))</span>
<span class="w">                    </span><span class="n">operation-table</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="p">)</span>
<span class="w">                </span><span class="no">#f</span><span class="p">)))</span>
<span class="w">        </span><span class="no">#f</span><span class="p">)))</span>

<span class="c1">;; Modified for ex2-78. </span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="n">contents</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: TYPE-TAG&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: CONTENTS&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type-tags</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc</span>
<span class="w">          </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="n">args</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">error</span>
<span class="w">            </span><span class="s2">&quot;No method for these types: APPLY-GENERIC&quot;</span>
<span class="w">            </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))))))</span>

<span class="c1">;; Number package</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="p">))</span>

<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Output of </span>
<span class="s2">(apply-generic &#39;mul</span>
<span class="s2">  (make-scheme-number 13)</span>
<span class="s2">  (make-scheme-number 11))&quot;</span><span class="p">)(</span><span class="nb">newline</span><span class="p">)</span>

<span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">a</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="mi">13</span><span class="p">))</span><span class="w"> </span>
<span class="w">      </span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="mi">11</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
</code></pre></div>


</details>
<div class="code-output">
<span>Output:</span>
<pre>done
Output of 
(apply-generic &#x27;mul
  (make-scheme-number 13)
  (make-scheme-number 11))
143
</pre>
</div>
</div>

<h4 id="exercise-279">Exercise 2.79</h4>
<p>Define a generic equality
predicate <code>equ?</code> that tests the equality of two numbers, and install it in
the generic arithmetic package.  This operation should work for ordinary
numbers, rational numbers, and complex numbers.</p>
<h5>Solution</h5>
<p>We certainly want to do this without type coercion, because we get to
type coercion in the next sections.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">;; Inside scheme-number</span>
<span class="w">  </span><span class="c1">;; This depends how it&#39;s defined. If we define it as in 2.78, </span>
<span class="w">  </span><span class="c1">;; then we can just compare the numbers directly.</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>

<span class="c1">;; Inside rational-package</span>
<span class="w">  </span><span class="c1">;; z1a/z1b = z2a/z2b  iff z1a*z2b - z2a*z1b = 0</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span><span class="w"> </span>
<span class="w">          </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z1</span><span class="p">)))</span>
<span class="w">        </span><span class="mi">0</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>

<span class="c1">;;inside complex-package</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
</code></pre></div>

<p>Testing:</p>
<div class="code-box">
<details class="collapsible-code">
<summary class="code-summary"><a href="code/ex2-79.rkt">code/ex2-79.rkt</a> <span class="expand-hint">(click to expand)</span></summary>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="c1">;; ===================================================================</span>
<span class="c1">;; =========================== generic ops ===========================</span>
<span class="c1">;; ===================================================================</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">operation-table</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">         </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">           </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)</span>
<span class="w">                           </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))))</span>
<span class="w">        </span><span class="p">(</span><span class="k">set!</span><span class="w"> </span><span class="n">operation-table</span>
<span class="w">              </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)))</span>
<span class="w">                    </span><span class="n">operation-table</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="p">)</span>
<span class="w">                </span><span class="no">#f</span><span class="p">)))</span>
<span class="w">        </span><span class="no">#f</span><span class="p">)))</span>

<span class="c1">;; Modified for ex2-78. </span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="n">contents</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: TYPE-TAG&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: CONTENTS&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type-tags</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc</span>
<span class="w">          </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="n">args</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">error</span>
<span class="w">            </span><span class="s2">&quot;No method for these types: APPLY-GENERIC&quot;</span>
<span class="w">            </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))))))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ========================== Number package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">egu?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span><span class="w"> </span><span class="c1">;Problem 2.79</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="p">))</span>


<span class="c1">;; ===================================================================</span>
<span class="c1">;; ======================== Rational package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">g</span><span class="w"> </span><span class="p">(</span><span class="nb">gcd</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">g</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="n">g</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>

<span class="w">  </span><span class="c1">;; z1a/z1b = z2a/z2b  iff z1a*z2b - z2a*z1b = 0</span>
<span class="w">  </span><span class="c1">;; equ? for problem 2.79</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z1</span><span class="p">)))</span>
<span class="w">        </span><span class="mi">0</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ================= Complex polar and rectangular ===================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="n">a</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ========================= Complex package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; imported procedures from rectangular </span>
<span class="w">  </span><span class="c1">;; and polar packages</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span>
<span class="w">          </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="c1">; for problem 2.79</span>
<span class="w">    </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span><span class="w"> </span><span class="c1">; Changes from problem 2.77</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">8</span><span class="p">))</span>

<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Testing for 2.79&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>

<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;(equ? (make-complex-from-real-imag 3 4)</span>
<span class="s2">      (make-complex-from-real-imag 3 4))&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;(equ? (make-rational 3 4)</span>
<span class="s2">      (make-rational 6 8))&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;(equ? (make-rational 3 4)</span>
<span class="s2">      (add (make-rational 3 4) (make-rational 6 8)))&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
</code></pre></div>


</details>
<div class="code-output">
<span>Output:</span>
<pre>done
done
done
done
done

Testing for 2.79
(equ? (make-complex-from-real-imag 3 4)
      (make-complex-from-real-imag 3 4))
#t
(equ? (make-rational 3 4)
      (make-rational 6 8))
#t
(equ? (make-rational 3 4)
      (add (make-rational 3 4) (make-rational 6 8)))
#f
</pre>
</div>
</div>

<h4 id="exercise-280">Exercise 2.80</h4>
<p>Define a generic predicate
<code>=zero?</code> that tests if its argument is zero, and install it in the generic
arithmetic package.  This operation should work for ordinary numbers, rational
numbers, and complex numbers.</p>
<h5>Solution</h5>
<div class="codehilite"><pre><span></span><code><span class="w">  </span><span class="c1">;;inside scheme-number</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;;inside rational-package</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;;inside complex-package</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
</code></pre></div>

<p>Testing:</p>
<div class="code-box">
<details class="collapsible-code">
<summary class="code-summary"><a href="code/ex2-80.rkt">code/ex2-80.rkt</a> <span class="expand-hint">(click to expand)</span></summary>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="c1">;; ===================================================================</span>
<span class="c1">;; =========================== generic ops ===========================</span>
<span class="c1">;; ===================================================================</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">operation-table</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">         </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">           </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)</span>
<span class="w">                           </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))))</span>
<span class="w">        </span><span class="p">(</span><span class="k">set!</span><span class="w"> </span><span class="n">operation-table</span>
<span class="w">              </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)))</span>
<span class="w">                    </span><span class="n">operation-table</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="p">)</span>
<span class="w">                </span><span class="no">#f</span><span class="p">)))</span>
<span class="w">        </span><span class="no">#f</span><span class="p">)))</span>

<span class="c1">;; Modified for ex2-78. </span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="n">contents</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: TYPE-TAG&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: CONTENTS&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type-tags</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc</span>
<span class="w">          </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="n">args</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">error</span>
<span class="w">            </span><span class="s2">&quot;No method for these types: APPLY-GENERIC&quot;</span>
<span class="w">            </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))))))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ========================== Number package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">egu?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span><span class="w"> </span><span class="c1">;Problem 2.79</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="p">))</span>


<span class="c1">;; ===================================================================</span>
<span class="c1">;; ======================== Rational package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">g</span><span class="w"> </span><span class="p">(</span><span class="nb">gcd</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">g</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="n">g</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>

<span class="w">  </span><span class="c1">;; z1a/z1b = z2a/z2b  iff z1a*z2b - z2a*z1b = 0</span>
<span class="w">  </span><span class="c1">;; equ? for problem 2.79</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z1</span><span class="p">)))</span>
<span class="w">        </span><span class="mi">0</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ================= Complex polar and rectangular ===================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="n">a</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ========================= Complex package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; imported procedures from rectangular </span>
<span class="w">  </span><span class="c1">;; and polar packages</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span>
<span class="w">          </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="c1">; for problem 2.79</span>
<span class="w">    </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span><span class="w"> </span><span class="c1">; Changes from problem 2.77</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">8</span><span class="p">))</span>

<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Testing for 2.80&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;(=zero? (make-complex-from-real-imag 3 4))&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;(=zero? (sub (make-complex-from-real-imag 3 4) </span>
<span class="s2">             (make-complex-from-real-imag 3 4)))&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
</code></pre></div>


</details>
<div class="code-output">
<span>Output:</span>
<pre>done
done
done
done
done

Testing for 2.80
(=zero? (make-complex-from-real-imag 3 4))
#f
(=zero? (sub (make-complex-from-real-imag 3 4) 
             (make-complex-from-real-imag 3 4)))
#t
</pre>
</div>
</div>

<h4 id="exercise-281">Exercise 2.81</h4>
<p>Louis Reasoner has noticed that
<code>apply-generic</code> may try to coerce the arguments to each other's type even
if they already have the same type.  Therefore, he reasons, we need to put
procedures in the coercion table to coerce arguments of each type to
their own type.  For example, in addition to the
<code>scheme-number-&gt;complex</code> coercion shown above, he would do:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">scheme-number-&gt;scheme-number</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">complex-&gt;complex</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>

<span class="p">(</span><span class="n">put-coercion</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span>
<span class="w">              </span><span class="n">scheme-number-&gt;scheme-number</span><span class="p">)</span>

<span class="p">(</span><span class="n">put-coercion</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="w"> </span>
<span class="w">              </span><span class="n">complex-&gt;complex</span><span class="p">)</span>
</code></pre></div>

<p><strong>1.</strong> With Louis's coercion procedures installed, what happens if
<code>apply-generic</code> is called with two arguments of type <code>scheme-number</code>
or two arguments of type <code>complex</code> for an operation that is not found in
the table for those types?  For example, assume that we've defined a generic
exponentiation operation:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">exp</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">exp</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
</code></pre></div>

<p>and have put a procedure for exponentiation in the Scheme-number
package but not in any other package:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">;; following added to Scheme-number package</span>
<span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">exp</span><span class="w"> </span>
<span class="w">     </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">     </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">expt</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span><span class="w"> </span>
<span class="w">       </span><span class="c1">; using primitive expt</span>
</code></pre></div>

<p>What happens if we call <code>exp</code> with two complex numbers as arguments?</p>
<p><strong>2.</strong> Is Louis correct that something had to be done about coercion with arguments of
the same type, or does <code>apply-generic</code> work correctly as is?</p>
<p><strong>3.</strong> Modify <code>apply-generic</code> so that it doesn't try coercion if the two
arguments have the same type.</p>
<h5>Solution</h5>
<p>So first of all, it should be fine with no definitions. We do two extra lookups,
which both return false to say there is no coercion from type A to type A,
and then we give an error. But let's suppose we do this anyways.</p>
<p><strong>Part 1.</strong>
<code>proc</code> is false, but we now find coercion functions
<code>t1-&gt;t2</code> and <code>t2-&gt;t1</code>, but the first call to this function introduces a problem:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="n">t1-&gt;t2</span><span class="w"> </span><span class="n">a1</span><span class="p">)</span><span class="w"> </span><span class="n">a2</span><span class="p">)</span>
</code></pre></div>

<p>We apply the lookup again, proc is false, we coerce and call apply-generic again...
so we just get an infinite recursion!</p>
<p><strong>Part 2.</strong> <code>apply-generic</code> works fine as-is. If the function isn't found 
and assigned to proc, then there's nothing we can do, we want <code>t1-&gt;t2</code> and <code>t2-&gt;t1</code> to be false exactly as they are.</p>
<p><strong>Part 3.</strong> We really don't need this, but we could check for <code>eq?</code> among
the two types. After we check to make sure that the length is two and 
after we use <code>let</code> to get the two types, we check for type equality.</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type-tags</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc</span>
<span class="w">          </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="n">args</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type1</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))</span>
<span class="w">                    </span><span class="p">(</span><span class="n">type2</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))</span>
<span class="w">                    </span><span class="p">(</span><span class="n">a1</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">args</span><span class="p">))</span>
<span class="w">                    </span><span class="p">(</span><span class="n">a2</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">                </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">type1</span><span class="w"> </span><span class="n">type2</span><span class="p">)</span><span class="w">  </span><span class="c1">;; &lt;-- our modification</span>
<span class="w">                  </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;No method for these types&quot;</span>
<span class="w">                    </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))</span>
<span class="w">                  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t1-&gt;t2</span>
<span class="w">                         </span><span class="p">(</span><span class="n">get-coercion</span><span class="w"> </span><span class="n">type1</span>
<span class="w">                                       </span><span class="n">type2</span><span class="p">))</span>
<span class="w">                        </span><span class="p">(</span><span class="n">t2-&gt;t1</span>
<span class="w">                         </span><span class="p">(</span><span class="n">get-coercion</span><span class="w"> </span><span class="n">type2</span>
<span class="w">                                       </span><span class="n">type1</span><span class="p">)))</span>
<span class="w">                    </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">(</span><span class="n">t1-&gt;t2</span>
<span class="w">                           </span><span class="p">(</span><span class="n">apply-generic</span>
<span class="w">                            </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="n">t1-&gt;t2</span><span class="w"> </span><span class="n">a1</span><span class="p">)</span><span class="w"> </span><span class="n">a2</span><span class="p">))</span>
<span class="w">                          </span><span class="p">(</span><span class="n">t2-&gt;t1</span>
<span class="w">                           </span><span class="p">(</span><span class="n">apply-generic</span>
<span class="w">                            </span><span class="n">op</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="p">(</span><span class="n">t2-&gt;t1</span><span class="w"> </span><span class="n">a2</span><span class="p">)))</span>
<span class="w">                          </span><span class="p">(</span><span class="k">else</span>
<span class="w">                           </span><span class="p">(</span><span class="nb">error</span>
<span class="w">                            </span><span class="s2">&quot;No method for</span>
<span class="s2">                             these types&quot;</span>
<span class="w">                            </span><span class="p">(</span><span class="nb">list</span>
<span class="w">                             </span><span class="n">op</span>
<span class="w">                             </span><span class="n">type-tags</span><span class="p">)))))))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">error</span>
<span class="w">               </span><span class="s2">&quot;No method for these types&quot;</span>
<span class="w">               </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))))))</span>
</code></pre></div>

<h4 id="exercise-282">Exercise 2.82</h4>
<p>Show how to generalize
<code>apply-generic</code> to handle coercion in the general case of multiple
arguments.  One strategy is to attempt to coerce all the arguments to the type
of the first argument, then to the type of the second argument, and so on.
Give an example of a situation where this strategy (and likewise the
two-argument version given above) is not sufficiently general.  (Hint: Consider
the case where there are some suitable mixed-type operations present in the
table that will not be tried.)</p>
<h5>Solution</h5>
<p>Well, this is a really shoddy type conversion system! Let's implement it like 
the book asks. But of course it won't be sufficient, say we wanted to define
<code>fast-pow</code> from chapter 1 as <code>(fast-pow complex int)</code>. Our type conversion
system would miss this.</p>
<p>I ended up with a very overcomplicated method to do this, I wanted to power
through it but it's definitely worth comparing to other solutions to see
if they did it a simpler way.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">;; Try to coerce every element of args into target-type (a single type).</span>
<span class="c1">;; If a coercion fails to exist, or if the function on type (target-type</span>
<span class="c1">;; target-type ...) doesn&#39;t exist, return false.</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">coerce-all</span><span class="w"> </span><span class="n">target-type</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="c1">;; get the function f that coerces source-type to target-type if it </span>
<span class="w">  </span><span class="c1">;; exists, identity lambda if it&#39;s the same type, and false otherwise.</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">coerce-function</span><span class="w"> </span><span class="n">source-type</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">coercion</span><span class="w"> </span><span class="p">(</span><span class="n">get-coercion</span><span class="w"> </span><span class="n">source-type</span><span class="w"> </span><span class="n">target-type</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">coercion</span><span class="w"> </span>
<span class="w">          </span><span class="n">coercion</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">source-type</span><span class="w"> </span><span class="n">target-type</span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">            </span><span class="no">#f</span><span class="p">))))</span>

<span class="w">  </span><span class="c1">;; Coerce all arguments if all type coercions exist, else return false.</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">map-if-exists</span><span class="w"> </span><span class="n">procs</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">procs</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">args</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">procs</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()</span><span class="w"> </span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">coercion</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">procs</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">coercion</span>
<span class="w">              </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nb">rest</span><span class="w"> </span><span class="p">(</span><span class="n">map-if-exists</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">procs</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">args</span><span class="p">))))</span>
<span class="w">                </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="nb">rest</span><span class="w"> </span>
<span class="w">                    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="n">coercion</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="nb">rest</span><span class="p">)</span>
<span class="w">                    </span><span class="no">#f</span><span class="p">))</span>
<span class="w">              </span><span class="no">#f</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;procs and args must be the same length inside coerce-all&quot;</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type-tags</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">procs</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">coerce-function</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">map-if-exists</span><span class="w"> </span><span class="n">procs</span><span class="w"> </span><span class="n">args</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; Attempt the coerction to the nth type. </span>
<span class="w">  </span><span class="c1">;; The car of the result will be false if no function and coercion exists</span>
<span class="w">  </span><span class="c1">;; If one does exist, the car will be true and the cadr will be the result.</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">attempt-coercions</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">    </span><span class="c1">;; So long as n&lt;=length(type-tags) try to look up a function </span>
<span class="w">    </span><span class="c1">;; with type tags all of (list-ref type-tags n). If not, increase n by one</span>
<span class="w">    </span><span class="c1">;; and try again.</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">target-type</span><span class="w"> </span><span class="p">(</span><span class="nb">list-ref</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">n</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">target-type</span><span class="p">)</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="n">args-coerced</span><span class="w"> </span><span class="p">(</span><span class="n">coerce-all</span><span class="w"> </span><span class="n">target-type</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="n">args-coerced</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="no">#t</span><span class="w"> </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="n">args-coerced</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="n">attempt-coercions</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">args</span><span class="p">))))</span>
<span class="w">       </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="no">#f</span><span class="w"> </span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type-tags</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc</span>
<span class="w">          </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="n">args</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">res</span><span class="w"> </span><span class="p">(</span><span class="n">attempt-coercions</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">res</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">res</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="nb">error</span>
<span class="w">                 </span><span class="s2">&quot;No method for these types!!!&quot;</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))))</span>
<span class="w">            </span><span class="p">(</span><span class="nb">error</span>
<span class="w">             </span><span class="s2">&quot;No method for these types&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))))))</span>
</code></pre></div>

<p>Because this is so much code, I wanted to run a bunch of test cases for it:</p>
<div class="code-box">
<details class="collapsible-code">
<summary class="code-summary"><a href="code/ex2-82.rkt">code/ex2-82.rkt</a> <span class="expand-hint">(click to expand)</span></summary>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="c1">;; ===================================================================</span>
<span class="c1">;; =========================== generic ops ===========================</span>
<span class="c1">;; ===================================================================</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">operation-table</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">coercion-table</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span><span class="w"> </span><span class="c1">; Problems 2.81+</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">           </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)</span>
<span class="w">                           </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))))</span>
<span class="w">        </span><span class="p">(</span><span class="k">set!</span><span class="w"> </span><span class="n">operation-table</span>
<span class="w">              </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)))</span>
<span class="w">                    </span><span class="n">operation-table</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="p">)</span>
<span class="w">                </span><span class="no">#f</span><span class="p">)))</span>
<span class="w">        </span><span class="no">#f</span><span class="p">)))</span>

<span class="c1">;; Type coercion stuff for ex2-81 onwards.</span>

<span class="c1">;; Stores a procedure to convert from type1 to type2</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">put-coercion</span><span class="w"> </span><span class="n">type1</span><span class="w"> </span><span class="n">type2</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type1-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type1</span><span class="w"> </span><span class="n">coercion-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">type1-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">type1-entry</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type2-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type2</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">type2-entry</span>
<span class="w">                </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="n">type2-entry</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">type1-entry</span><span class="p">)</span>
<span class="w">                          </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type2</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))))</span>
<span class="w">        </span><span class="p">(</span><span class="k">set!</span><span class="w"> </span><span class="n">coercion-table</span>
<span class="w">              </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">type1</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type2</span><span class="w"> </span><span class="n">proc</span><span class="p">)))</span><span class="w"> </span>
<span class="w">                    </span><span class="n">coercion-table</span><span class="p">)))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">get-coercion</span><span class="w"> </span><span class="n">type1</span><span class="w"> </span><span class="n">type2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type1-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type1</span><span class="w"> </span><span class="n">coercion-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">type1-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">type1-entry</span><span class="p">)))</span><span class="w"> </span>
<span class="w">          </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type2-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type2</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">type2-entry</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">type2-entry</span><span class="p">)</span>
<span class="w">                </span><span class="no">#f</span><span class="p">)))</span>
<span class="w">        </span><span class="no">#f</span><span class="p">)))</span>

<span class="c1">;; Modified for ex2-78. </span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="n">contents</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: TYPE-TAG&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: CONTENTS&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>




<span class="c1">;; Try to coerce every element of args into target-type (a single type).</span>
<span class="c1">;; If a coercion fails to exist, or if the function on type (target-type</span>
<span class="c1">;; target-type ...) doesn&#39;t exist, return false.</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">coerce-all</span><span class="w"> </span><span class="n">target-type</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="c1">;; get the function f that coerces source-type to target-type if it </span>
<span class="w">  </span><span class="c1">;; exists, identity lambda if it&#39;s the same type, and false otherwise.</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">coerce-function</span><span class="w"> </span><span class="n">source-type</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">coercion</span><span class="w"> </span><span class="p">(</span><span class="n">get-coercion</span><span class="w"> </span><span class="n">source-type</span><span class="w"> </span><span class="n">target-type</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">coercion</span><span class="w"> </span>
<span class="w">          </span><span class="n">coercion</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">source-type</span><span class="w"> </span><span class="n">target-type</span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">            </span><span class="no">#f</span><span class="p">))))</span>

<span class="w">  </span><span class="c1">;; Coerce all arguments if all type coercions exist, else return false.</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">map-if-exists</span><span class="w"> </span><span class="n">procs</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">procs</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">args</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">procs</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()</span><span class="w"> </span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">coercion</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">procs</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">coercion</span>
<span class="w">              </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nb">rest</span><span class="w"> </span><span class="p">(</span><span class="n">map-if-exists</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">procs</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">args</span><span class="p">))))</span>
<span class="w">                </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="nb">rest</span><span class="w"> </span>
<span class="w">                    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="n">coercion</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="nb">rest</span><span class="p">)</span>
<span class="w">                    </span><span class="no">#f</span><span class="p">))</span>
<span class="w">              </span><span class="no">#f</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;procs and args must be the same length inside coerce-all&quot;</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type-tags</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">procs</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">coerce-function</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">map-if-exists</span><span class="w"> </span><span class="n">procs</span><span class="w"> </span><span class="n">args</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; Attempt the coerction to the nth type. </span>
<span class="w">  </span><span class="c1">;; The car of the result will be false if no function and coercion exists</span>
<span class="w">  </span><span class="c1">;; If one does exist, the car will be true and the cadr will be the result.</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">attempt-coercions</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">    </span><span class="c1">;; So long as n&lt;=length(type-tags) try to look up a function </span>
<span class="w">    </span><span class="c1">;; with type tags all of (list-ref type-tags n). If not, increase n by one</span>
<span class="w">    </span><span class="c1">;; and try again.</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">target-type</span><span class="w"> </span><span class="p">(</span><span class="nb">list-ref</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">n</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">target-type</span><span class="p">)</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="n">args-coerced</span><span class="w"> </span><span class="p">(</span><span class="n">coerce-all</span><span class="w"> </span><span class="n">target-type</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="n">args-coerced</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="no">#t</span><span class="w"> </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="n">args-coerced</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="n">attempt-coercions</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">args</span><span class="p">))))</span>
<span class="w">       </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="no">#f</span><span class="w"> </span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type-tags</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc</span>
<span class="w">          </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="n">args</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">res</span><span class="w"> </span><span class="p">(</span><span class="n">attempt-coercions</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">res</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">res</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="nb">error</span>
<span class="w">                 </span><span class="s2">&quot;No method for these types!!!&quot;</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))))</span>
<span class="w">            </span><span class="p">(</span><span class="nb">error</span>
<span class="w">             </span><span class="s2">&quot;No method for these types&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))))))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ========================== Number package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">egu?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span><span class="w"> </span><span class="c1">;Problem 2.79</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="p">))</span>


<span class="c1">;; ===================================================================</span>
<span class="c1">;; ======================== Rational package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">g</span><span class="w"> </span><span class="p">(</span><span class="nb">gcd</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">g</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="n">g</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>

<span class="w">  </span><span class="c1">;; z1a/z1b = z2a/z2b  iff z1a*z2b - z2a*z1b = 0</span>
<span class="w">  </span><span class="c1">;; equ? for problem 2.79</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z1</span><span class="p">)))</span>
<span class="w">        </span><span class="mi">0</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ================= Complex polar and rectangular ===================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="n">a</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ========================= Complex package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; imported procedures from rectangular </span>
<span class="w">  </span><span class="c1">;; and polar packages</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span>
<span class="w">          </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="c1">; for problem 2.79</span>
<span class="w">    </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span><span class="w"> </span><span class="c1">; Changes from problem 2.77</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>

<span class="c1">;; Crazy test cases (test cases generated by gemini 2.5 pro)</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ===================== Coercion Procedures =======================</span>
<span class="c1">;; ===================================================================</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">scheme-number-&gt;rational</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">scheme-number-&gt;complex</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">rational-&gt;complex</span><span class="w"> </span><span class="n">r</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">rat-val</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">r</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">rat-val</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">rat-val</span><span class="p">))</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>

<span class="c1">;; Install the coercions</span>
<span class="p">(</span><span class="n">put-coercion</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="w"> </span><span class="n">scheme-number-&gt;rational</span><span class="p">)</span>
<span class="p">(</span><span class="n">put-coercion</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="w"> </span><span class="n">scheme-number-&gt;complex</span><span class="p">)</span>
<span class="p">(</span><span class="n">put-coercion</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="w"> </span><span class="n">rational-&gt;complex</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Coercions installed.&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>


<span class="c1">;; ===================================================================</span>
<span class="c1">;; ======================== Test Variables =========================</span>
<span class="c1">;; ===================================================================</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">sn1</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="mi">5</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">sn2</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="mi">-2</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">rat1</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">rat2</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">comp1</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">comp2</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>


<span class="c1">;; ===================================================================</span>
<span class="c1">;; ========================== Test Suite ===========================</span>
<span class="c1">;; ===================================================================</span>
<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;--- Testing Basic Operations ---&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add SN+SN: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">sn1</span><span class="w"> </span><span class="n">sn2</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add Rat+Rat: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">rat1</span><span class="w"> </span><span class="n">rat2</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add Comp+Comp: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">comp1</span><span class="w"> </span><span class="n">comp2</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>

<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;--- Testing Simple Coercion (2 Args) ---&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add SN+Rat: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">sn1</span><span class="w"> </span><span class="n">rat1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect Rat (11 . 2)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add Rat+SN: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">rat1</span><span class="w"> </span><span class="n">sn1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect Rat (11 . 2)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add SN+Comp: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">sn1</span><span class="w"> </span><span class="n">comp1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect Comp (rect 7 . 3)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add Comp+SN: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">comp1</span><span class="w"> </span><span class="n">sn1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect Comp (rect 7 . 3)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add Rat+Comp: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">rat1</span><span class="w"> </span><span class="n">comp2</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect Comp (rect 1.5 . 1)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add Comp+Rat: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">comp2</span><span class="w"> </span><span class="n">rat1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect Comp (rect 1.5 . 1)</span>

<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;--- Testing Equ? with Coercion ---&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Equ? SN=Rat: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">2</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect #t</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Equ? Rat=Comp: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="mf">1.5</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect #t</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Equ? SN=Comp: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">sn1</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect #t</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Equ? SN!=Comp: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">sn1</span><span class="w"> </span><span class="n">comp1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect #f</span>
</code></pre></div>


</details>
<div class="code-output">
<span>Output:</span>
<pre>done
done
done
done
done
Coercions installed.

--- Testing Basic Operations ---
Add SN+SN: 3
Add Rat+Rat: (rational 5 . 4)
Add Comp+Comp: (complex rectangular 3 . 4)

--- Testing Simple Coercion (2 Args) ---
Add SN+Rat: (rational 11 . 2)
Add Rat+SN: (rational 11 . 2)
Add SN+Comp: (complex rectangular 7 . 3)
Add Comp+SN: (complex rectangular 7 . 3)
Add Rat+Comp: (complex rectangular 3/2 . 1)
Add Comp+Rat: (complex rectangular 3/2 . 1)

--- Testing Equ? with Coercion ---
Equ? SN=Rat: #t
Equ? Rat=Comp: #t
Equ? SN=Comp: #t
Equ? SN!=Comp: #f
</pre>
</div>
</div>

<p>Other solutions include...</p>
<ul>
<li><a href="https://github.com/kana/sicp/blob/master/ex-2.82.scm">This solution</a> using square brackets for everything, which isn't a language feature I've used yet.</li>
<li><a href="https://wizardbook.wordpress.com/2010/12/08/exercise-2-82/">This solution</a> which uses <code>member</code> and <code>(map func list1 list2)</code>. In Python this would be something like <code>[func(a,b) for (a,b) in zip(list1,list2)]</code>.</li>
<li><a href="https://github.com/track02/Scheme---SICP/blob/master/Ex%202.82%20-%20Generics.scm">This solution</a> is a much better / shorter implementation of what I did. </li>
</ul>
<h4 id="exercise-283">Exercise 2.83</h4>
<p>Suppose you are designing a
generic arithmetic system for dealing with the tower of types shown in
Figure 2.25: integer, rational, real, complex.  For each type (except
complex), design a procedure that raises objects of that type one level in the
tower.  Show how to install a generic <code>raise</code> operation that will work for
each type (except complex).</p>
<h5>Solution</h5>
<p>We want something like this. Of course scheme-number might be just an untagged
number, and <code>real</code> might be an untagged floating point number, so we have to assume
<code>contents</code> takes care of that properly.</p>
<div class="codehilite"><pre><span></span><code><span class="w">  </span><span class="c1">;; inside scheme-number</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">raise</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span>

<span class="w">  </span><span class="c1">;; inside rational package</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">raise</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">rat</span><span class="p">)</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">rat</span><span class="p">))</span><span class="w"> </span>
<span class="w">                          </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">rat</span><span class="p">))))))</span>

<span class="w">  </span><span class="c1">;; inside real package</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">raise</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">real</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">real</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">))</span>
</code></pre></div>

<h4 id="exercise-284">Exercise 2.84</h4>
<p>Using the <code>raise</code> operation
of Exercise 2.83, modify the <code>apply-generic</code> procedure so that it
coerces its arguments to have the same type by the method of successive
raising, as discussed in this section.  You will need to devise a way to test
which of two types is higher in the tower.  Do this in a manner that is
compatible with the rest of the system and will not lead to problems in
adding new levels to the tower.</p>
<h5>Solution</h5>
<p>Let's use our solution to 2.82. 
All we need to do is implement <code>coerce-all</code> in this new context, and everything will work. </p>
<div class="codehilite"><pre><span></span><code><span class="c1">;; Use accumulate from chapter 2-2.</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">initial</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">      </span><span class="n">initial</span>
<span class="w">      </span><span class="p">(</span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="n">op</span>
<span class="w">                      </span><span class="n">initial</span>
<span class="w">                      </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">sequence</span><span class="p">)))))</span>

<span class="c1">;; returns (list #t raised-result) if repeated application of raise can turn </span>
<span class="c1">;; source into target. Returns (list #f) otherwise.</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">raise-recurse</span><span class="w"> </span><span class="n">argument</span><span class="w"> </span><span class="n">target-type</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">source-type</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">argument</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">source-type</span><span class="w"> </span><span class="n">target-type</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="no">#t</span><span class="w"> </span><span class="n">argument</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">raise-func</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">raise</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">source-type</span><span class="p">))))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">raise-func</span>
<span class="w">            </span><span class="p">(</span><span class="n">raise-recurse</span><span class="w"> </span><span class="p">(</span><span class="n">raise-func</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">argument</span><span class="p">))</span><span class="w"> </span><span class="n">target-type</span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="no">#f</span><span class="p">))))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">coerce-all</span><span class="w"> </span><span class="n">target-type</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="c1">;; The point of this is that when we apply (map (... raise-recurse ) args),</span>
<span class="w">  </span><span class="c1">;; we get a list list ((#t coerced) (#t coerced) (#f) (#t coerced))</span>
<span class="w">  </span><span class="c1">;; If anything is false, then we fail.</span>
<span class="w">  </span><span class="c1">;; If all are true, then we return a list (list #t coerced-list)</span>
<span class="w">  </span><span class="p">((</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">args-coerced</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">args-coerced</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">args-coerced</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">                  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                    </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="no">#t</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span>
<span class="w">                    </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="no">#f</span><span class="p">)))</span><span class="w"> </span>
<span class="w">              </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="no">#t</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span><span class="w"> </span>
<span class="w">              </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">raise-recurse</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="n">target-type</span><span class="p">))</span><span class="w"> </span><span class="n">args</span><span class="p">))))</span>

<span class="c1">;; The rest is the same as in 2-82, all we&#39;ve done is replace coerce-all to work</span>
<span class="c1">;; by repeated application of raise.</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">attempt-coercions</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">target-type</span><span class="w"> </span><span class="p">(</span><span class="nb">list-ref</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">n</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">target-type</span><span class="p">)</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="n">args-coerced</span><span class="w"> </span><span class="p">(</span><span class="n">coerce-all</span><span class="w"> </span><span class="n">target-type</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="n">args-coerced</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="no">#t</span><span class="w"> </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="n">args-coerced</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="n">attempt-coercions</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">args</span><span class="p">))))</span>
<span class="w">       </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="no">#f</span><span class="w"> </span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type-tags</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc</span>
<span class="w">          </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="n">args</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">res</span><span class="w"> </span><span class="p">(</span><span class="n">attempt-coercions</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">res</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">res</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="nb">error</span>
<span class="w">                 </span><span class="s2">&quot;No method for these types!!!&quot;</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))))</span>
<span class="w">            </span><span class="p">(</span><span class="nb">error</span>
<span class="w">             </span><span class="s2">&quot;No method for these types&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))))))</span>
</code></pre></div>

<p>Working example:</p>
<div class="code-box">
<details class="collapsible-code">
<summary class="code-summary"><a href="code/ex2-84.rkt">code/ex2-84.rkt</a> <span class="expand-hint">(click to expand)</span></summary>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="c1">;; ===================================================================</span>
<span class="c1">;; =========================== generic ops ===========================</span>
<span class="c1">;; ===================================================================</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">operation-table</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">           </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)</span>
<span class="w">                           </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))))</span>
<span class="w">        </span><span class="p">(</span><span class="k">set!</span><span class="w"> </span><span class="n">operation-table</span>
<span class="w">              </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)))</span>
<span class="w">                    </span><span class="n">operation-table</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="p">)</span>
<span class="w">                </span><span class="no">#f</span><span class="p">)))</span>
<span class="w">        </span><span class="no">#f</span><span class="p">)))</span>

<span class="c1">;; Modified for ex2-78. </span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="n">contents</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: TYPE-TAG&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: CONTENTS&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>


<span class="c1">;; Use accumulate from chapter 2-2.</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">initial</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">      </span><span class="n">initial</span>
<span class="w">      </span><span class="p">(</span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="n">op</span>
<span class="w">                      </span><span class="n">initial</span>
<span class="w">                      </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">sequence</span><span class="p">)))))</span>

<span class="c1">;; returns (list #t raised-result) if repeated application of raise can turn </span>
<span class="c1">;; source into target. Returns (list #f) otherwise.</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">raise-recurse</span><span class="w"> </span><span class="n">argument</span><span class="w"> </span><span class="n">target-type</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">source-type</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">argument</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">source-type</span><span class="w"> </span><span class="n">target-type</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="no">#t</span><span class="w"> </span><span class="n">argument</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">raise-func</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">raise</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">source-type</span><span class="p">))))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">raise-func</span>
<span class="w">            </span><span class="p">(</span><span class="n">raise-recurse</span><span class="w"> </span><span class="p">(</span><span class="n">raise-func</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">argument</span><span class="p">))</span><span class="w"> </span><span class="n">target-type</span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="no">#f</span><span class="p">))))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">coerce-all</span><span class="w"> </span><span class="n">target-type</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="c1">;; The point of this is that when we apply (map (... raise-recurse ) args),</span>
<span class="w">  </span><span class="c1">;; we get a list list ((#t coerced) (#t coerced) (#f) (#t coerced))</span>
<span class="w">  </span><span class="c1">;; If anything is false, then we fail.</span>
<span class="w">  </span><span class="c1">;; If all are true, then we return a list (list #t coerced-list)</span>
<span class="w">  </span><span class="p">((</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">args-coerced</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">args-coerced</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">args-coerced</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">                  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                    </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="no">#t</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span>
<span class="w">                    </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="no">#f</span><span class="p">)))</span><span class="w"> </span>
<span class="w">              </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="no">#t</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span><span class="w"> </span>
<span class="w">              </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">raise-recurse</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="n">target-type</span><span class="p">))</span><span class="w"> </span><span class="n">args</span><span class="p">))))</span>

<span class="c1">;; The rest is the same as in 2-82, all we&#39;ve done is replace coerce-all to work</span>
<span class="c1">;; by repeated application of raise.</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">attempt-coercions</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">target-type</span><span class="w"> </span><span class="p">(</span><span class="nb">list-ref</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">n</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">target-type</span><span class="p">)</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="n">args-coerced</span><span class="w"> </span><span class="p">(</span><span class="n">coerce-all</span><span class="w"> </span><span class="n">target-type</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="n">args-coerced</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="no">#t</span><span class="w"> </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="n">args-coerced</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="n">attempt-coercions</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">args</span><span class="p">))))</span>
<span class="w">       </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="no">#f</span><span class="w"> </span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type-tags</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc</span>
<span class="w">          </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="n">args</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">res</span><span class="w"> </span><span class="p">(</span><span class="n">attempt-coercions</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">res</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">res</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="nb">error</span>
<span class="w">                 </span><span class="s2">&quot;No method for these types!!!&quot;</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))))</span>
<span class="w">            </span><span class="p">(</span><span class="nb">error</span>
<span class="w">             </span><span class="s2">&quot;No method for these types&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))))))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ========================== Number package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">egu?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span><span class="w"> </span><span class="c1">;Problem 2.79</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">raise</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="p">))</span>


<span class="c1">;; ===================================================================</span>
<span class="c1">;; ======================== Rational package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">g</span><span class="w"> </span><span class="p">(</span><span class="nb">gcd</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">g</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="n">g</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>

<span class="w">  </span><span class="c1">;; z1a/z1b = z2a/z2b  iff z1a*z2b - z2a*z1b = 0</span>
<span class="w">  </span><span class="c1">;; equ? for problem 2.79</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z1</span><span class="p">)))</span>
<span class="w">        </span><span class="mi">0</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">raise</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">    </span><span class="c1">;; a rubber lambda with rats</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">rat</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">rat</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                          </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">rat</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ================= Complex polar and rectangular ===================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="n">a</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ========================= Complex package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; imported procedures from rectangular </span>
<span class="w">  </span><span class="c1">;; and polar packages</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span>
<span class="w">          </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="c1">; for problem 2.79</span>
<span class="w">    </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span><span class="w"> </span><span class="c1">; Changes from problem 2.77</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>

<span class="c1">;; Crazy test cases (test cases generated by gemini 2.5 pro)</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ===================== Coercion Procedures =======================</span>
<span class="c1">;; ===================================================================</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">scheme-number-&gt;rational</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">scheme-number-&gt;complex</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">rational-&gt;complex</span><span class="w"> </span><span class="n">r</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">rat-val</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">r</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">rat-val</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">rat-val</span><span class="p">))</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>



<span class="c1">;; ===================================================================</span>
<span class="c1">;; ======================== Test Variables =========================</span>
<span class="c1">;; ===================================================================</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">sn1</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="mi">5</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">sn2</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="mi">-2</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">rat1</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">rat2</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">comp1</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">comp2</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>

<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">raise</span><span class="w"> </span><span class="n">sn1</span><span class="p">)</span>
<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">raise</span><span class="w"> </span><span class="n">rat2</span><span class="p">)</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ========================== Test Suite ===========================</span>
<span class="c1">;; ===================================================================</span>
<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;--- Testing Basic Operations ---&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add SN+SN: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">sn1</span><span class="w"> </span><span class="n">sn2</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add Rat+Rat: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">rat1</span><span class="w"> </span><span class="n">rat2</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add Comp+Comp: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">comp1</span><span class="w"> </span><span class="n">comp2</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>

<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;--- Testing Simple Coercion (2 Args) ---&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>

<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add SN+Rat: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">sn1</span><span class="w"> </span><span class="n">rat1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect Rat (11 . 2)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add Rat+SN: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">rat1</span><span class="w"> </span><span class="n">sn1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect Rat (11 . 2)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add SN+Comp: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">sn1</span><span class="w"> </span><span class="n">comp1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect Comp (rect 7 . 3)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add Comp+SN: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">comp1</span><span class="w"> </span><span class="n">sn1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect Comp (rect 7 . 3)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add Rat+Comp: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">rat1</span><span class="w"> </span><span class="n">comp2</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect Comp (rect 1.5 . 1)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add Comp+Rat: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">comp2</span><span class="w"> </span><span class="n">rat1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect Comp (rect 1.5 . 1)</span>

<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;--- Testing Equ? with Coercion ---&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Equ? SN=Rat: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">2</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect #t</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Equ? Rat=Comp: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="mf">1.5</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect #t</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Equ? SN=Comp: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">sn1</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect #t</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Equ? SN!=Comp: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">sn1</span><span class="w"> </span><span class="n">comp1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect #f</span>
</code></pre></div>


</details>
<div class="code-output">
<span>Output:</span>
<pre>done
done
done
done
done
(rational 5 . 1)
(complex polar 3/4 . 0)

--- Testing Basic Operations ---
Add SN+SN: 3
Add Rat+Rat: (rational 5 . 4)
Add Comp+Comp: (complex rectangular 3 . 4)

--- Testing Simple Coercion (2 Args) ---
Add SN+Rat: (rational 11 . 2)
Add Rat+SN: (rational 11 . 2)
Add SN+Comp: (complex rectangular 7 . 3)
Add Comp+SN: (complex rectangular 7 . 3)
Add Rat+Comp: (complex rectangular 3/2 . 1)
Add Comp+Rat: (complex rectangular 3/2 . 1)

--- Testing Equ? with Coercion ---
Equ? SN=Rat: #t
Equ? Rat=Comp: #t
Equ? SN=Comp: #t
Equ? SN!=Comp: #f
</pre>
</div>
</div>

<h4 id="exercise-285">Exercise 2.85</h4>
<p>This section mentioned a method
for simplifying a data object by lowering it in the tower of types as far
as possible.  Design a procedure <code>drop</code> that accomplishes this for the
tower described in Exercise 2.83.  The key is to decide, in some general
way, whether an object can be lowered.  For example, the complex number 
$1.5 + 0i$ can be lowered as far as <code>real</code>, the complex number $1 + 0i$ can
be lowered as far as <code>integer</code>, and the complex number $2 + 3i$ cannot
be lowered at all.  Here is a plan for determining whether an object can be
lowered: Begin by defining a generic operation <code>project</code> that pushes
an object down in the tower.  For example, projecting a complex number would
involve throwing away the imaginary part.  Then a number can be dropped if,
when we <code>project</code> it and <code>raise</code> the result back to the type we
started with, we end up with something equal to what we started with.  Show how
to implement this idea in detail, by writing a <code>drop</code> procedure that drops
an object as far as possible.  You will need to design the various projection
operations and
install <code>project</code> as a generic operation in the system.  You will also
need to make use of a generic equality predicate, such as described in
Exercise 2.79.  Finally, use <code>drop</code> to rewrite <code>apply-generic</code>
from Exercise 2.84 so that it simplifies its answers.</p>
<h5>Solution</h5>
<p>Let's assume that we have the solution to 2.84 and 2.79. Then we can just 
do something like <code>(equ? (drop arg) arg)</code> and the raising will be handled for us,
using the code of 2.84.</p>
<p>First of all, since we're changing apply-generic I found that I had some 
unintended side-effects with my 'raise rational definition. So I change that definition
too.</p>
<div class="codehilite"><pre><span></span><code><span class="w">  </span><span class="c1">;; inside rational package</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">project</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">rat</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">rat</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">remainder</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">rat</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">rat</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">rat</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">raise</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">rat</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">rat</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">rat</span><span class="p">))</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; inside complex package</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">project</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">drop</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proj-proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">project</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">arg</span><span class="p">))))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="n">proj-proc</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="n">arg</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">projected-arg</span><span class="w"> </span><span class="p">(</span><span class="n">proj-proc</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">arg</span><span class="p">))))</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">raise-proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">raise</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">projected-arg</span><span class="p">))))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="n">raise-proc</span><span class="p">)</span><span class="w"> </span>
<span class="w">            </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;type is projected to but has no raise function!&quot;</span><span class="w"> </span><span class="n">projected-arg</span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">raised-projected-arg</span><span class="w"> </span><span class="p">(</span><span class="n">raise-proc</span><span class="w"> </span><span class="n">projected-arg</span><span class="p">))</span>
<span class="w">                  </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">arg</span><span class="p">)))))</span>
<span class="w">                  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="n">raised-projected-arg</span><span class="p">)</span>
<span class="w">                     </span><span class="p">(</span><span class="nb">drop</span><span class="w"> </span><span class="n">projected-arg</span><span class="p">)</span>
<span class="w">                     </span><span class="n">arg</span><span class="p">))))))))</span>
</code></pre></div>

<div class="code-box">
<details class="collapsible-code">
<summary class="code-summary"><a href="code/ex2-85.rkt">code/ex2-85.rkt</a> <span class="expand-hint">(click to expand)</span></summary>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="c1">;; ===================================================================</span>
<span class="c1">;; =========================== generic ops ===========================</span>
<span class="c1">;; ===================================================================</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">operation-table</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">           </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)</span>
<span class="w">                           </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))))</span>
<span class="w">        </span><span class="p">(</span><span class="k">set!</span><span class="w"> </span><span class="n">operation-table</span>
<span class="w">              </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)))</span>
<span class="w">                    </span><span class="n">operation-table</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="p">)</span>
<span class="w">                </span><span class="no">#f</span><span class="p">)))</span>
<span class="w">        </span><span class="no">#f</span><span class="p">)))</span>

<span class="c1">;; Modified for ex2-78. </span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="n">contents</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">boolean?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-bool</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: TYPE-TAG&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: CONTENTS&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>


<span class="c1">;; Use accumulate from chapter 2-2.</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">initial</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">      </span><span class="n">initial</span>
<span class="w">      </span><span class="p">(</span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="n">op</span>
<span class="w">                      </span><span class="n">initial</span>
<span class="w">                      </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">sequence</span><span class="p">)))))</span>

<span class="c1">;; returns (list #t raised-result) if repeated application of raise can turn </span>
<span class="c1">;; source into target. Returns (list #f) otherwise.</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">raise-recurse</span><span class="w"> </span><span class="n">argument</span><span class="w"> </span><span class="n">target-type</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">source-type</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">argument</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">source-type</span><span class="w"> </span><span class="n">target-type</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="no">#t</span><span class="w"> </span><span class="n">argument</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">raise-func</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">raise</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">source-type</span><span class="p">))))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">raise-func</span>
<span class="w">            </span><span class="p">(</span><span class="n">raise-recurse</span><span class="w"> </span><span class="p">(</span><span class="n">raise-func</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">argument</span><span class="p">))</span><span class="w"> </span><span class="n">target-type</span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="no">#f</span><span class="p">))))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">coerce-all</span><span class="w"> </span><span class="n">target-type</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="c1">;; The point of this is that when we apply (map (... raise-recurse ) args),</span>
<span class="w">  </span><span class="c1">;; we get a list list ((#t coerced) (#t coerced) (#f) (#t coerced))</span>
<span class="w">  </span><span class="c1">;; If anything is false, then we fail.</span>
<span class="w">  </span><span class="c1">;; If all are true, then we return a list (list #t coerced-list)</span>
<span class="w">  </span><span class="p">((</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">args-coerced</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">args-coerced</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">args-coerced</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">                  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                    </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="no">#t</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span>
<span class="w">                    </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="no">#f</span><span class="p">)))</span><span class="w"> </span>
<span class="w">              </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="no">#t</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span><span class="w"> </span>
<span class="w">              </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">raise-recurse</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="n">target-type</span><span class="p">))</span><span class="w"> </span><span class="n">args</span><span class="p">))))</span>

<span class="c1">;; The rest is the same as in 2-82, all we&#39;ve done is replace coerce-all to work</span>
<span class="c1">;; by repeated application of raise.</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic-inner</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">attempt-coercions</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">target-type</span><span class="w"> </span><span class="p">(</span><span class="nb">list-ref</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">n</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">target-type</span><span class="p">)</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="n">args-coerced</span><span class="w"> </span><span class="p">(</span><span class="n">coerce-all</span><span class="w"> </span><span class="n">target-type</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="n">args-coerced</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="no">#t</span><span class="w"> </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="n">args-coerced</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="n">attempt-coercions</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">args</span><span class="p">))))</span>
<span class="w">       </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="no">#f</span><span class="w"> </span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type-tags</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc</span>
<span class="w">          </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="n">args</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">res</span><span class="w"> </span><span class="p">(</span><span class="n">attempt-coercions</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">res</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">res</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="nb">error</span>
<span class="w">                 </span><span class="s2">&quot;No method for these types!!!&quot;</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))))</span>
<span class="w">            </span><span class="p">(</span><span class="nb">error</span>
<span class="w">             </span><span class="s2">&quot;No method for these types&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">drop</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proj-proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">project</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">arg</span><span class="p">)))))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="n">proj-proc</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="n">arg</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">projected-arg</span><span class="w"> </span><span class="p">(</span><span class="n">proj-proc</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">arg</span><span class="p">))))</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">raise-proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">raise</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">projected-arg</span><span class="p">)))))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="n">raise-proc</span><span class="p">)</span><span class="w"> </span>
<span class="w">            </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;type is projected to but has no raise function!&quot;</span><span class="w"> </span><span class="n">projected-arg</span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">raised-projected-arg</span><span class="w"> </span><span class="p">(</span><span class="n">raise-proc</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">projected-arg</span><span class="p">)))</span>
<span class="w">                  </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">arg</span><span class="p">)))))</span>
<span class="w">                  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">raised-projected-arg</span><span class="p">))</span>
<span class="w">                     </span><span class="p">(</span><span class="nb">drop</span><span class="w"> </span><span class="n">projected-arg</span><span class="p">)</span>
<span class="w">                     </span><span class="n">arg</span><span class="p">))))))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">drop</span><span class="w"> </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">apply-generic-inner</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">args</span><span class="p">))))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ========================== Number package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">egu?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span><span class="w"> </span><span class="c1">;Problem 2.79</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">raise</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="p">))</span>


<span class="c1">;; ===================================================================</span>
<span class="c1">;; ======================== Rational package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">g</span><span class="w"> </span><span class="p">(</span><span class="nb">gcd</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">g</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="n">g</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>

<span class="w">  </span><span class="c1">;; z1a/z1b = z2a/z2b  iff z1a*z2b - z2a*z1b = 0</span>
<span class="w">  </span><span class="c1">;; equ? for problem 2.79</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z1</span><span class="p">)))</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">raise</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">rat</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">rat</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">rat</span><span class="p">))</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">project</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">rat</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">rat</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">remainder</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">rat</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">rat</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">rat</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ================= Complex polar and rectangular ===================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="n">a</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ========================= Complex package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; imported procedures from rectangular </span>
<span class="w">  </span><span class="c1">;; and polar packages</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span>
<span class="w">          </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="c1">; for problem 2.79</span>
<span class="w">    </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span><span class="w"> </span><span class="c1">; Changes from problem 2.77</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">project</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>

<span class="c1">;; Crazy test cases (test cases generated by gemini 2.5 pro)</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ===================== Coercion Procedures =======================</span>
<span class="c1">;; ===================================================================</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">scheme-number-&gt;rational</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">scheme-number-&gt;complex</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">rational-&gt;complex</span><span class="w"> </span><span class="n">r</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">rat-val</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">r</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">rat-val</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">rat-val</span><span class="p">))</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>



<span class="c1">;; ===================================================================</span>
<span class="c1">;; ======================== Test Variables =========================</span>
<span class="c1">;; ===================================================================</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">sn1</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="mi">5</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">sn2</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="mi">-2</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">rat1</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">rat2</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">comp1</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">comp2</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>

<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">raise</span><span class="w"> </span><span class="n">sn1</span><span class="p">)</span>
<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">raise</span><span class="w"> </span><span class="n">rat2</span><span class="p">)</span>
<span class="p">(</span><span class="nb">newline</span><span class="p">)(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Testing whether 1/2+1/2 simplifies:&quot;</span><span class="p">)(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">rat1</span><span class="w"> </span><span class="n">rat1</span><span class="p">)</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ========================== Test Suite ===========================</span>
<span class="c1">;; ===================================================================</span>
<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;--- Testing Basic Operations ---&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add SN+SN: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">sn1</span><span class="w"> </span><span class="n">sn2</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add Rat+Rat: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">rat1</span><span class="w"> </span><span class="n">rat2</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add Comp+Comp: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">comp1</span><span class="w"> </span><span class="n">comp2</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>

<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;--- Testing Simple Coercion (2 Args) ---&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>

<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add SN+Rat: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">sn1</span><span class="w"> </span><span class="n">rat1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect Rat (11 . 2)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add Rat+SN: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">rat1</span><span class="w"> </span><span class="n">sn1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect Rat (11 . 2)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add SN+Comp: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">sn1</span><span class="w"> </span><span class="n">comp1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect Comp (rect 7 . 3)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add Comp+SN: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">comp1</span><span class="w"> </span><span class="n">sn1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect Comp (rect 7 . 3)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add Rat+Comp: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">rat1</span><span class="w"> </span><span class="n">comp2</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect Comp (rect 1.5 . 1)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Add Comp+Rat: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">comp2</span><span class="w"> </span><span class="n">rat1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect Comp (rect 1.5 . 1)</span>

<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;--- Testing Equ? with Coercion ---&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Equ? SN=Rat: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">2</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect #t</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Equ? Rat=Comp: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="mf">1.5</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect #t</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Equ? SN=Comp: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">sn1</span><span class="w"> </span><span class="p">(</span><span class="n">make-complex-from-real-imag</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect #t</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Equ? SN!=Comp: &quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">sn1</span><span class="w"> </span><span class="n">comp1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="c1">; Expect #f</span>
</code></pre></div>


</details>
<div class="code-output">
<span>Output:</span>
<pre>done
done
done
done
done
5
(rational 3 . 4)

Testing whether 1/2+1/2 simplifies:
1

--- Testing Basic Operations ---
Add SN+SN: 3
Add Rat+Rat: (rational 5 . 4)
Add Comp+Comp: (complex rectangular 3 . 4)

--- Testing Simple Coercion (2 Args) ---
Add SN+Rat: (rational 11 . 2)
Add Rat+SN: (rational 11 . 2)
Add SN+Comp: (complex rectangular 7 . 3)
Add Comp+SN: (complex rectangular 7 . 3)
Add Rat+Comp: (complex rectangular 3/2 . 1)
Add Comp+Rat: (complex rectangular 3/2 . 1)

--- Testing Equ? with Coercion ---
Equ? SN=Rat: #t
Equ? Rat=Comp: #t
Equ? SN=Comp: #t
Equ? SN!=Comp: #f
</pre>
</div>
</div>

<h4 id="exercise-286">Exercise 2.86</h4>
<p>Suppose we want to handle complex
numbers whose real parts, imaginary parts, magnitudes, and angles can be either
ordinary numbers, rational numbers, or other numbers we might wish to add to
the system.  Describe and implement the changes to the system needed to
accommodate this.  You will have to define operations such as <code>sine</code> and
<code>cosine</code> that are generic over ordinary numbers and rational numbers.</p>
<h5>Solution</h5>
<h4 id="exercise-287">Exercise 2.87</h4>
<p>Install <code>=zero?</code> for
polynomials in the generic arithmetic package.  This will allow
<code>adjoin-term</code> to work for polynomials with coefficients that are
themselves polynomials.</p>
<h5>Solution</h5>
<p>I make use of the <code>accumulate</code> function.
Ideally, we'd prevent the construction of terms with zero coefficients, but that doesn't seem
to be the approach we're taking so we have to check each coef individually.</p>
<div class="codehilite"><pre><span></span><code><span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?-poly</span><span class="w"> </span><span class="n">poly</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">x</span><span class="p">))))</span>
<span class="w">                </span><span class="no">#t</span>
<span class="w">                </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">poly</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; Make sure to install the function</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span><span class="n">=zero?-poly</span><span class="p">)</span>
</code></pre></div>

<div class="code-box">
<details class="collapsible-code">
<summary class="code-summary"><a href="code/ex2-87.rkt">code/ex2-87.rkt</a> <span class="expand-hint">(click to expand)</span></summary>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">initial</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">      </span><span class="n">initial</span>
<span class="w">      </span><span class="p">(</span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="n">op</span>
<span class="w">                      </span><span class="n">initial</span>
<span class="w">                      </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">sequence</span><span class="p">)))))</span>
<span class="c1">;; get and put definitions</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">operation-table</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">         </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">           </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)</span>
<span class="w">                           </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))))</span>
<span class="w">        </span><span class="p">(</span><span class="k">set!</span><span class="w"> </span><span class="n">operation-table</span>
<span class="w">              </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)))</span>
<span class="w">                    </span><span class="n">operation-table</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="p">)</span>
<span class="w">                </span><span class="no">#f</span><span class="p">)))</span>
<span class="w">        </span><span class="no">#f</span><span class="p">)))</span>

<span class="c1">;; Modified for ex2-78. </span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="n">contents</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: TYPE-TAG&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: CONTENTS&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type-tags</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc</span>
<span class="w">          </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="n">args</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">error</span>
<span class="w">            </span><span class="s2">&quot;No method for these types: APPLY-GENERIC&quot;</span>
<span class="w">            </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))))))</span>


<span class="c1">;; Number package</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="p">))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ======================== Rational package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">g</span><span class="w"> </span><span class="p">(</span><span class="nb">gcd</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">g</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="n">g</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>

<span class="w">  </span><span class="c1">;; z1a/z1b = z2a/z2b  iff z1a*z2b - z2a*z1b = 0</span>
<span class="w">  </span><span class="c1">;; equ? for problem 2.79</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z1</span><span class="p">)))</span>
<span class="w">        </span><span class="mi">0</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ================= Complex polar and rectangular ===================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="n">a</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ========================= Complex package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; imported procedures from rectangular </span>
<span class="w">  </span><span class="c1">;; and polar packages</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span>
<span class="w">          </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="c1">; for problem 2.79</span>
<span class="w">    </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span><span class="w"> </span><span class="c1">; Changes from problem 2.77</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>


<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polynomial-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="c1">;; representation of poly</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol?</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span>
<span class="w">        </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-term</span>
<span class="w">          </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t2</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span>
<span class="w">          </span><span class="n">t1</span>
<span class="w">          </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L</span><span class="p">))))))</span>


<span class="w">  </span><span class="c1">;; representation of terms and term lists</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">adjoin-term</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>
<span class="w">      </span><span class="n">term-list</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-term</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="n">coeff</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="n">coeff</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">term</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">term</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             ADD-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             MUL-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">      </span><span class="p">((</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">else</span>
<span class="w">       </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t1</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">                </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">                 </span><span class="n">t1</span>
<span class="w">                 </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">                            </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">           </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">             </span><span class="n">t2</span>
<span class="w">             </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">              </span><span class="n">L1</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">))))</span>
<span class="w">           </span><span class="p">(</span><span class="k">else</span>
<span class="w">            </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">             </span><span class="p">(</span><span class="n">make-term</span>
<span class="w">              </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">add</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span>
<span class="w">                   </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t2</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">)))))))))</span>
<span class="w">  </span><span class="c1">;; During construction, we don&#39;t check whether coefficients are zero</span>
<span class="w">  </span><span class="c1">;; So now, we have to check all coefficients.</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?-poly</span><span class="w"> </span><span class="n">poly</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">x</span><span class="p">))))</span>
<span class="w">                </span><span class="no">#t</span>
<span class="w">                </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">poly</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; Make sure to install the function</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span><span class="n">=zero?-poly</span><span class="p">)</span>

<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-polynomial-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">-1</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;(x^2+1)(x^2-1) = &quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">2</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">))))</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;P1 = &quot;</span><span class="p">)</span>
<span class="n">c</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;(=zero? P1)&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="n">c</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;P2 = &quot;</span><span class="p">)</span>
<span class="n">a</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;(=zero? P2)&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
</code></pre></div>


</details>
<div class="code-output">
<span>Output:</span>
<pre>done
done
done
done
done
done
(x^2+1)(x^2-1) = (polynomial x (4 1) (0 -1))
P1 = (polynomial x (2 0) (0 0))
(=zero? P1)
#t
P2 = (polynomial x (2 1) (0 1))
(=zero? P2)
#f
</pre>
</div>
</div>

<h4 id="exercise-288">Exercise 2.88</h4>
<p>Extend the polynomial system to
include subtraction of polynomials.  (Hint: You may find it helpful to define a
generic negation operation.)</p>
<h5>Solution</h5>
<p>Let's add a generic <code>'negate</code>. We do have to define negate for the other types as well.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">;; Exercise 2-88. </span>
<span class="c1">;; Inside the polynomial package.</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">    </span><span class="n">L</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">adjoin-term</span><span class="w"> </span><span class="p">(</span><span class="n">make-term</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t</span><span class="p">)))</span>
<span class="w">                   </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">r</span><span class="p">)))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                      </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">     </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">     </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">           SUB-POLY&quot;</span>
<span class="w">           </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">     </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">     </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p</span><span class="p">))))))</span>
</code></pre></div>

<p>Generic negate:</p>
<div class="codehilite"><pre><span></span><code><span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">r</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">r</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="nb">pi</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))))))</span>
</code></pre></div>

<p>Full code:</p>
<div class="code-box">
<details class="collapsible-code">
<summary class="code-summary"><a href="code/ex2-88.rkt">code/ex2-88.rkt</a> <span class="expand-hint">(click to expand)</span></summary>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="nb">pi</span><span class="w"> </span><span class="mf">3.14159</span><span class="p">)</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">initial</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">      </span><span class="n">initial</span>
<span class="w">      </span><span class="p">(</span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="n">op</span>
<span class="w">                      </span><span class="n">initial</span>
<span class="w">                      </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">sequence</span><span class="p">)))))</span>
<span class="c1">;; get and put definitions</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">operation-table</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">         </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">           </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)</span>
<span class="w">                           </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))))</span>
<span class="w">        </span><span class="p">(</span><span class="k">set!</span><span class="w"> </span><span class="n">operation-table</span>
<span class="w">              </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)))</span>
<span class="w">                    </span><span class="n">operation-table</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="p">)</span>
<span class="w">                </span><span class="no">#f</span><span class="p">)))</span>
<span class="w">        </span><span class="no">#f</span><span class="p">)))</span>

<span class="c1">;; Modified for ex2-78. </span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="n">contents</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: TYPE-TAG&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: CONTENTS&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type-tags</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc</span>
<span class="w">          </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="n">args</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">error</span>
<span class="w">            </span><span class="s2">&quot;No method for these types: APPLY-GENERIC&quot;</span>
<span class="w">            </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))))))</span>


<span class="c1">;; Number package</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="p">))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ======================== Rational package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">g</span><span class="w"> </span><span class="p">(</span><span class="nb">gcd</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">g</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="n">g</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>

<span class="w">  </span><span class="c1">;; z1a/z1b = z2a/z2b  iff z1a*z2b - z2a*z1b = 0</span>
<span class="w">  </span><span class="c1">;; equ? for problem 2.79</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z1</span><span class="p">)))</span>
<span class="w">        </span><span class="mi">0</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">r</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">r</span><span class="p">)))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ================= Complex polar and rectangular ===================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="nb">pi</span><span class="p">)))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="n">a</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ========================= Complex package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; imported procedures from rectangular </span>
<span class="w">  </span><span class="c1">;; and polar packages</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span>
<span class="w">          </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="c1">; for problem 2.79</span>
<span class="w">    </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span><span class="w"> </span><span class="c1">; Changes from problem 2.77</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>


<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polynomial-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="c1">;; representation of poly</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol?</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span>
<span class="w">        </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-term</span>
<span class="w">          </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t2</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span>
<span class="w">          </span><span class="n">t1</span>
<span class="w">          </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L</span><span class="p">))))))</span>


<span class="w">  </span><span class="c1">;; representation of terms and term lists</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">adjoin-term</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>
<span class="w">      </span><span class="n">term-list</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-term</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="n">coeff</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="n">coeff</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">term</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">term</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>


<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             ADD-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             MUL-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">      </span><span class="p">((</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">else</span>
<span class="w">       </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t1</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">                </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">                 </span><span class="n">t1</span>
<span class="w">                 </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">                            </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">           </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">             </span><span class="n">t2</span>
<span class="w">             </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">              </span><span class="n">L1</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">))))</span>
<span class="w">           </span><span class="p">(</span><span class="k">else</span>
<span class="w">            </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">             </span><span class="p">(</span><span class="n">make-term</span>
<span class="w">              </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">add</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span>
<span class="w">                   </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t2</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">)))))))))</span>
<span class="w">  </span><span class="c1">;; During construction, we don&#39;t check whether coefficients are zero</span>
<span class="w">  </span><span class="c1">;; So now, we have to check all coefficients.</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?-poly</span><span class="w"> </span><span class="n">poly</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">x</span><span class="p">))))</span>
<span class="w">                </span><span class="no">#t</span>
<span class="w">                </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">poly</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; Make sure to install the function</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span><span class="n">=zero?-poly</span><span class="p">)</span>

<span class="w">  </span><span class="c1">;; Exercise 2-88</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">      </span><span class="n">L</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="n">adjoin-term</span><span class="w"> </span><span class="p">(</span><span class="n">make-term</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t</span><span class="p">)))</span>
<span class="w">                     </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">r</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             SUB-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p</span><span class="p">))))))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-polynomial-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">-1</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;(x^2+1)+(x^2-1) = &quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;(x^2+1)-(x^2-1) = &quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
</code></pre></div>


</details>
<div class="code-output">
<span>Output:</span>
<pre>done
done
done
done
done
done
(x^2+1)+(x^2-1) = (polynomial x (2 2))
(x^2+1)-(x^2-1) = (polynomial x (0 2))
</pre>
</div>
</div>

<h4 id="exercise-289">Exercise 2.89</h4>
<p>Define procedures that implement
the term-list representation described above as appropriate for dense
polynomials.</p>
<h5>Solution</h5>
<p>Let's define an <code>install-dense-polynomial-package</code>. Some changes that have to be made are:</p>
<ul>
<li>We no longer have <code>order</code> or <code>coeff</code> functions that can be applied to each term.</li>
<li>Addition is now much simpler, but we have to rewrite multiplication</li>
</ul>
<p>First, inside <code>make-poly</code> I chop off leading zeros (we can't chop off trailing zeros):</p>
<div class="codehilite"><pre><span></span><code><span class="w">  </span><span class="c1">;; Chop off the leading zeros of a term list.</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">chop-leading-zeros</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">          </span><span class="p">((</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">L</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">chop-leading-zeros</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">L</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="n">L</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="p">(</span><span class="n">chop-leading-zeros</span><span class="w"> </span><span class="n">term-list</span><span class="p">)))</span>
</code></pre></div>

<p>Addition is somewhat simple. Note that the order of the algorithm is much worse than it needs to be 
because of my calls to <code>length</code>. There's probably some trick we can do to avoid this overhead by thinking
about tail recursive or linear recursive algorithms, but I just wanted to get this working. Also note that
<code>add-poly</code> is the same as before with no changes, it just calls the <code>add-terms</code> function.</p>
<div class="codehilite"><pre><span></span><code><span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">length1</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">length2</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">      </span><span class="c1">;; divide into cases. If L2 is longer, swap the terms</span>
<span class="w">      </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">length1</span><span class="w"> </span><span class="n">length2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">L2</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span>
<span class="w">            </span><span class="c1">;; if the lengths are equal, add term by term</span>
<span class="w">            </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">length1</span><span class="w"> </span><span class="n">length2</span><span class="p">)</span><span class="w"> </span>
<span class="w">              </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">                     </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span><span class="w"> </span>
<span class="w">                   </span><span class="n">L1</span><span class="w"> </span>
<span class="w">                   </span><span class="n">L2</span><span class="p">))</span>
<span class="w">            </span><span class="c1">;; else, shorten the longer list.</span>
<span class="w">            </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">))))))</span>
</code></pre></div>

<p>Multiplication is a bit more complicated. I define functions <code>map-indexed</code>
and <code>make-zero-terms</code>. Then, I follow the same approach as the polynomial package.
First we define (monomial) $\times$ (term list) multiplication, and then use this to 
build (term list) $\times$ (term list) multiplication.</p>
<div class="codehilite"><pre><span></span><code><span class="w">  </span><span class="c1">;; Note: this is NOT generic if we don&#39;t have type coercion. </span>
<span class="w">  </span><span class="c1">;; We could define a ((get &#39;make-zero type)) to make it generic.</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-zero-terms</span><span class="w"> </span><span class="n">l</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="n">make-zero-terms</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="mi">1</span><span class="p">)))))</span>
<span class="w">  </span><span class="c1">;; returns the term list representing </span>
<span class="w">  </span><span class="c1">;; (coeff)*(variable)^order * (polynomial represented by L)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="n">coeff</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">      </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">      </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span>
<span class="w">                     </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">coeff</span><span class="p">))</span><span class="w"> </span>
<span class="w">                   </span><span class="n">L</span><span class="p">)</span><span class="w">  </span>
<span class="w">              </span><span class="p">(</span><span class="n">make-zero-terms</span><span class="w"> </span><span class="n">order</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; Define a map-indexed function. (map-indexed f &#39;(a b c)) is</span>
<span class="w">  </span><span class="c1">;; ((f a 0) (f b 1) (f c 2))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">map-indexed</span><span class="w"> </span><span class="n">my-lambda</span><span class="w"> </span><span class="n">lst</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">map-indexed-inner</span><span class="w"> </span><span class="n">lst-cur</span><span class="w"> </span><span class="n">counter</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">lst-cur</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="n">my-lambda</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">lst-cur</span><span class="p">)</span><span class="w"> </span><span class="n">counter</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">map-indexed-inner</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">lst-cur</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="mi">1</span><span class="p">)))))</span>
<span class="w">    </span><span class="p">(</span><span class="n">map-indexed-inner</span><span class="w"> </span><span class="n">lst</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">length1</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">length2</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">length1</span><span class="w"> </span><span class="n">length2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="n">L2</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span>
<span class="w">            </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">length2</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>
<span class="w">            </span><span class="p">(</span><span class="k">else</span><span class="w"> </span>
<span class="w">              </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span>
<span class="w">                </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">Lx</span><span class="w"> </span><span class="n">Ly</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">Lx</span><span class="w"> </span><span class="n">Ly</span><span class="p">))</span>
<span class="w">                </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">                </span><span class="p">(</span><span class="n">map-indexed</span><span class="w"> </span>
<span class="w">                  </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">ctr</span><span class="p">)</span><span class="w"> </span>
<span class="w">                    </span><span class="c1">;; multiply L2 polynomial by the term x*(var)^(order).</span>
<span class="w">                    </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">length1</span><span class="w"> </span><span class="n">ctr</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">coeff</span><span class="w"> </span><span class="n">L2</span><span class="p">))</span>
<span class="w">                  </span><span class="n">L1</span><span class="p">))))))</span>
</code></pre></div>

<div class="code-box">
<details class="collapsible-code">
<summary class="code-summary"><a href="code/ex2-89.rkt">code/ex2-89.rkt</a> <span class="expand-hint">(click to expand)</span></summary>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="nb">pi</span><span class="w"> </span><span class="mf">3.14159</span><span class="p">)</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">initial</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">      </span><span class="n">initial</span>
<span class="w">      </span><span class="p">(</span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="n">op</span>
<span class="w">                      </span><span class="n">initial</span>
<span class="w">                      </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">sequence</span><span class="p">)))))</span>
<span class="c1">;; get and put definitions</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">operation-table</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">         </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">           </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)</span>
<span class="w">                           </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))))</span>
<span class="w">        </span><span class="p">(</span><span class="k">set!</span><span class="w"> </span><span class="n">operation-table</span>
<span class="w">              </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)))</span>
<span class="w">                    </span><span class="n">operation-table</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="p">)</span>
<span class="w">                </span><span class="no">#f</span><span class="p">)))</span>
<span class="w">        </span><span class="no">#f</span><span class="p">)))</span>

<span class="c1">;; Modified for ex2-78. </span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="n">contents</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: TYPE-TAG&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: CONTENTS&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type-tags</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc</span>
<span class="w">          </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="n">args</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">error</span>
<span class="w">            </span><span class="s2">&quot;No method for these types: APPLY-GENERIC&quot;</span>
<span class="w">            </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))))))</span>


<span class="c1">;; Number package</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="p">))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ======================== Rational package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">g</span><span class="w"> </span><span class="p">(</span><span class="nb">gcd</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">g</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="n">g</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>

<span class="w">  </span><span class="c1">;; z1a/z1b = z2a/z2b  iff z1a*z2b - z2a*z1b = 0</span>
<span class="w">  </span><span class="c1">;; equ? for problem 2.79</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z1</span><span class="p">)))</span>
<span class="w">        </span><span class="mi">0</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">r</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">r</span><span class="p">)))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ================= Complex polar and rectangular ===================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="nb">pi</span><span class="p">)))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="n">a</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ========================= Complex package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; imported procedures from rectangular </span>
<span class="w">  </span><span class="c1">;; and polar packages</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span>
<span class="w">          </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="c1">; for problem 2.79</span>
<span class="w">    </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span><span class="w"> </span><span class="c1">; Changes from problem 2.77</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>


<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polynomial-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="c1">;; representation of poly</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol?</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span>
<span class="w">        </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-term</span>
<span class="w">          </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t2</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span>
<span class="w">          </span><span class="n">t1</span>
<span class="w">          </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L</span><span class="p">))))))</span>


<span class="w">  </span><span class="c1">;; representation of terms and term lists</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">adjoin-term</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>
<span class="w">      </span><span class="n">term-list</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-term</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="n">coeff</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="n">coeff</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">term</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">term</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>


<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             ADD-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             MUL-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">      </span><span class="p">((</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">else</span>
<span class="w">       </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t1</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">                </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">                 </span><span class="n">t1</span>
<span class="w">                 </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">                            </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">           </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">             </span><span class="n">t2</span>
<span class="w">             </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">              </span><span class="n">L1</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">))))</span>
<span class="w">           </span><span class="p">(</span><span class="k">else</span>
<span class="w">            </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">             </span><span class="p">(</span><span class="n">make-term</span>
<span class="w">              </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">add</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span>
<span class="w">                   </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t2</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">)))))))))</span>
<span class="w">  </span><span class="c1">;; During construction, we don&#39;t check whether coefficients are zero</span>
<span class="w">  </span><span class="c1">;; So now, we have to check all coefficients.</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?-poly</span><span class="w"> </span><span class="n">poly</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">x</span><span class="p">))))</span>
<span class="w">                </span><span class="no">#t</span>
<span class="w">                </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">poly</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; Make sure to install the function</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span><span class="n">=zero?-poly</span><span class="p">)</span>

<span class="w">  </span><span class="c1">;; Exercise 2-88</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">      </span><span class="n">L</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="n">adjoin-term</span><span class="w"> </span><span class="p">(</span><span class="n">make-term</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t</span><span class="p">)))</span>
<span class="w">                     </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">r</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             SUB-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p</span><span class="p">))))))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-dense-polynomial-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="c1">;; representation of poly</span>
<span class="w">  </span><span class="c1">;; Chop off the leading zeros of a term list.</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">chop-leading-zeros</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">          </span><span class="p">((</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">L</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">chop-leading-zeros</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">L</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="n">L</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="p">(</span><span class="n">chop-leading-zeros</span><span class="w"> </span><span class="n">term-list</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol?</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)))</span>


<span class="w">  </span><span class="c1">;; Note: this is NOT generic. We could define a ((get &#39;make-zero type)) </span>
<span class="w">  </span><span class="c1">;; to make it generic.</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-zero-terms</span><span class="w"> </span><span class="n">l</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="n">make-zero-terms</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="mi">1</span><span class="p">)))))</span>
<span class="w">  </span><span class="c1">;; returns the term list representing </span>
<span class="w">  </span><span class="c1">;; (coeff)*(variable)^order * (polynomial represented by L)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="n">coeff</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">      </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">      </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span>
<span class="w">                     </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">coeff</span><span class="p">))</span><span class="w"> </span>
<span class="w">                   </span><span class="n">L</span><span class="p">)</span><span class="w">  </span>
<span class="w">              </span><span class="p">(</span><span class="n">make-zero-terms</span><span class="w"> </span><span class="n">order</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; Define a map-indexed function. (map-indexed f &#39;(a b c)) is</span>
<span class="w">  </span><span class="c1">;; ((f a 0) (f b 1) (f c 2))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">map-indexed</span><span class="w"> </span><span class="n">my-lambda</span><span class="w"> </span><span class="n">lst</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">map-indexed-inner</span><span class="w"> </span><span class="n">lst-cur</span><span class="w"> </span><span class="n">counter</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">lst-cur</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="n">my-lambda</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">lst-cur</span><span class="p">)</span><span class="w"> </span><span class="n">counter</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">map-indexed-inner</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">lst-cur</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="mi">1</span><span class="p">)))))</span>
<span class="w">    </span><span class="p">(</span><span class="n">map-indexed-inner</span><span class="w"> </span><span class="n">lst</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">length1</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">length2</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">length1</span><span class="w"> </span><span class="n">length2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="n">L2</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span>
<span class="w">            </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">length2</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>
<span class="w">            </span><span class="p">(</span><span class="k">else</span><span class="w"> </span>
<span class="w">              </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span>
<span class="w">                </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">Lx</span><span class="w"> </span><span class="n">Ly</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">Lx</span><span class="w"> </span><span class="n">Ly</span><span class="p">))</span>
<span class="w">                </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">                </span><span class="p">(</span><span class="n">map-indexed</span><span class="w"> </span>
<span class="w">                  </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">ctr</span><span class="p">)</span><span class="w"> </span>
<span class="w">                    </span><span class="c1">;; multiply L2 polynomial by the term x*(var)^(order).</span>
<span class="w">                    </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">length1</span><span class="w"> </span><span class="n">ctr</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">coeff</span><span class="w"> </span><span class="n">L2</span><span class="p">))</span>
<span class="w">                  </span><span class="n">L1</span><span class="p">))))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             MUL-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">length1</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">length2</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">length1</span><span class="w"> </span><span class="n">length2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">L2</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span>
<span class="w">            </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">length1</span><span class="w"> </span><span class="n">length2</span><span class="p">)</span><span class="w"> </span>
<span class="w">              </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">                     </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span><span class="w"> </span>
<span class="w">                   </span><span class="n">L1</span><span class="w"> </span>
<span class="w">                   </span><span class="n">L2</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">))))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             ADD-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?-poly</span><span class="w"> </span><span class="n">poly</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">                </span><span class="no">#t</span>
<span class="w">                </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">poly</span><span class="p">)))</span>


<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="n">x</span><span class="p">))</span><span class="w"> </span><span class="n">L</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             SUB-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">dense-poly</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">dense-poly</span><span class="w"> </span><span class="ss">dense-poly</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">dense-poly</span><span class="w"> </span><span class="ss">dense-poly</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">dense-poly</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">dense-poly</span><span class="w"> </span><span class="ss">dense-poly</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">dense-poly</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p</span><span class="p">))))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">dense-poly</span><span class="p">)</span><span class="w"> </span><span class="n">=zero?-poly</span><span class="p">)</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-polynomial-package</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-dense-polynomial-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-dense-polynomial</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">dense-poly</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">(</span><span class="n">make-dense-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">(</span><span class="n">make-dense-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="mi">-1</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;(x^3+x^2+x+1)+(x-1) = &quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;(x^3+x^2+x+1)*(x-1) = &quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
</code></pre></div>


</details>
<div class="code-output">
<span>Output:</span>
<pre>done
done
done
done
done
done
done
(x^3+x^2+x+1)+(x-1) = (dense-poly x 1 1 2 0)
(x^3+x^2+x+1)*(x-1) = (dense-poly x 1 0 0 0 -1)
</pre>
</div>
</div>

<h4 id="exercise-290">Exercise 2.90</h4>
<p>Suppose we want to have a
polynomial system that is efficient for both sparse and dense polynomials.  One
way to do this is to allow both kinds of term-list representations in our
system.  The situation is analogous to the complex-number example of 
2.4, where we allowed both rectangular and polar representations.  To do
this we must distinguish different types of term lists and make the operations
on term lists generic.  Redesign the polynomial system to implement this
generalization.  This is a major effort, not a local change.</p>
<h5>Solution</h5>
<p>We already have most things handled. Firstly, I renamed the tags to <code>sparse-poly</code> and <code>dense-poly</code>. 
There are six generic functions for our polynomial package:
<code>'add</code>, <code>'sub</code>, <code>'mul</code>, <code>'negate</code>, <code>'=zero?</code>, and <code>'make</code>. We should expand this into <code>'make-dense-polynomial</code> and
<code>'make-sparse-polynomial</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="n">install-sparse-polynomial-package</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-dense-polynomial-package</span><span class="p">)</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polynomial-package</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="n">p</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="n">p</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-sparse-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sparse-poly</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-dense-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">dense-poly</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">))))</span>
<span class="k">...</span><span class="p">)</span>
</code></pre></div>

<p>The only difficult remaining thing would be handling operations involving
two different types of polynomials, depending on how we've implemented type coercion.
I handle this by converting to sparse - sparse operations by default.</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">dense-poly-&gt;sparse-poly</span><span class="w"> </span><span class="n">dense</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">var</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">dense</span><span class="p">))</span><span class="w"> </span>
<span class="w">        </span><span class="p">(</span><span class="n">terms</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">dense</span><span class="p">))</span><span class="w"> </span>
<span class="w">        </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">dense</span><span class="p">))))</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sparse-poly</span><span class="p">)</span><span class="w"> </span>
<span class="w">        </span><span class="n">var</span><span class="w"> </span>
<span class="w">        </span><span class="p">(</span><span class="n">map-indexed</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">term</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">term</span><span class="p">))</span><span class="w"> </span><span class="n">terms</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">put-poly-symb</span><span class="w"> </span><span class="n">symb</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="n">symb</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span>
<span class="w">           </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t1</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">p1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">eq?</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="n">t2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">symb</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">                   </span><span class="p">((</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sparse-poly</span><span class="p">)</span>
<span class="w">                         </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">dense-poly</span><span class="p">))</span><span class="w"> </span>
<span class="w">                    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">symb</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="p">(</span><span class="n">dense-poly-&gt;sparse-poly</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">                   </span><span class="p">((</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">dense-poly</span><span class="p">)</span>
<span class="w">                         </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sparse-poly</span><span class="p">))</span><span class="w"> </span>
<span class="w">                    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">symb</span><span class="w"> </span><span class="p">(</span><span class="n">dense-poly-&gt;sparse-poly</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">p1</span><span class="p">))</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">                   </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Symbol called with polynomials of invalid types:&quot;</span><span class="w"> </span><span class="n">symb</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="n">t2</span><span class="p">))))))))</span>
<span class="p">(</span><span class="n">put-poly-symb</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="p">)</span>
<span class="p">(</span><span class="n">put-poly-symb</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="p">)</span>
<span class="p">(</span><span class="n">put-poly-symb</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="p">)</span>
</code></pre></div>

<p>Working code test:</p>
<div class="code-box">
<details class="collapsible-code">
<summary class="code-summary"><a href="code/ex2-90.rkt">code/ex2-90.rkt</a> <span class="expand-hint">(click to expand)</span></summary>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="nb">pi</span><span class="w"> </span><span class="mf">3.14159</span><span class="p">)</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">initial</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">      </span><span class="n">initial</span>
<span class="w">      </span><span class="p">(</span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="n">op</span>
<span class="w">                      </span><span class="n">initial</span>
<span class="w">                      </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">sequence</span><span class="p">)))))</span>
<span class="c1">;; Define a map-indexed function. (map-indexed f &#39;(a b c)) is</span>
<span class="c1">;; ((f a 0) (f b 1) (f c 2))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">map-indexed</span><span class="w"> </span><span class="n">my-lambda</span><span class="w"> </span><span class="n">lst</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">map-indexed-inner</span><span class="w"> </span><span class="n">lst-cur</span><span class="w"> </span><span class="n">counter</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">lst-cur</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="n">my-lambda</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">lst-cur</span><span class="p">)</span><span class="w"> </span><span class="n">counter</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">map-indexed-inner</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">lst-cur</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="mi">1</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">map-indexed-inner</span><span class="w"> </span><span class="n">lst</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="c1">;; get and put definitions</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">operation-table</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">         </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">           </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)</span>
<span class="w">                           </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))))</span>
<span class="w">        </span><span class="p">(</span><span class="k">set!</span><span class="w"> </span><span class="n">operation-table</span>
<span class="w">              </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)))</span>
<span class="w">                    </span><span class="n">operation-table</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="p">)</span>
<span class="w">                </span><span class="no">#f</span><span class="p">)))</span>
<span class="w">        </span><span class="no">#f</span><span class="p">)))</span>

<span class="c1">;; Modified for ex2-78. </span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="n">contents</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: TYPE-TAG&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: CONTENTS&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type-tags</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc</span>
<span class="w">          </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="n">args</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">error</span>
<span class="w">            </span><span class="s2">&quot;No method for these types: APPLY-GENERIC&quot;</span>
<span class="w">            </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))))))</span>


<span class="c1">;; Number package</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="p">))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ======================== Rational package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">g</span><span class="w"> </span><span class="p">(</span><span class="nb">gcd</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">g</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="n">g</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>

<span class="w">  </span><span class="c1">;; z1a/z1b = z2a/z2b  iff z1a*z2b - z2a*z1b = 0</span>
<span class="w">  </span><span class="c1">;; equ? for problem 2.79</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z1</span><span class="p">)))</span>
<span class="w">        </span><span class="mi">0</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">r</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">r</span><span class="p">)))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ================= Complex polar and rectangular ===================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="nb">pi</span><span class="p">)))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="n">a</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ========================= Complex package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; imported procedures from rectangular </span>
<span class="w">  </span><span class="c1">;; and polar packages</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span>
<span class="w">          </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="c1">; for problem 2.79</span>
<span class="w">    </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span><span class="w"> </span><span class="c1">; Changes from problem 2.77</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>


<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-sparse-polynomial-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="c1">;; representation of poly</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol?</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span>
<span class="w">        </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-term</span>
<span class="w">          </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t2</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span>
<span class="w">          </span><span class="n">t1</span>
<span class="w">          </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L</span><span class="p">))))))</span>


<span class="w">  </span><span class="c1">;; representation of terms and term lists</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">adjoin-term</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>
<span class="w">      </span><span class="n">term-list</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-term</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="n">coeff</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="n">coeff</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">term</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">term</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>


<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             ADD-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             MUL-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">      </span><span class="p">((</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">else</span>
<span class="w">       </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t1</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">                </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">                 </span><span class="n">t1</span>
<span class="w">                 </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">                            </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">           </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">             </span><span class="n">t2</span>
<span class="w">             </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">              </span><span class="n">L1</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">))))</span>
<span class="w">           </span><span class="p">(</span><span class="k">else</span>
<span class="w">            </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">             </span><span class="p">(</span><span class="n">make-term</span>
<span class="w">              </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">add</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span>
<span class="w">                   </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t2</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">)))))))))</span>
<span class="w">  </span><span class="c1">;; During construction, we don&#39;t check whether coefficients are zero</span>
<span class="w">  </span><span class="c1">;; So now, we have to check all coefficients.</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?-poly</span><span class="w"> </span><span class="n">poly</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">x</span><span class="p">))))</span>
<span class="w">                </span><span class="no">#t</span>
<span class="w">                </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">poly</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; Make sure to install the function</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">sparse-poly</span><span class="p">)</span><span class="w"> </span><span class="n">=zero?-poly</span><span class="p">)</span>

<span class="w">  </span><span class="c1">;; Exercise 2-88</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">      </span><span class="n">L</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="n">adjoin-term</span><span class="w"> </span><span class="p">(</span><span class="n">make-term</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t</span><span class="p">)))</span>
<span class="w">                     </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">r</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             SUB-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">sparse-poly</span><span class="w"> </span><span class="ss">sparse-poly</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">sparse-poly</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p</span><span class="p">))))))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sparse-poly</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">sparse-poly</span><span class="w"> </span><span class="ss">sparse-poly</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">sparse-poly</span><span class="w"> </span><span class="ss">sparse-poly</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sparse-poly</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-dense-polynomial-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="c1">;; representation of poly</span>
<span class="w">  </span><span class="c1">;; Chop off the leading zeros of a term list.</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">chop-leading-zeros</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">          </span><span class="p">((</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">L</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">chop-leading-zeros</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">L</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="n">L</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="p">(</span><span class="n">chop-leading-zeros</span><span class="w"> </span><span class="n">term-list</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol?</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)))</span>


<span class="w">  </span><span class="c1">;; Note: this is NOT generic. We could define a ((get &#39;make-zero type)) </span>
<span class="w">  </span><span class="c1">;; to make it generic.</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-zero-terms</span><span class="w"> </span><span class="n">l</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="n">make-zero-terms</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="mi">1</span><span class="p">)))))</span>
<span class="w">  </span><span class="c1">;; returns the term list representing </span>
<span class="w">  </span><span class="c1">;; (coeff)*(variable)^order * (polynomial represented by L)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="n">coeff</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">      </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">      </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span>
<span class="w">                     </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">coeff</span><span class="p">))</span><span class="w"> </span>
<span class="w">                   </span><span class="n">L</span><span class="p">)</span><span class="w">  </span>
<span class="w">              </span><span class="p">(</span><span class="n">make-zero-terms</span><span class="w"> </span><span class="n">order</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">length1</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">length2</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">length1</span><span class="w"> </span><span class="n">length2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="n">L2</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span>
<span class="w">            </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">length2</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>
<span class="w">            </span><span class="p">(</span><span class="k">else</span><span class="w"> </span>
<span class="w">              </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span>
<span class="w">                </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">Lx</span><span class="w"> </span><span class="n">Ly</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">Lx</span><span class="w"> </span><span class="n">Ly</span><span class="p">))</span>
<span class="w">                </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">                </span><span class="p">(</span><span class="n">map-indexed</span><span class="w"> </span>
<span class="w">                  </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">ctr</span><span class="p">)</span><span class="w"> </span>
<span class="w">                    </span><span class="c1">;; multiply L2 polynomial by the term x*(var)^(order).</span>
<span class="w">                    </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">length1</span><span class="w"> </span><span class="n">ctr</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">coeff</span><span class="w"> </span><span class="n">L2</span><span class="p">))</span>
<span class="w">                  </span><span class="n">L1</span><span class="p">))))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             MUL-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">length1</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">length2</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">length1</span><span class="w"> </span><span class="n">length2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">L2</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span>
<span class="w">            </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">length1</span><span class="w"> </span><span class="n">length2</span><span class="p">)</span><span class="w"> </span>
<span class="w">              </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">                     </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span><span class="w"> </span>
<span class="w">                   </span><span class="n">L1</span><span class="w"> </span>
<span class="w">                   </span><span class="n">L2</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">))))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             ADD-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?-poly</span><span class="w"> </span><span class="n">poly</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">                </span><span class="no">#t</span>
<span class="w">                </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">poly</span><span class="p">)))</span>


<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="n">x</span><span class="p">))</span><span class="w"> </span><span class="n">L</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             SUB-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">dense-poly</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">dense-poly</span><span class="w"> </span><span class="ss">dense-poly</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">dense-poly</span><span class="w"> </span><span class="ss">dense-poly</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">dense-poly</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">dense-poly</span><span class="w"> </span><span class="ss">dense-poly</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">dense-poly</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p</span><span class="p">))))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">dense-poly</span><span class="p">)</span><span class="w"> </span><span class="n">=zero?-poly</span><span class="p">)</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polynomial-package</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="n">p</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="n">p</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-sparse-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sparse-poly</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-dense-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">dense-poly</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">dense-poly-&gt;sparse-poly</span><span class="w"> </span><span class="n">dense</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">var</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">dense</span><span class="p">))</span><span class="w"> </span>
<span class="w">          </span><span class="p">(</span><span class="n">terms</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">dense</span><span class="p">))</span><span class="w"> </span>
<span class="w">          </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">dense</span><span class="p">))))</span>
<span class="w">      </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sparse-poly</span><span class="p">)</span><span class="w"> </span>
<span class="w">          </span><span class="n">var</span><span class="w"> </span>
<span class="w">          </span><span class="p">(</span><span class="n">map-indexed</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">term</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">term</span><span class="p">))</span><span class="w"> </span><span class="n">terms</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">put-poly-symb</span><span class="w"> </span><span class="n">symb</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="n">symb</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">           </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span>
<span class="w">             </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t1</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">p1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">               </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">eq?</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="n">t2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">symb</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">                     </span><span class="p">((</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sparse-poly</span><span class="p">)</span>
<span class="w">                           </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">dense-poly</span><span class="p">))</span><span class="w"> </span>
<span class="w">                      </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">symb</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="p">(</span><span class="n">dense-poly-&gt;sparse-poly</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">                     </span><span class="p">((</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">dense-poly</span><span class="p">)</span>
<span class="w">                           </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sparse-poly</span><span class="p">))</span><span class="w"> </span>
<span class="w">                      </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">symb</span><span class="w"> </span><span class="p">(</span><span class="n">dense-poly-&gt;sparse-poly</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">p1</span><span class="p">))</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">                     </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Symbol called with polynomials of invalid types:&quot;</span><span class="w"> </span><span class="n">symb</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="n">t2</span><span class="p">))))))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put-poly-symb</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put-poly-symb</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put-poly-symb</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="p">))</span>

<span class="p">(</span><span class="n">install-sparse-polynomial-package</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-dense-polynomial-package</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-polynomial-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-dense-polynomial</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-dense-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-sparse-polynomial</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-sparse-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">(</span><span class="n">make-dense-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">(</span><span class="n">make-dense-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="mi">-1</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="p">(</span><span class="n">make-sparse-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">3</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="p">(</span><span class="n">make-sparse-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">-1</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;dense-dense (x^3+x^2+x+1)+(x-1) = &quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;dense-dense (x^3+x^2+x+1)*(x-1) = &quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>

<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;sparse-sparse (x^3+x^2+x+1)+(x-1) = &quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;sparse-sparse (x^3+x^2+x+1)*(x-1) = &quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>

<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;dense-sparse (x^3+x^2+x+1)+(x-1) = &quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;sparse-dense (x^3+x^2+x+1)*(x-1) = &quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
</code></pre></div>


</details>
<div class="code-output">
<span>Output:</span>
<pre>done
done
done
done
done
done
done
dense-dense (x^3+x^2+x+1)+(x-1) = (polynomial dense-poly x 1 1 2 0)
dense-dense (x^3+x^2+x+1)*(x-1) = (polynomial dense-poly x 1 0 0 0 -1)
sparse-sparse (x^3+x^2+x+1)+(x-1) = (polynomial sparse-poly x (3 1) (2 1) (1 2))
sparse-sparse (x^3+x^2+x+1)*(x-1) = (polynomial sparse-poly x (4 1) (0 -1))
dense-sparse (x^3+x^2+x+1)+(x-1) = (polynomial sparse-poly x (3 1) (2 1) (1 2))
sparse-dense (x^3+x^2+x+1)*(x-1) = (polynomial sparse-poly x (4 1) (0 -1))
</pre>
</div>
</div>

<h4 id="exercise-291">Exercise 2.91</h4>
<p>A univariate polynomial can be
divided by another one to produce a polynomial quotient and a polynomial
remainder.  For example,</p>
<p>$${x^5 - 1 \over x^2 - 1} \,=\, {x^3 + x,} \text{  remainder  } {x - 1.}  $$</p>
<p>Division can be performed via long division.  That is, divide the highest-order
term of the dividend by the highest-order term of the divisor.  The result is
the first term of the quotient.  Next, multiply the result by the divisor,
subtract that from the dividend, and produce the rest of the answer by
recursively dividing the difference by the divisor.  Stop when the order of the
divisor exceeds the order of the dividend and declare the dividend to be the
remainder.  Also, if the dividend ever becomes zero, return zero as both
quotient and remainder.</p>
<p>We can design a <code>div-poly</code> procedure on the model of <code>add-poly</code> and
<code>mul-poly</code>. The procedure checks to see if the two polys have the same
variable.  If so, <code>div-poly</code> strips off the variable and passes the
problem to <code>div-terms</code>, which performs the division operation on term
lists. <code>Div-poly</code> finally reattaches the variable to the result supplied
by <code>div-terms</code>.  It is convenient to design <code>div-terms</code> to compute
both the quotient and the remainder of a division.  <code>Div-terms</code> can take
two term lists as arguments and return a list of the quotient term list and the
remainder term list.</p>
<p>Complete the following definition of <code>div-terms</code> by filling in the missing
expressions.  Use this to implement <code>div-poly</code>, which takes two polys as
arguments and returns a list of the quotient and remainder polys.</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span><span class="w"> </span>
<span class="w">            </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t1</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">new-c</span><span class="w"> </span><span class="p">(</span><span class="n">div</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span>
<span class="w">                              </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t2</span><span class="p">)))</span>
<span class="w">                  </span><span class="p">(</span><span class="n">new-o</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span>
<span class="w">                            </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))))</span>
<span class="w">              </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">rest-of-result</span>
<span class="w">                     </span><span class="n">⟨compute</span><span class="w"> </span><span class="nb">rest</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="n">recursively</span><span class="p">}</span><span class="n">⟩</span><span class="w"> </span><span class="p">))</span>
<span class="w">                </span><span class="n">⟨form</span><span class="w"> </span><span class="n">complete</span><span class="w"> </span><span class="n">result⟩</span><span class="w"> </span><span class="p">)))))</span><span class="err">)</span>
</code></pre></div>

<h5>Solution</h5>
<p>Given the new term $t$, we have:</p>
<p>$$\frac{P_1}{P_2} =\frac{P_1- t P_2+t P_2}{P_2} = t + \frac{P_1-t P_2}{P_2}$$
And the whole idea behind long division is to choose $t$ so that the leading term of $P_1$ cancels.
I do this subtraction using the function <code>sub-terms</code> which I defined in problem 2.88.</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span><span class="w"> </span>
<span class="w">            </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t1</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">new-c</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span>
<span class="w">                                             </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t2</span><span class="p">)))</span>
<span class="w">                  </span><span class="p">(</span><span class="n">new-o</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span>
<span class="w">                            </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))))</span>
<span class="w">              </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">new-t</span><span class="w"> </span><span class="p">(</span><span class="n">make-term</span><span class="w"> </span><span class="n">new-o</span><span class="w"> </span><span class="n">new-c</span><span class="p">)))</span>
<span class="w">                </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">rest-of-result</span>
<span class="w">                       </span><span class="p">(</span><span class="n">div-terms</span><span class="w"> </span>
<span class="w">                         </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span><span class="w"> </span><span class="n">new-t</span><span class="w"> </span><span class="n">L2</span><span class="p">))</span><span class="w"> </span>
<span class="w">                         </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">                  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">div-val</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">rest-of-result</span><span class="p">))</span>
<span class="w">                        </span><span class="p">(</span><span class="n">rem-val</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">rest-of-result</span><span class="p">)))</span>
<span class="w">                    </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">new-t</span><span class="p">)</span><span class="w"> </span><span class="n">div-val</span><span class="p">)</span>
<span class="w">                          </span><span class="n">rem-val</span><span class="p">)))))))))</span>
</code></pre></div>

<p>Also, in order to do the plumbing for everything, I define </p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                      </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">res</span><span class="w"> </span><span class="p">(</span><span class="n">div-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">       </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">res</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">res</span><span class="p">))))</span>
<span class="w">    </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">           SUB-POLY&quot;</span>
<span class="w">           </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div-poly</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">res</span><span class="w"> </span><span class="p">(</span><span class="n">div-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">res</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">res</span><span class="p">))))))</span>
</code></pre></div>

<div class="code-box">
<details class="collapsible-code">
<summary class="code-summary"><a href="code/ex2-91.rkt">code/ex2-91.rkt</a> <span class="expand-hint">(click to expand)</span></summary>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="nb">pi</span><span class="w"> </span><span class="mf">3.14159</span><span class="p">)</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">initial</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">      </span><span class="n">initial</span>
<span class="w">      </span><span class="p">(</span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="n">op</span>
<span class="w">                      </span><span class="n">initial</span>
<span class="w">                      </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">sequence</span><span class="p">)))))</span>
<span class="c1">;; get and put definitions</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">operation-table</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">         </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">           </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)</span>
<span class="w">                           </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))))</span>
<span class="w">        </span><span class="p">(</span><span class="k">set!</span><span class="w"> </span><span class="n">operation-table</span>
<span class="w">              </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)))</span>
<span class="w">                    </span><span class="n">operation-table</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="p">)</span>
<span class="w">                </span><span class="no">#f</span><span class="p">)))</span>
<span class="w">        </span><span class="no">#f</span><span class="p">)))</span>

<span class="c1">;; Modified for ex2-78. </span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="n">contents</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: TYPE-TAG&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: CONTENTS&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type-tags</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc</span>
<span class="w">          </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="n">args</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">error</span>
<span class="w">            </span><span class="s2">&quot;No method for these types: APPLY-GENERIC&quot;</span>
<span class="w">            </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))))))</span>


<span class="c1">;; Number package</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="p">))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ======================== Rational package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">g</span><span class="w"> </span><span class="p">(</span><span class="nb">gcd</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">g</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="n">g</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>

<span class="w">  </span><span class="c1">;; z1a/z1b = z2a/z2b  iff z1a*z2b - z2a*z1b = 0</span>
<span class="w">  </span><span class="c1">;; equ? for problem 2.79</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z1</span><span class="p">)))</span>
<span class="w">        </span><span class="mi">0</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">r</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">r</span><span class="p">)))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ================= Complex polar and rectangular ===================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="nb">pi</span><span class="p">)))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="n">a</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ========================= Complex package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; imported procedures from rectangular </span>
<span class="w">  </span><span class="c1">;; and polar packages</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span>
<span class="w">          </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="c1">; for problem 2.79</span>
<span class="w">    </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span><span class="w"> </span><span class="c1">; Changes from problem 2.77</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>


<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polynomial-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="c1">;; representation of poly</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol?</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span>
<span class="w">        </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-term</span>
<span class="w">          </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t2</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span>
<span class="w">          </span><span class="n">t1</span>
<span class="w">          </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L</span><span class="p">))))))</span>


<span class="w">  </span><span class="c1">;; representation of terms and term lists</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">adjoin-term</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>
<span class="w">      </span><span class="n">term-list</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-term</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="n">coeff</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="n">coeff</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">term</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">term</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>


<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             ADD-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             MUL-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">      </span><span class="p">((</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">else</span>
<span class="w">       </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t1</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">                </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">                 </span><span class="n">t1</span>
<span class="w">                 </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">                            </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">           </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">             </span><span class="n">t2</span>
<span class="w">             </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">              </span><span class="n">L1</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">))))</span>
<span class="w">           </span><span class="p">(</span><span class="k">else</span>
<span class="w">            </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">             </span><span class="p">(</span><span class="n">make-term</span>
<span class="w">              </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">add</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span>
<span class="w">                   </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t2</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">)))))))))</span>

<span class="c1">;; (ct1 x^(ot1)+rest1)/(ct2 x^(ot2)+rest2) </span>
<span class="c1">;; =(poly1 - (ct1/ct2) x^(ot1-ot2)(poly2) + (ct1/ct2) x^(ot1-ot2)(poly2))/(poly2)</span>
<span class="c1">;; =(ct1/ct2) x^(ot1-ot2) + (poly1 - (ct1/ct2) x^(ot1-ot2)(poly2))/poly2</span>


<span class="w">  </span><span class="c1">;; During construction, we don&#39;t check whether coefficients are zero</span>
<span class="w">  </span><span class="c1">;; So now, we have to check all coefficients.</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?-poly</span><span class="w"> </span><span class="n">poly</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">x</span><span class="p">))))</span>
<span class="w">                </span><span class="no">#t</span>
<span class="w">                </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">poly</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; Make sure to install the function</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span><span class="n">=zero?-poly</span><span class="p">)</span>

<span class="w">  </span><span class="c1">;; Exercise 2-88</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">      </span><span class="n">L</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="n">adjoin-term</span><span class="w"> </span><span class="p">(</span><span class="n">make-term</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t</span><span class="p">)))</span>
<span class="w">                     </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">r</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             SUB-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span><span class="w"> </span>
<span class="w">              </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t1</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">new-c</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span>
<span class="w">                                               </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t2</span><span class="p">)))</span>
<span class="w">                    </span><span class="p">(</span><span class="n">new-o</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span>
<span class="w">                              </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))))</span>
<span class="w">                </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">new-t</span><span class="w"> </span><span class="p">(</span><span class="n">make-term</span><span class="w"> </span><span class="n">new-o</span><span class="w"> </span><span class="n">new-c</span><span class="p">)))</span>
<span class="w">                  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">rest-of-result</span>
<span class="w">                         </span><span class="p">(</span><span class="n">div-terms</span><span class="w"> </span>
<span class="w">                           </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span><span class="w"> </span><span class="n">new-t</span><span class="w"> </span><span class="n">L2</span><span class="p">))</span><span class="w"> </span>
<span class="w">                           </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">                    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">div-val</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">rest-of-result</span><span class="p">))</span>
<span class="w">                          </span><span class="p">(</span><span class="n">rem-val</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">rest-of-result</span><span class="p">)))</span>
<span class="w">                      </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">new-t</span><span class="p">)</span><span class="w"> </span><span class="n">div-val</span><span class="p">)</span>
<span class="w">                            </span><span class="n">rem-val</span><span class="p">)))))))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">res</span><span class="w"> </span><span class="p">(</span><span class="n">div-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">         </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">res</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">res</span><span class="p">))))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             SUB-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div-poly</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">res</span><span class="w"> </span><span class="p">(</span><span class="n">div-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">           </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">res</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">res</span><span class="p">))))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p</span><span class="p">))))))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-polynomial-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">5</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">-1</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">-1</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">-1</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;(x^5-1)/(x^2-1) = &quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div-poly</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;(x^5-1)/(x-1) = &quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div-poly</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">c</span><span class="p">)</span>
</code></pre></div>


</details>
<div class="code-output">
<span>Output:</span>
<pre>done
done
done
done
done
done
(x^5-1)/(x^2-1) = ((polynomial x (3 1) (1 1)) (polynomial x (1 1) (0 -1)))
(x^5-1)/(x-1) = ((polynomial x (4 1) (3 1) (2 1) (1 1) (0 1)) (polynomial x))
</pre>
</div>
</div>

<h4 id="exercise-292">Exercise 2.92</h4>
<p>By imposing an ordering on
variables, extend the polynomial package so that addition and multiplication of
polynomials works for polynomials in different variables.  (This is not easy!)</p>
<h5>Solution</h5>
<p>We have a few different options here:</p>
<ul>
<li>We could have a <code>set</code> of monomials. </li>
<li>We could replace <code>variables</code> with <code>variable-list</code> and use the ordering imposed by that list.</li>
<li>We could define a lexicographic ordering over symbols and monomials.</li>
</ul>
<p>I'm going with the third option. The monomial $C x^a y^b$ 
will be represented as <code>(list (list (list 'x a) (list 'y b)) C)</code>. So now, <code>(coeff term)</code> still behaves the same,
but <code>(order term)</code> gives the order of the lits of variables.</p>
<p>First, let's make sure I can define the ordering on monomials properly:</p>
<div class="code-box">
<details class="collapsible-code" open>
<summary class="code-summary"><a href="code/ex2-92b.rkt">code/ex2-92b.rkt</a> <span class="expand-hint">(click to expand)</span></summary>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="c1">;; insertion sort from https://gist.github.com/miyukino/5652107</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">insert</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="n">comp</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="n">M</span>
<span class="w">        </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">M</span><span class="p">)</span><span class="w"> </span><span class="n">L</span>
<span class="w">            </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">comp</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">M</span><span class="p">))</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">insert</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="n">comp</span><span class="p">))</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">M</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">insert</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">M</span><span class="p">)</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="n">comp</span><span class="p">))))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">insertionsort</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="n">comp</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">        </span><span class="p">(</span><span class="n">insert</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">L</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">insertionsort</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="n">comp</span><span class="p">)</span><span class="w"> </span><span class="n">comp</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="nb">sort</span><span class="w"> </span><span class="n">insertionsort</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol&lt;?</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="n">s2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">string&lt;?</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol-&gt;string</span><span class="w"> </span><span class="n">s1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol-&gt;string</span><span class="w"> </span><span class="n">s2</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol=?</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="n">s2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">string=?</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol-&gt;string</span><span class="w"> </span><span class="n">s1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol-&gt;string</span><span class="w"> </span><span class="n">s2</span><span class="p">)))</span>

<span class="c1">;; Lexicographic ordering on monomials. If we want the highest order monomial as the first element, we </span>
<span class="c1">;; could sort from least to greatest where we define &#39;() to be the greatest element, so this definition</span>
<span class="c1">;; might look a bit backwards.</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">single-order&lt;?</span><span class="w"> </span><span class="n">so1</span><span class="w"> </span><span class="n">so2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol&lt;?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">so1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">so2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">so2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">so1</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">order&lt;?</span><span class="w"> </span><span class="n">o1</span><span class="w"> </span><span class="n">o2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span>
<span class="w">    </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">o1</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">o2</span><span class="p">)</span><span class="w"> </span><span class="no">#t</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">o2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">o1</span><span class="p">))</span><span class="w"> </span><span class="no">#t</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">single-order&lt;?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">o1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">o2</span><span class="p">))</span><span class="w"> </span><span class="no">#t</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">single-order&lt;?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">o2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">o1</span><span class="p">))</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">order&lt;?</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">o1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">o2</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">l1</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="ss">x</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">y</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">l2</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="ss">x</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">y</span><span class="w"> </span><span class="mi">2</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">l3</span><span class="w"> </span><span class="p">(</span><span class="nb">sort</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="ss">x</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">y</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">foobar</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="n">single-order&lt;?</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">l4</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>
<span class="p">(</span><span class="nb">sort</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">l1</span><span class="w"> </span><span class="n">l2</span><span class="w"> </span><span class="n">l3</span><span class="w"> </span><span class="n">l4</span><span class="p">)</span><span class="w">  </span><span class="n">order&lt;?</span><span class="p">)</span>
</code></pre></div>


</details>
<div class="code-output">
<span>Output:</span>
<pre>(((foobar 10) (a 4) (x 2) (y 2)) ((x 2) (y 2)) ((x 2) (y 1)) ())
</pre>
</div>
</div>

<p>Next, we can define a function to create a correct polynomial from a 
unsorted list of monomials (unsorted because I can never remember the 
correct way to do things). </p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polynomial-package</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">single-order&lt;?</span><span class="w"> </span><span class="n">so1</span><span class="w"> </span><span class="n">so2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol&lt;?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">so1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">so2</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">so2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">so1</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">order&lt;?</span><span class="w"> </span><span class="n">o1</span><span class="w"> </span><span class="n">o2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span>
<span class="w">      </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">o1</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">      </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">o2</span><span class="p">)</span><span class="w"> </span><span class="no">#t</span><span class="p">)</span>
<span class="w">      </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">o2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">o1</span><span class="p">))</span><span class="w"> </span><span class="no">#t</span><span class="p">)</span>
<span class="w">      </span><span class="p">((</span><span class="n">single-order&lt;?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">o1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">o2</span><span class="p">))</span><span class="w"> </span><span class="no">#t</span><span class="p">)</span>
<span class="w">      </span><span class="p">((</span><span class="n">single-order&lt;?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">o2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">o1</span><span class="p">))</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">order&lt;?</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">o1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">o2</span><span class="p">)))))</span>

<span class="w">  </span><span class="c1">;; Term list should be a list of (list coeff monomial)</span>
<span class="w">  </span><span class="c1">;; monomial is of the form &#39;((x 3) (y 2) (z 4)) to represent x^3*y^2*z^4.</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-mono</span><span class="w"> </span><span class="n">coeff</span><span class="w"> </span><span class="n">order</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">coeff</span><span class="w"> </span><span class="n">order</span><span class="p">))</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">mono</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">mono</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">mono</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">mono</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly-from-unsorted</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sort-monomial</span><span class="w"> </span><span class="n">mono</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="p">(</span><span class="n">make-mono</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">mono</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">sort</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">mono</span><span class="p">)</span><span class="w"> </span><span class="n">single-order&lt;?</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">monomial-compare</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="p">(</span><span class="n">order&lt;?</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nb">sort</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">sort-monomial</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span><span class="w"> </span><span class="n">monomial-compare</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">terms</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly-from-unsorted</span><span class="w"> </span><span class="n">terms</span><span class="p">))))</span>
<span class="w">  </span><span class="k">...</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
</code></pre></div>

<p>Now, <code>add-poly</code> is going to be basically the same as add-terms, 
except instead of <code>&lt;</code> to compare orders, we'll have to use <code>order&lt;?</code>. 
We'll also have to define <code>adjoin-term</code> correctly.
<code>negate</code> and <code>sub</code> are easy. </p>
<p>Testing some polynomial multiplication examples:</p>
<div class="code-box">
<details class="collapsible-code">
<summary class="code-summary"><a href="code/ex2-92.rkt">code/ex2-92.rkt</a> <span class="expand-hint">(click to expand)</span></summary>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="c1">;; insertion sort from https://gist.github.com/miyukino/5652107</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">insert</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="n">comp</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="n">M</span>
<span class="w">        </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">M</span><span class="p">)</span><span class="w"> </span><span class="n">L</span>
<span class="w">            </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">comp</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">M</span><span class="p">))</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">insert</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="n">comp</span><span class="p">))</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">M</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">insert</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">M</span><span class="p">)</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="n">comp</span><span class="p">))))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">insertionsort</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="n">comp</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">        </span><span class="p">(</span><span class="n">insert</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">L</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">insertionsort</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="n">comp</span><span class="p">)</span><span class="w"> </span><span class="n">comp</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="nb">sort</span><span class="w"> </span><span class="n">insertionsort</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol&lt;?</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="n">s2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">string&lt;?</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol-&gt;string</span><span class="w"> </span><span class="n">s1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol-&gt;string</span><span class="w"> </span><span class="n">s2</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol=?</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="n">s2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">string=?</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol-&gt;string</span><span class="w"> </span><span class="n">s1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol-&gt;string</span><span class="w"> </span><span class="n">s2</span><span class="p">)))</span>



<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="nb">pi</span><span class="w"> </span><span class="mf">3.14159</span><span class="p">)</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">initial</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">      </span><span class="n">initial</span>
<span class="w">      </span><span class="p">(</span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="n">op</span>
<span class="w">                      </span><span class="n">initial</span>
<span class="w">                      </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">sequence</span><span class="p">)))))</span>
<span class="c1">;; get and put definitions</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">operation-table</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">         </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">           </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)</span>
<span class="w">                           </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))))</span>
<span class="w">        </span><span class="p">(</span><span class="k">set!</span><span class="w"> </span><span class="n">operation-table</span>
<span class="w">              </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)))</span>
<span class="w">                    </span><span class="n">operation-table</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="p">)</span>
<span class="w">                </span><span class="no">#f</span><span class="p">)))</span>
<span class="w">        </span><span class="no">#f</span><span class="p">)))</span>

<span class="c1">;; Modified for ex2-78. </span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="n">contents</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: TYPE-TAG&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: CONTENTS&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type-tags</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc</span>
<span class="w">          </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="n">args</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">error</span>
<span class="w">            </span><span class="s2">&quot;No method for these types: APPLY-GENERIC&quot;</span>
<span class="w">            </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))))))</span>


<span class="c1">;; Number package</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="p">))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ======================== Rational package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">g</span><span class="w"> </span><span class="p">(</span><span class="nb">gcd</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">g</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="n">g</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>

<span class="w">  </span><span class="c1">;; z1a/z1b = z2a/z2b  iff z1a*z2b - z2a*z1b = 0</span>
<span class="w">  </span><span class="c1">;; equ? for problem 2.79</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z1</span><span class="p">)))</span>
<span class="w">        </span><span class="mi">0</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">r</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">r</span><span class="p">)))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ================= Complex polar and rectangular ===================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="nb">pi</span><span class="p">)))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="n">a</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ========================= Complex package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; imported procedures from rectangular </span>
<span class="w">  </span><span class="c1">;; and polar packages</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span>
<span class="w">          </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="c1">; for problem 2.79</span>
<span class="w">    </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span><span class="w"> </span><span class="c1">; Changes from problem 2.77</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>


<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polynomial-package</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">single-order&lt;?</span><span class="w"> </span><span class="n">so1</span><span class="w"> </span><span class="n">so2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol&lt;?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">so1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">so2</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">so2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">so1</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">order&lt;?</span><span class="w"> </span><span class="n">o1</span><span class="w"> </span><span class="n">o2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span>
<span class="w">      </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">o1</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">      </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">o2</span><span class="p">)</span><span class="w"> </span><span class="no">#t</span><span class="p">)</span>
<span class="w">      </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">o2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">o1</span><span class="p">))</span><span class="w"> </span><span class="no">#t</span><span class="p">)</span>
<span class="w">      </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">o1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">o2</span><span class="p">))</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">      </span><span class="p">((</span><span class="n">single-order&lt;?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">o1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">o2</span><span class="p">))</span><span class="w"> </span><span class="no">#t</span><span class="p">)</span>
<span class="w">      </span><span class="p">((</span><span class="n">single-order&lt;?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">o2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">o1</span><span class="p">))</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">order&lt;?</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">o1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">o2</span><span class="p">)))))</span>

<span class="w">  </span><span class="c1">;; Term list should be a list of (list coeff monomial)</span>
<span class="w">  </span><span class="c1">;; monomial is of the form &#39;((x 3) (y 2) (z 4)) to represent x^3*y^2*z^4.</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-mono</span><span class="w"> </span><span class="n">coeff</span><span class="w"> </span><span class="n">order</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">coeff</span><span class="w"> </span><span class="n">order</span><span class="p">))</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">mono</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">mono</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">mono</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">mono</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly-from-unsorted</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sort-monomial</span><span class="w"> </span><span class="n">mono</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="p">(</span><span class="n">make-mono</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">mono</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">sort</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">mono</span><span class="p">)</span><span class="w"> </span><span class="n">single-order&lt;?</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">monomial-compare</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="p">(</span><span class="n">order&lt;?</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nb">sort</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">sort-monomial</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span><span class="w"> </span><span class="n">monomial-compare</span><span class="p">))</span>




<span class="w">  </span><span class="c1">;; negate</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">negate</span><span class="w"> </span><span class="n">polynomial</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">mono</span><span class="p">)</span><span class="w"> </span>
<span class="w">           </span><span class="p">(</span><span class="n">make-mono</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">mono</span><span class="p">))</span><span class="w"> </span>
<span class="w">                      </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">mono</span><span class="p">)))</span><span class="w"> </span><span class="n">polynomial</span><span class="p">))</span>


<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">empty-polynomial?</span><span class="w"> </span><span class="n">poly</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">poly</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">first-monomial</span><span class="w"> </span><span class="n">poly</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">poly</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">rest-monomials</span><span class="w"> </span><span class="n">poly</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">poly</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">adjoin-term</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="n">polynomial</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>
<span class="w">      </span><span class="n">polynomial</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="n">polynomial</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; add-poly</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-polys</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span>
<span class="w">      </span><span class="p">((</span><span class="n">empty-polynomial?</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">      </span><span class="p">((</span><span class="n">empty-polynomial?</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">else</span>
<span class="w">       </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t1</span><span class="w"> </span><span class="p">(</span><span class="n">first-monomial</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">first-monomial</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span>
<span class="w">           </span><span class="p">((</span><span class="n">order&lt;?</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">             </span><span class="n">t1</span>
<span class="w">             </span><span class="p">(</span><span class="n">add-polys</span><span class="w"> </span><span class="p">(</span><span class="n">rest-monomials</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">                        </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">           </span><span class="p">((</span><span class="n">order&lt;?</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">             </span><span class="n">t2</span>
<span class="w">             </span><span class="p">(</span><span class="n">add-polys</span>
<span class="w">              </span><span class="n">L1</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-monomials</span><span class="w"> </span><span class="n">L2</span><span class="p">))))</span>
<span class="w">           </span><span class="p">(</span><span class="k">else</span>
<span class="w">            </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">             </span><span class="p">(</span><span class="n">make-mono</span>
<span class="w">  </span><span class="c1">;(define (make-mono coeff order) (list coeff order)) </span>
<span class="w">              </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span>
<span class="w">                                  </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span><span class="w"> </span>
<span class="w">              </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">add-polys</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-monomials</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-monomials</span><span class="w"> </span><span class="n">L2</span><span class="p">)))))))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-polys</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">add-polys</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="p">(</span><span class="nb">negate</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>


<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">adjoin-order</span><span class="w"> </span><span class="n">single-order</span><span class="w"> </span><span class="n">order</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">single-order</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="n">order</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">single-order</span><span class="w"> </span><span class="n">order</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-orders</span><span class="w"> </span><span class="n">o1</span><span class="w"> </span><span class="n">o2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span>
<span class="w">      </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">o1</span><span class="p">)</span><span class="w"> </span><span class="n">o2</span><span class="p">)</span>
<span class="w">      </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">o2</span><span class="p">)</span><span class="w"> </span><span class="n">o1</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">else</span>
<span class="w">       </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">so1</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">o1</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">so2</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">o2</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="k">cond</span>
<span class="w">           </span><span class="p">((</span><span class="nb">symbol&lt;?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">so1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">so2</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="n">adjoin-order</span>
<span class="w">             </span><span class="n">so1</span>
<span class="w">             </span><span class="p">(</span><span class="n">add-orders</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">o1</span><span class="p">)</span>
<span class="w">                          </span><span class="n">o2</span><span class="p">)))</span>
<span class="w">           </span><span class="p">((</span><span class="nb">symbol&lt;?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">so2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">so1</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="n">adjoin-order</span>
<span class="w">             </span><span class="n">so2</span>
<span class="w">             </span><span class="p">(</span><span class="n">add-orders</span>
<span class="w">              </span><span class="n">o1</span>
<span class="w">              </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">o2</span><span class="p">))))</span>
<span class="w">           </span><span class="p">(</span><span class="k">else</span>
<span class="w">            </span><span class="p">(</span><span class="n">adjoin-order</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span>
<span class="w">              </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">so1</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">so1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">so2</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="n">add-orders</span>
<span class="w">              </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">o1</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">o2</span><span class="p">)))))))))</span>
<span class="w">  </span><span class="c1">;; mul-poly</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-mono-by-poly</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="n">P</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-mono-by-poly-inner</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="n">P</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-polynomial?</span><span class="w"> </span><span class="n">P</span><span class="p">)</span>
<span class="w">        </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">m2</span><span class="w"> </span><span class="p">(</span><span class="n">first-monomial</span><span class="w"> </span><span class="n">P</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">           </span><span class="p">(</span><span class="n">make-mono</span>
<span class="w">            </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">m1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">m2</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="n">add-orders</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">m1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">m2</span><span class="p">)))</span>
<span class="w">           </span><span class="c1">;; If m2 &lt; m3, does m1*m2 &lt; m1*m3? </span>
<span class="w">           </span><span class="c1">;; NO! </span>
<span class="w">           </span><span class="c1">;; &#39;((a 3)) &lt; &#39;((b 3))  &lt;-- true</span>
<span class="w">           </span><span class="c1">;; &#39;((a 3)) * &#39;((a 1)) = &#39;((a 4))</span>
<span class="w">           </span><span class="c1">;; &#39;((b 3)) * &#39;((a 1)) = &#39;((a 1) (b 3))</span>
<span class="w">           </span><span class="c1">;; So with my definition, &#39;((a 1) (b 3)) &lt; &#39;((a 4))</span>
<span class="w">           </span><span class="c1">;; Therefore, we need to make sure we sort the result.</span>
<span class="w">           </span><span class="p">(</span><span class="n">mul-mono-by-poly-inner</span>
<span class="w">            </span><span class="n">m1</span>
<span class="w">            </span><span class="p">(</span><span class="n">rest-monomials</span><span class="w"> </span><span class="n">P</span><span class="p">))))))</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-poly-from-unsorted</span><span class="w"> </span><span class="p">(</span><span class="n">mul-mono-by-poly-inner</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="n">P</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-polys</span><span class="w"> </span><span class="n">P1</span><span class="w"> </span><span class="n">P2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-polynomial?</span><span class="w"> </span><span class="n">P1</span><span class="p">)</span>
<span class="w">      </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">      </span><span class="p">(</span><span class="n">add-polys</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-mono-by-poly</span>
<span class="w">        </span><span class="p">(</span><span class="n">first-monomial</span><span class="w"> </span><span class="n">P1</span><span class="p">)</span><span class="w"> </span><span class="n">P2</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-polys</span><span class="w"> </span><span class="p">(</span><span class="n">rest-monomials</span><span class="w"> </span><span class="n">P1</span><span class="p">)</span><span class="w"> </span><span class="n">P2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">terms</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly-from-unsorted</span><span class="w"> </span><span class="n">terms</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">negate</span><span class="w"> </span><span class="n">p</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-polys</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-polys</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-polys</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-polynomial-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="n">terms</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span><span class="n">terms</span><span class="p">))</span>


<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">l1</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="ss">x</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">y</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">l2</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="ss">x</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">y</span><span class="w"> </span><span class="mi">2</span><span class="p">)))</span>
<span class="c1">;;(define l3 (sort &#39;((x 2) (y 2) (b 10) (a 4)) single-order&lt;?))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">l3</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="ss">x</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">y</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">b</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="mi">4</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">l4</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">l1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="n">l2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">l3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="mi">-10</span><span class="w"> </span><span class="n">l4</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="n">p1</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">p3</span><span class="w"> </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">1</span><span class="w"> </span><span class="p">((</span><span class="ss">x</span><span class="w"> </span><span class="mi">3</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="p">((</span><span class="ss">x</span><span class="w"> </span><span class="mi">1</span><span class="p">))))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">p4</span><span class="w"> </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">1</span><span class="w"> </span><span class="p">((</span><span class="ss">x</span><span class="w"> </span><span class="mi">2</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="p">())</span><span class="w"> </span><span class="p">(</span><span class="mi">-1</span><span class="w"> </span><span class="p">((</span><span class="ss">y</span><span class="w"> </span><span class="mi">1</span><span class="p">))))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">p5</span><span class="w"> </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">1</span><span class="w"> </span><span class="p">((</span><span class="ss">x</span><span class="w"> </span><span class="mi">4</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="p">((</span><span class="ss">x</span><span class="w"> </span><span class="mi">3</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="p">((</span><span class="ss">x</span><span class="w"> </span><span class="mi">2</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="p">((</span><span class="ss">x</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="p">()))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">p6</span><span class="w"> </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">1</span><span class="w"> </span><span class="p">((</span><span class="ss">x</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="mi">-1</span><span class="w"> </span><span class="p">()))))</span>
<span class="c1">;;p1</span>
<span class="c1">;;p2</span>
<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p3</span><span class="p">)</span>
<span class="c1">;;(apply-generic &#39;add p1 p1)</span>
<span class="c1">;;(apply-generic &#39;add p1 p1)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;(x^3+x)(x^2-y+1) = -x^3y -xy + x^5 + 2x^3 + x^2 + x&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="n">p3</span><span class="w"> </span><span class="n">p4</span><span class="p">)</span>
<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;(x^4+x^3+x^2+x+1)(x-1) = x^5 - 1&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="n">p5</span><span class="w"> </span><span class="n">p6</span><span class="p">)</span>
</code></pre></div>


</details>
<div class="code-output">
<span>Output:</span>
<pre>done
done
done
done
done
done
(polynomial (3 ((b 10) (a 4) (x 2) (y 2))) (-1 ((x 2) (y 2))) (1 ((x 2) (y 1))) (1 ((x 3))) (1 ((x 1))) (-10 ()))
(x^3+x)(x^2-y+1) = -x^3y -xy + x^5 + 2x^3 + x^2 + x
(polynomial (-1 ((x 3) (y 1))) (-1 ((x 1) (y 1))) (1 ((x 5))) (2 ((x 3))) (1 ((x 1))))
(x^4+x^3+x^2+x+1)(x-1) = x^5 - 1
(polynomial (1 ((x 5))) (-1 ()))
</pre>
</div>
</div>

<h4 id="exercise-293">Exercise 2.93</h4>
<p>Modify the rational-arithmetic
package to use generic operations, but change <code>make-rat</code> so that it does
not attempt to reduce fractions to lowest terms.  Test your system by calling
<code>make-rational</code> on two polynomials to produce a rational function:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">3</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">rf</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="n">p1</span><span class="p">))</span>
</code></pre></div>

<p>Now add <code>rf</code> to itself, using <code>add</code>. You will observe that this
addition procedure does not reduce fractions to lowest terms.</p>
<h5>Solution</h5>
<p>We have the following rational function</p>
<p>$$r_f = \frac{x^3+1}{x^2+1}$$</p>
<p>We add rational numbers by doing</p>
<p>$$\frac{a}{b}+\frac{c}{d} = \frac{ad+bc}{bd}$$</p>
<p>According to this rule</p>
<div>$$2 r_f = \frac{2(x^3+1)(x^2+1)}{(x^2+1)^2} =\frac{2x^5+2x^3+2x^2+2}{x^4+2x^2+1}$$</div>

<div class="code-box">
<details class="collapsible-code">
<summary class="code-summary"><a href="code/ex2-93.rkt">code/ex2-93.rkt</a> <span class="expand-hint">(click to expand)</span></summary>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="nb">pi</span><span class="w"> </span><span class="mf">3.14159</span><span class="p">)</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">initial</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">      </span><span class="n">initial</span>
<span class="w">      </span><span class="p">(</span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="n">op</span>
<span class="w">                      </span><span class="n">initial</span>
<span class="w">                      </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">sequence</span><span class="p">)))))</span>
<span class="c1">;; get and put definitions</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">operation-table</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">         </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">           </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)</span>
<span class="w">                           </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))))</span>
<span class="w">        </span><span class="p">(</span><span class="k">set!</span><span class="w"> </span><span class="n">operation-table</span>
<span class="w">              </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)))</span>
<span class="w">                    </span><span class="n">operation-table</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="p">)</span>
<span class="w">                </span><span class="no">#f</span><span class="p">)))</span>
<span class="w">        </span><span class="no">#f</span><span class="p">)))</span>

<span class="c1">;; Modified for ex2-78. </span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="n">contents</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: TYPE-TAG&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: CONTENTS&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type-tags</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc</span>
<span class="w">          </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="n">args</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">error</span>
<span class="w">            </span><span class="s2">&quot;No method for these types: APPLY-GENERIC&quot;</span>
<span class="w">            </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))))))</span>


<span class="c1">;; Number package</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="p">))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ======================== Rational package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">negate</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="n">add</span><span class="w"> </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="n">sub</span><span class="w"> </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>

<span class="w">  </span><span class="c1">;; z1a/z1b = z2a/z2b  iff z1amulz2b - z2amulz1b = 0</span>
<span class="w">  </span><span class="c1">;; equ? for problem 2.79</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="p">(</span><span class="n">sub</span><span class="w"> </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z1</span><span class="p">)))))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">negate</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">r</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">r</span><span class="p">)))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>


<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polynomial-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="c1">;; representation of poly</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol?</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span>
<span class="w">        </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-term</span>
<span class="w">          </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t2</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span>
<span class="w">          </span><span class="n">t1</span>
<span class="w">          </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L</span><span class="p">))))))</span>


<span class="w">  </span><span class="c1">;; representation of terms and term lists</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">adjoin-term</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>
<span class="w">      </span><span class="n">term-list</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-term</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="n">coeff</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="n">coeff</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">term</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">term</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>


<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             ADD-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             MUL-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">      </span><span class="p">((</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">else</span>
<span class="w">       </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t1</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">                </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">                 </span><span class="n">t1</span>
<span class="w">                 </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">                            </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">           </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">             </span><span class="n">t2</span>
<span class="w">             </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">              </span><span class="n">L1</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">))))</span>
<span class="w">           </span><span class="p">(</span><span class="k">else</span>
<span class="w">            </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">             </span><span class="p">(</span><span class="n">make-term</span>
<span class="w">              </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">add</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span>
<span class="w">                   </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t2</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">)))))))))</span>
<span class="w">  </span><span class="c1">;; During construction, we don&#39;t check whether coefficients are zero</span>
<span class="w">  </span><span class="c1">;; So now, we have to check all coefficients.</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?-poly</span><span class="w"> </span><span class="n">poly</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">x</span><span class="p">))))</span>
<span class="w">                </span><span class="no">#t</span>
<span class="w">                </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">poly</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; Make sure to install the function</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span><span class="n">=zero?-poly</span><span class="p">)</span>

<span class="w">  </span><span class="c1">;; Exercise 2-88</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">      </span><span class="n">L</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="n">adjoin-term</span><span class="w"> </span><span class="p">(</span><span class="n">make-term</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t</span><span class="p">)))</span>
<span class="w">                     </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">r</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             SUB-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p</span><span class="p">))))))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-polynomial-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">3</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">rf</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="n">p1</span><span class="p">))</span>
<span class="n">rf</span>
<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">rf</span><span class="w"> </span><span class="n">rf</span><span class="p">)</span>
</code></pre></div>


</details>
<div class="code-output">
<span>Output:</span>
<pre>done
done
done
(rational (polynomial x (3 1) (0 1)) polynomial x (2 1) (0 1))
(rational (polynomial x (5 2) (3 2) (2 2) (0 2)) polynomial x (4 1) (2 2) (0 1))
</pre>
</div>
</div>

<h4 id="exercise-294">Exercise 2.94</h4>
<p>Using <code>div-terms</code>, implement
the procedure <code>remainder-terms</code> and use this to define <code>gcd-terms</code> as
above.  Now write a procedure <code>gcd-poly</code> that computes the polynomial
GCD of two polys.  (The procedure should signal an error if the two
polys are not in the same variable.)  Install in the system a generic operation
<code>greatest-common-divisor</code> that reduces to <code>gcd-poly</code> for polynomials
and to ordinary <code>gcd</code> for ordinary numbers.  As a test, try</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span>
<span class="w">   </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">4</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="mi">-2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span>
<span class="w">   </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">3</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="mi">-1</span><span class="p">))))</span>

<span class="p">(</span><span class="n">greatest-common-divisor</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
</code></pre></div>

<p>and check your result by hand.</p>
<h5>Solution</h5>
<p>Let's do it by hand first. Writing this out in excruciating detail...</p>
<div>$$\begin{align*}
\textrm{gcd}(x^4-x^3-2x^2+2x,x^3-x) &=\textrm{gcd}(x^3-x ,\textrm{mod}(x^4-x^3-2x^2+2x, x^3-x))
\end{align*}$$</div>

<div>$$\begin{align*}
\textrm{mod}(x^4-x^3-2x^2+2x, x^3-x)&=\textrm{mod}(x^4-x^3-2x^2+2x - (x-1)(x^3-x), x^3-x)\\
&=\textrm{mod}(x^4-x^3-2x^2+2x - (x^4-x^3-x^2+x), x^3-x)\\
&=\textrm{mod}(-x^2+x, x^3-x)\\
&=-x^2+x\\
\end{align*}$$</div>

<div>$$\begin{align*}
\textrm{gcd}(x^4-x^3-2x^2+2x,x^3-x) &=\textrm{gcd}(x^3-x ,-x^2+x))\\
&=\textrm{gcd}(-x^2+x,\textrm{mod}(x^3-x,-x^2+x))\\
\end{align*}$$</div>

<div>$$\begin{align*}
\textrm{mod}(x^3-x,-x^2+x) &= \textrm{mod}(x^3-x + x(-x^2+x),-x^2+x)\\
 &= \textrm{mod}(x^2-x,-x^2+x)\\
 &= 0
\end{align*}$$</div>
<div>$$\begin{align*}
\textrm{gcd}(x^4-x^3-2x^2+2x,x^3-x) &=\textrm{gcd}(x^3-x ,-x^2+x))\\
&=\textrm{gcd}(-x^2+x,0)\\
&=-x^2+x
\end{align*}$$</div>

<p>Checking, we do in fact get the same result.</p>
<div class="code-box">
<details class="collapsible-code">
<summary class="code-summary"><a href="code/ex2-94.rkt">code/ex2-94.rkt</a> <span class="expand-hint">(click to expand)</span></summary>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="nb">pi</span><span class="w"> </span><span class="mf">3.14159</span><span class="p">)</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">initial</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">      </span><span class="n">initial</span>
<span class="w">      </span><span class="p">(</span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="n">op</span>
<span class="w">                      </span><span class="n">initial</span>
<span class="w">                      </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">sequence</span><span class="p">)))))</span>
<span class="c1">;; get and put definitions</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">operation-table</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">         </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">           </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)</span>
<span class="w">                           </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))))</span>
<span class="w">        </span><span class="p">(</span><span class="k">set!</span><span class="w"> </span><span class="n">operation-table</span>
<span class="w">              </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)))</span>
<span class="w">                    </span><span class="n">operation-table</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="p">)</span>
<span class="w">                </span><span class="no">#f</span><span class="p">)))</span>
<span class="w">        </span><span class="no">#f</span><span class="p">)))</span>

<span class="c1">;; Modified for ex2-78. </span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="n">contents</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: TYPE-TAG&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: CONTENTS&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type-tags</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc</span>
<span class="w">          </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="n">args</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">error</span>
<span class="w">            </span><span class="s2">&quot;No method for these types: APPLY-GENERIC&quot;</span>
<span class="w">            </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))))))</span>


<span class="c1">;; Number package</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="p">))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ======================== Rational package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">g</span><span class="w"> </span><span class="p">(</span><span class="nb">gcd</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">g</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="n">g</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>

<span class="w">  </span><span class="c1">;; z1a/z1b = z2a/z2b  iff z1a*z2b - z2a*z1b = 0</span>
<span class="w">  </span><span class="c1">;; equ? for problem 2.79</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z1</span><span class="p">)))</span>
<span class="w">        </span><span class="mi">0</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">r</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">r</span><span class="p">)))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ================= Complex polar and rectangular ===================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="nb">pi</span><span class="p">)))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="n">a</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ========================= Complex package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; imported procedures from rectangular </span>
<span class="w">  </span><span class="c1">;; and polar packages</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span>
<span class="w">          </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="c1">; for problem 2.79</span>
<span class="w">    </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span><span class="w"> </span><span class="c1">; Changes from problem 2.77</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>


<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polynomial-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="c1">;; representation of poly</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol?</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span>
<span class="w">        </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-term</span>
<span class="w">          </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t2</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span>
<span class="w">          </span><span class="n">t1</span>
<span class="w">          </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L</span><span class="p">))))))</span>


<span class="w">  </span><span class="c1">;; representation of terms and term lists</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">adjoin-term</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>
<span class="w">      </span><span class="n">term-list</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-term</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="n">coeff</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="n">coeff</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">term</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">term</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>


<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             ADD-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             MUL-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">      </span><span class="p">((</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">else</span>
<span class="w">       </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t1</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">                </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">                 </span><span class="n">t1</span>
<span class="w">                 </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">                            </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">           </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">             </span><span class="n">t2</span>
<span class="w">             </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">              </span><span class="n">L1</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">))))</span>
<span class="w">           </span><span class="p">(</span><span class="k">else</span>
<span class="w">            </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">             </span><span class="p">(</span><span class="n">make-term</span>
<span class="w">              </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">add</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span>
<span class="w">                   </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t2</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">)))))))))</span>

<span class="c1">;; (ct1 x^(ot1)+rest1)/(ct2 x^(ot2)+rest2) </span>
<span class="c1">;; =(poly1 - (ct1/ct2) x^(ot1-ot2)(poly2) + (ct1/ct2) x^(ot1-ot2)(poly2))/(poly2)</span>
<span class="c1">;; =(ct1/ct2) x^(ot1-ot2) + (poly1 - (ct1/ct2) x^(ot1-ot2)(poly2))/poly2</span>


<span class="w">  </span><span class="c1">;; During construction, we don&#39;t check whether coefficients are zero</span>
<span class="w">  </span><span class="c1">;; So now, we have to check all coefficients.</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?-poly</span><span class="w"> </span><span class="n">poly</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">x</span><span class="p">))))</span>
<span class="w">                </span><span class="no">#t</span>
<span class="w">                </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">poly</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; Make sure to install the function</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span><span class="n">=zero?-poly</span><span class="p">)</span>

<span class="w">  </span><span class="c1">;; Exercise 2-88</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">      </span><span class="n">L</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="n">adjoin-term</span><span class="w"> </span><span class="p">(</span><span class="n">make-term</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t</span><span class="p">)))</span>
<span class="w">                     </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">r</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             SUB-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span><span class="w"> </span>
<span class="w">              </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t1</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">new-c</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span>
<span class="w">                                               </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t2</span><span class="p">)))</span>
<span class="w">                    </span><span class="p">(</span><span class="n">new-o</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span>
<span class="w">                              </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))))</span>
<span class="w">                </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">new-t</span><span class="w"> </span><span class="p">(</span><span class="n">make-term</span><span class="w"> </span><span class="n">new-o</span><span class="w"> </span><span class="n">new-c</span><span class="p">)))</span>
<span class="w">                  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">rest-of-result</span>
<span class="w">                         </span><span class="p">(</span><span class="n">div-terms</span><span class="w"> </span>
<span class="w">                           </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span><span class="w"> </span><span class="n">new-t</span><span class="w"> </span><span class="n">L2</span><span class="p">))</span><span class="w"> </span>
<span class="w">                           </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">                    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">div-val</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">rest-of-result</span><span class="p">))</span>
<span class="w">                          </span><span class="p">(</span><span class="n">rem-val</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">rest-of-result</span><span class="p">)))</span>
<span class="w">                      </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">new-t</span><span class="p">)</span><span class="w"> </span><span class="n">div-val</span><span class="p">)</span>
<span class="w">                            </span><span class="n">rem-val</span><span class="p">)))))))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>




<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">res</span><span class="w"> </span><span class="p">(</span><span class="n">div-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">         </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">res</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">res</span><span class="p">))))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             SUB-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">poly-remainder</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="p">(</span><span class="n">div-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">poly-gcd</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?-poly</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">        </span><span class="n">a</span>
<span class="w">        </span><span class="p">(</span><span class="n">poly-gcd</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">(</span><span class="n">poly-remainder</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">remainder</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">poly-remainder</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">gcd</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">poly-gcd</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div-poly</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">res</span><span class="w"> </span><span class="p">(</span><span class="n">div-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">           </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">res</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">res</span><span class="p">))))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p</span><span class="p">))))))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-polynomial-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">p1</span>
<span class="w">  </span><span class="p">(</span><span class="n">make-polynomial</span>
<span class="w">   </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">4</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="mi">-2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">p2</span>
<span class="w">  </span><span class="p">(</span><span class="n">make-polynomial</span>
<span class="w">   </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">3</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="mi">-1</span><span class="p">))))</span>

<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">gcd</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
</code></pre></div>


</details>
<div class="code-output">
<span>Output:</span>
<pre>done
done
done
done
done
done
(polynomial x (2 -1) (1 1))
</pre>
</div>
</div>

<h4 id="exercise-295">Exercise 2.95</h4>
<p>Define $P_1$, $P_2$, and
$P_3$ to be the polynomials</p>
<p>$$\begin{array}{rl}
  P_1:  &amp;   x^2 - 2x + 1, \
  P_2:  &amp;   11x^2 + 7,    \
  P_3:  &amp;   13x + 5.
\end{array}
$$</p>
<p>Now define $Q_1$ to be the product of $P_1$ and $P_2$, and $Q_2$ to be
the product of $P_1$ and $P_3$, and use <code>greatest-common-divisor</code>
(Exercise 2.94) to compute the GCD of $Q_1$ and $Q_2$.
Note that the answer is not the same as $P_1$.  This example introduces
noninteger operations into the computation, causing difficulties with the
GCD algorithm.  To understand what is happening, try tracing
<code>gcd-terms</code> while computing the GCD or try performing the
division by hand.</p>
<h5>Solution</h5>
<div class="code-box">
<details class="collapsible-code">
<summary class="code-summary"><a href="code/ex2-95.rkt">code/ex2-95.rkt</a> <span class="expand-hint">(click to expand)</span></summary>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="nb">pi</span><span class="w"> </span><span class="mf">3.14159</span><span class="p">)</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">initial</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">      </span><span class="n">initial</span>
<span class="w">      </span><span class="p">(</span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="n">op</span>
<span class="w">                      </span><span class="n">initial</span>
<span class="w">                      </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">sequence</span><span class="p">)))))</span>
<span class="c1">;; get and put definitions</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">operation-table</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">         </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">           </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)</span>
<span class="w">                           </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))))</span>
<span class="w">        </span><span class="p">(</span><span class="k">set!</span><span class="w"> </span><span class="n">operation-table</span>
<span class="w">              </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)))</span>
<span class="w">                    </span><span class="n">operation-table</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="p">)</span>
<span class="w">                </span><span class="no">#f</span><span class="p">)))</span>
<span class="w">        </span><span class="no">#f</span><span class="p">)))</span>

<span class="c1">;; Modified for ex2-78. </span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="n">contents</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: TYPE-TAG&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: CONTENTS&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type-tags</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc</span>
<span class="w">          </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="n">args</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">error</span>
<span class="w">            </span><span class="s2">&quot;No method for these types: APPLY-GENERIC&quot;</span>
<span class="w">            </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))))))</span>


<span class="c1">;; Number package</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="p">))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ======================== Rational package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">g</span><span class="w"> </span><span class="p">(</span><span class="nb">gcd</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">g</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="n">g</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>

<span class="w">  </span><span class="c1">;; z1a/z1b = z2a/z2b  iff z1a*z2b - z2a*z1b = 0</span>
<span class="w">  </span><span class="c1">;; equ? for problem 2.79</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z1</span><span class="p">)))</span>
<span class="w">        </span><span class="mi">0</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">r</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">r</span><span class="p">)))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ================= Complex polar and rectangular ===================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="nb">pi</span><span class="p">)))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="n">a</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ========================= Complex package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; imported procedures from rectangular </span>
<span class="w">  </span><span class="c1">;; and polar packages</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span>
<span class="w">          </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="c1">; for problem 2.79</span>
<span class="w">    </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span><span class="w"> </span><span class="c1">; Changes from problem 2.77</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>


<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polynomial-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="c1">;; representation of poly</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol?</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span>
<span class="w">        </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-term</span>
<span class="w">          </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t2</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span>
<span class="w">          </span><span class="n">t1</span>
<span class="w">          </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L</span><span class="p">))))))</span>


<span class="w">  </span><span class="c1">;; representation of terms and term lists</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">adjoin-term</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>
<span class="w">      </span><span class="n">term-list</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-term</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="n">coeff</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="n">coeff</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">term</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">term</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>


<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             ADD-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             MUL-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">      </span><span class="p">((</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">else</span>
<span class="w">       </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t1</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">                </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">                 </span><span class="n">t1</span>
<span class="w">                 </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">                            </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">           </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">             </span><span class="n">t2</span>
<span class="w">             </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">              </span><span class="n">L1</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">))))</span>
<span class="w">           </span><span class="p">(</span><span class="k">else</span>
<span class="w">            </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">             </span><span class="p">(</span><span class="n">make-term</span>
<span class="w">              </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">add</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span>
<span class="w">                   </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t2</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">)))))))))</span>

<span class="c1">;; (ct1 x^(ot1)+rest1)/(ct2 x^(ot2)+rest2) </span>
<span class="c1">;; =(poly1 - (ct1/ct2) x^(ot1-ot2)(poly2) + (ct1/ct2) x^(ot1-ot2)(poly2))/(poly2)</span>
<span class="c1">;; =(ct1/ct2) x^(ot1-ot2) + (poly1 - (ct1/ct2) x^(ot1-ot2)(poly2))/poly2</span>


<span class="w">  </span><span class="c1">;; During construction, we don&#39;t check whether coefficients are zero</span>
<span class="w">  </span><span class="c1">;; So now, we have to check all coefficients.</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?-poly</span><span class="w"> </span><span class="n">poly</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">x</span><span class="p">))))</span>
<span class="w">                </span><span class="no">#t</span>
<span class="w">                </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">poly</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; Make sure to install the function</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span><span class="n">=zero?-poly</span><span class="p">)</span>

<span class="w">  </span><span class="c1">;; Exercise 2-88</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">      </span><span class="n">L</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="n">adjoin-term</span><span class="w"> </span><span class="p">(</span><span class="n">make-term</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t</span><span class="p">)))</span>
<span class="w">                     </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">r</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             SUB-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span><span class="w"> </span>
<span class="w">              </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t1</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">new-c</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span>
<span class="w">                                               </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t2</span><span class="p">)))</span>
<span class="w">                    </span><span class="p">(</span><span class="n">new-o</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span>
<span class="w">                              </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))))</span>
<span class="w">                </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">new-t</span><span class="w"> </span><span class="p">(</span><span class="n">make-term</span><span class="w"> </span><span class="n">new-o</span><span class="w"> </span><span class="n">new-c</span><span class="p">)))</span>
<span class="w">                  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">rest-of-result</span>
<span class="w">                         </span><span class="p">(</span><span class="n">div-terms</span><span class="w"> </span>
<span class="w">                           </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span><span class="w"> </span><span class="n">new-t</span><span class="w"> </span><span class="n">L2</span><span class="p">))</span><span class="w"> </span>
<span class="w">                           </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">                    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">div-val</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">rest-of-result</span><span class="p">))</span>
<span class="w">                          </span><span class="p">(</span><span class="n">rem-val</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">rest-of-result</span><span class="p">)))</span>
<span class="w">                      </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">new-t</span><span class="p">)</span><span class="w"> </span><span class="n">div-val</span><span class="p">)</span>
<span class="w">                            </span><span class="n">rem-val</span><span class="p">)))))))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>




<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">res</span><span class="w"> </span><span class="p">(</span><span class="n">div-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">         </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">res</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">res</span><span class="p">))))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             SUB-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">poly-remainder</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="p">(</span><span class="n">div-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">poly-gcd</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?-poly</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">        </span><span class="n">a</span>
<span class="w">        </span><span class="p">(</span><span class="n">poly-gcd</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">(</span><span class="n">poly-remainder</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">remainder</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">poly-remainder</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">gcd</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">poly-gcd</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div-poly</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">res</span><span class="w"> </span><span class="p">(</span><span class="n">div-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">           </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">res</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">res</span><span class="p">))))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p</span><span class="p">))))))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-polynomial-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">p1</span>
<span class="w">  </span><span class="p">(</span><span class="n">make-polynomial</span>
<span class="w">   </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="mi">-2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">p2</span>
<span class="w">  </span><span class="p">(</span><span class="n">make-polynomial</span>
<span class="w">   </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">7</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">p3</span>
<span class="w">  </span><span class="p">(</span><span class="n">make-polynomial</span>
<span class="w">   </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">1</span><span class="w"> </span><span class="mi">13</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">5</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">q1</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">q2</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p3</span><span class="p">))</span>

<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">gcd</span><span class="w"> </span><span class="n">q1</span><span class="w"> </span><span class="n">q2</span><span class="p">)</span>
</code></pre></div>


</details>
<div class="code-output">
<span>Output:</span>
<pre>done
done
done
done
done
done
(polynomial x (2 1458/169) (1 -2916/169) (0 1458/169))
</pre>
</div>
</div>

<p>This is just a general fact of Euclidean domains. The GCD is only defined up to multiplication
by invertible elements. Most applications would choose to normalize the leading term to 1,
in which case we get back the polynomial $x^2-2x+1.$</p>
<h4 id="exercise-296">Exercise 2.96</h4>
<p><strong>1.</strong> Implement the procedure <code>pseudoremainder-terms</code>, which is just like
<code>remainder-terms</code> except that it multiplies the dividend by the
integerizing factor described above before calling <code>div-terms</code>.  Modify
<code>gcd-terms</code> to use <code>pseudoremainder-terms</code>, and verify that
<code>greatest-common-divisor</code> now produces an answer with integer coefficients
on the example in Exercise 2.95.</p>
<p><strong>2.</strong> The GCD now has integer coefficients, but they are larger than those
of $P_1$.  Modify <code>gcd-terms</code> so that it removes common factors from the
coefficients of the answer by dividing all the coefficients by their (integer)
greatest common divisor.</p>
<h5>Solution</h5>
<div class="code-box">
<details class="collapsible-code">
<summary class="code-summary"><a href="code/ex2-96.rkt">code/ex2-96.rkt</a> <span class="expand-hint">(click to expand)</span></summary>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="nb">pi</span><span class="w"> </span><span class="mf">3.14159</span><span class="p">)</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">initial</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">      </span><span class="n">initial</span>
<span class="w">      </span><span class="p">(</span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="n">op</span>
<span class="w">                      </span><span class="n">initial</span>
<span class="w">                      </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">sequence</span><span class="p">)))))</span>
<span class="c1">;; get and put definitions</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">operation-table</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">         </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="n">records</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">records</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">records</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">           </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-cdr!</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span>
<span class="w">                 </span><span class="p">(</span><span class="n">set-car!</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)</span>
<span class="w">                           </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))))</span>
<span class="w">        </span><span class="p">(</span><span class="k">set!</span><span class="w"> </span><span class="n">operation-table</span>
<span class="w">              </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc</span><span class="p">)))</span>
<span class="w">                    </span><span class="n">operation-table</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">op-list-entry</span><span class="w"> </span><span class="p">(</span><span class="n">assoc-op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">operation-table</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">op-list-entry</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">op-list-entry</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc-pair-entry</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">type-tags</span><span class="w"> </span><span class="n">proc-list</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc-pair-entry</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">proc-pair-entry</span><span class="p">)</span>
<span class="w">                </span><span class="no">#f</span><span class="p">)))</span>
<span class="w">        </span><span class="no">#f</span><span class="p">)))</span>

<span class="c1">;; Modified for ex2-78. </span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="n">contents</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">contents</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">type-tag</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: TYPE-TAG&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">contents</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">pair?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">datum</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span><span class="w"> </span><span class="n">datum</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Bad tagged datum: CONTENTS&quot;</span><span class="w"> </span><span class="n">datum</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">type-tags</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">type-tag</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">proc</span>
<span class="w">          </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="n">args</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">error</span>
<span class="w">            </span><span class="s2">&quot;No method for these types: APPLY-GENERIC&quot;</span>
<span class="w">            </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">type-tags</span><span class="p">))))))</span>


<span class="c1">;; Number package</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="w"> </span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">scheme-number</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-scheme-number-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-scheme-number</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">scheme-number</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="p">))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ======================== Rational package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">g</span><span class="w"> </span><span class="p">(</span><span class="nb">gcd</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">g</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="n">g</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>

<span class="w">  </span><span class="c1">;; z1a/z1b = z2a/z2b  iff z1a*z2b - z2a*z1b = 0</span>
<span class="w">  </span><span class="c1">;; equ? for problem 2.79</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">z1</span><span class="p">)))</span>
<span class="w">        </span><span class="mi">0</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="w"> </span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-rat</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rational</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-rat</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="n">r</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="n">r</span><span class="p">)))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-rational-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rational</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ================= Complex polar and rectangular ===================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polar</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="nb">pi</span><span class="p">)))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-polar-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">atan</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="n">a</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to the rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">rectangular</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">rectangular</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)))))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>
<span class="p">(</span><span class="n">install-rectangular-package</span><span class="p">)</span>

<span class="c1">;; ===================================================================</span>
<span class="c1">;; ========================= Complex package =========================</span>
<span class="c1">;; ===================================================================</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; imported procedures from rectangular </span>
<span class="w">  </span><span class="c1">;; and polar packages</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span>
<span class="w">          </span><span class="o">&#39;</span><span class="ss">rectangular</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polar</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span>
<span class="w">     </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span><span class="c1">; for problem 2.79</span>
<span class="w">    </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="n">equ?</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">real-part</span><span class="p">)</span><span class="w"> </span><span class="c1">; Changes from problem 2.77</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">imag-part</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">magnitude</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span><span class="w"> </span><span class="nb">angle</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="w"> </span><span class="ss">complex</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">div-complex</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="n">z2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-real-imag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-real-imag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make-from-mag-ang</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">complex</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-from-mag-ang</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span>
<span class="w">  </span><span class="c1">;problem 2.80</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">complex</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-complex-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="n">a</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">real-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">imag-part</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">magnitude</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">angle</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">angle</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">equ?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>


<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">install-polynomial-package</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; internal procedures</span>
<span class="w">  </span><span class="c1">;; representation of poly</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol?</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span>
<span class="w">        </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-term</span>
<span class="w">          </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="n">mul</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t2</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span>
<span class="w">          </span><span class="n">t1</span>
<span class="w">          </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L</span><span class="p">))))))</span>


<span class="w">  </span><span class="c1">;; representation of terms and term lists</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">adjoin-term</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>
<span class="w">      </span><span class="n">term-list</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">term-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">term-list</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-term</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="n">coeff</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="n">coeff</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">term</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">term</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">term</span><span class="p">))</span>


<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             ADD-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">mul-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">mul-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             MUL-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">      </span><span class="p">((</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">else</span>
<span class="w">       </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t1</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">                </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">                 </span><span class="n">t1</span>
<span class="w">                 </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">                            </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">           </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">             </span><span class="n">t2</span>
<span class="w">             </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">              </span><span class="n">L1</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">))))</span>
<span class="w">           </span><span class="p">(</span><span class="k">else</span>
<span class="w">            </span><span class="p">(</span><span class="n">adjoin-term</span>
<span class="w">             </span><span class="p">(</span><span class="n">make-term</span>
<span class="w">              </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">add</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span>
<span class="w">                   </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t2</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="n">add-terms</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">)))))))))</span>

<span class="c1">;; (ct1 x^(ot1)+rest1)/(ct2 x^(ot2)+rest2) </span>
<span class="c1">;; =(poly1 - (ct1/ct2) x^(ot1-ot2)(poly2) + (ct1/ct2) x^(ot1-ot2)(poly2))/(poly2)</span>
<span class="c1">;; =(ct1/ct2) x^(ot1-ot2) + (poly1 - (ct1/ct2) x^(ot1-ot2)(poly2))/poly2</span>


<span class="w">  </span><span class="c1">;; During construction, we don&#39;t check whether coefficients are zero</span>
<span class="w">  </span><span class="c1">;; So now, we have to check all coefficients.</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?-poly</span><span class="w"> </span><span class="n">poly</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">accumulate</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">x</span><span class="p">))))</span>
<span class="w">                </span><span class="no">#t</span>
<span class="w">                </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">poly</span><span class="p">)))</span>
<span class="w">  </span><span class="c1">;; Make sure to install the function</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">=zero?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span><span class="n">=zero?-poly</span><span class="p">)</span>

<span class="w">  </span><span class="c1">;; Exercise 2-88</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">      </span><span class="n">L</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="n">rest-terms</span><span class="w"> </span><span class="n">L</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="n">adjoin-term</span><span class="w"> </span><span class="p">(</span><span class="n">make-term</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t</span><span class="p">)))</span>
<span class="w">                     </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">r</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sub-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">make-poly</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             SUB-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty-termlist?</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span><span class="w"> </span>
<span class="w">              </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">t1</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">the-empty-termlist</span><span class="p">)</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">new-c</span><span class="w"> </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div</span><span class="w"> </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span>
<span class="w">                                               </span><span class="p">(</span><span class="n">coeff</span><span class="w"> </span><span class="n">t2</span><span class="p">)))</span>
<span class="w">                    </span><span class="p">(</span><span class="n">new-o</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span>
<span class="w">                              </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="n">t2</span><span class="p">))))</span>
<span class="w">                </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">new-t</span><span class="w"> </span><span class="p">(</span><span class="n">make-term</span><span class="w"> </span><span class="n">new-o</span><span class="w"> </span><span class="n">new-c</span><span class="p">)))</span>
<span class="w">                  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">rest-of-result</span>
<span class="w">                         </span><span class="p">(</span><span class="n">div-terms</span><span class="w"> </span>
<span class="w">                           </span><span class="p">(</span><span class="n">sub-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="p">(</span><span class="n">mul-term-by-all-terms</span><span class="w"> </span><span class="n">new-t</span><span class="w"> </span><span class="n">L2</span><span class="p">))</span><span class="w"> </span>
<span class="w">                           </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">                    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">div-val</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">rest-of-result</span><span class="p">))</span>
<span class="w">                          </span><span class="p">(</span><span class="n">rem-val</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">rest-of-result</span><span class="p">)))</span>
<span class="w">                      </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">add-terms</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">new-t</span><span class="p">)</span><span class="w"> </span><span class="n">div-val</span><span class="p">)</span>
<span class="w">                            </span><span class="n">rem-val</span><span class="p">)))))))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">sub</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">sub-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">div-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">res</span><span class="w"> </span><span class="p">(</span><span class="n">div-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">         </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">res</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">res</span><span class="p">))))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;Polys not in same var:</span>
<span class="s2">             SUB-POLY&quot;</span>
<span class="w">             </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>


<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">remainder-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="p">(</span><span class="n">div-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">poly-remainder</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="p">(</span><span class="n">div-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">term-order</span><span class="w"> </span><span class="n">L</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="p">(</span><span class="n">order</span><span class="w"> </span><span class="p">(</span><span class="n">first-term</span><span class="w"> </span><span class="n">L</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">pow</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">(</span><span class="n">pow</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="mi">1</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">poly-pseudoremainder-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)(</span><span class="nb">display</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)(</span><span class="nb">newline</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">o1</span><span class="w"> </span><span class="p">(</span><span class="n">term-order</span><span class="w"> </span><span class="n">L1</span><span class="p">))</span><span class="w"> </span>
<span class="w">          </span><span class="p">(</span><span class="n">o2</span><span class="w"> </span><span class="p">(</span><span class="n">term-order</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="w">          </span><span class="c1">;(c (coeff (first-term L2))))</span>
<span class="w">      </span><span class="p">(</span><span class="n">remainder-terms</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="n">L2</span><span class="p">)))</span>
<span class="c1">;;        (mul-term-by-all-terms </span>
<span class="c1">;;          (list 0 (pow c (+ 1 (- o1 o2)))) </span>
<span class="c1">;;          L1)</span>
<span class="c1">;;        L2)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">poly-pseudoremainder</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">terms</span><span class="w"> </span><span class="p">(</span><span class="n">poly-pseudoremainder-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">        </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span><span class="w"> </span><span class="n">terms</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">poly-gcd</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">=zero?-poly</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">        </span><span class="n">a</span>
<span class="w">        </span><span class="p">(</span><span class="n">poly-gcd</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">(</span><span class="n">poly-pseudoremainder</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">attach-tag</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">remainder</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">poly-remainder</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">gcd</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">poly-gcd</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">div-poly</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">res</span><span class="w"> </span><span class="p">(</span><span class="n">div-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)))</span>
<span class="w">           </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">res</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">res</span><span class="p">))))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">negate</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">negate-terms</span><span class="w"> </span><span class="p">(</span><span class="n">term-list</span><span class="w"> </span><span class="n">p</span><span class="p">))))))</span>
<span class="w">  </span><span class="c1">;; interface to rest of the system</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">add</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">add-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">polynomial</span><span class="w"> </span><span class="ss">polynomial</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">mul-poly</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">put</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">)</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="k">tag</span><span class="w"> </span><span class="p">(</span><span class="n">make-poly</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">))))</span>
<span class="w">  </span><span class="o">&#39;</span><span class="ss">done</span><span class="p">)</span>

<span class="p">(</span><span class="n">install-polynomial-package</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">get</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">make</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">polynomial</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">terms</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">p1</span>
<span class="w">  </span><span class="p">(</span><span class="n">make-polynomial</span>
<span class="w">   </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="mi">-2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">p2</span>
<span class="w">  </span><span class="p">(</span><span class="n">make-polynomial</span>
<span class="w">   </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">7</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">p3</span>
<span class="w">  </span><span class="p">(</span><span class="n">make-polynomial</span>
<span class="w">   </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">1</span><span class="w"> </span><span class="mi">13</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">5</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">q1</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">q2</span>
<span class="w">  </span><span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">mul</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p3</span><span class="p">))</span>

<span class="p">(</span><span class="n">apply-generic</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">gcd</span><span class="w"> </span><span class="n">q1</span><span class="w"> </span><span class="n">q2</span><span class="p">)</span>
</code></pre></div>


</details>
<div class="code-output">
<span>Output:</span>
<pre>done
done
done
done
done
done

Error (exit code 1):
mcdr: contract violation
  expected: mpair?
  given: #&lt;procedure:...ch2/code/ex2-96.rkt:507:4&gt;
  context...:
   /home/physbuzz/sicp/src/ch2/code/ex2-96.rkt:510:2: poly-gcd
   /home/physbuzz/sicp/src/ch2/code/ex2-96.rkt:520:7
   body of &quot;/home/physbuzz/sicp/src/ch2/code/ex2-96.rkt&quot;
</pre>
</div>
</div>

<h4 id="exercise-297">Exercise 2.97</h4>
<p><strong>1.</strong> Implement this algorithm as a procedure <code>reduce-terms</code> that takes two term
lists <code>n</code> and <code>d</code> as arguments and returns a list <code>nn</code>,
<code>dd</code>, which are <code>n</code> and <code>d</code> reduced to lowest terms via the
algorithm given above.  Also write a procedure <code>reduce-poly</code>, analogous to
<code>add-poly</code>, that checks to see if the two polys have the same variable.
If so, <code>reduce-poly</code> strips off the variable and passes the problem to
<code>reduce-terms</code>, then reattaches the variable to the two term lists
supplied by <code>reduce-terms</code>.</p>
<p><strong>2.</strong> Define a procedure analogous to <code>reduce-terms</code> that does what the original
<code>make-rat</code> did for integers:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">reduce-integers</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">g</span><span class="w"> </span><span class="p">(</span><span class="nb">gcd</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">d</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">g</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="n">g</span><span class="p">))))</span>
</code></pre></div>

<p>and define <code>reduce</code> as a generic operation that calls <code>apply-generic</code>
to dispatch to either <code>reduce-poly</code> (for <code>polynomial</code> arguments) or
<code>reduce-integers</code> (for <code>scheme-number</code> arguments).  You can now
easily make the rational-arithmetic package reduce fractions to lowest terms by
having <code>make-rat</code> call <code>reduce</code> before combining the given numerator
and denominator to form a rational number.  The system now handles rational
expressions in either integers or polynomials.  To test your program, try the
example at the beginning of this extended exercise:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">3</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">-1</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">p3</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">p4</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="n">make-polynomial</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">-1</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">rf1</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">rf2</span><span class="w"> </span><span class="p">(</span><span class="n">make-rational</span><span class="w"> </span><span class="n">p3</span><span class="w"> </span><span class="n">p4</span><span class="p">))</span>
<span class="p">(</span><span class="n">add</span><span class="w"> </span><span class="n">rf1</span><span class="w"> </span><span class="n">rf2</span><span class="p">)</span>
</code></pre></div>

<p>See if you get the correct answer, correctly reduced to lowest terms.</p>
<h5>Solution</h5>
    </div>
</body>
</html>
