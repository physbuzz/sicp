<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>notes-ch2-3.md</title>
    <!-- MathJax for LaTeX support -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']]
            }
        };
    </script>
    <style>
        /* Pygments Syntax Highlighting */
        pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.codehilite .hll { background-color: #ffffcc }
.codehilite { background: #f8f8f8; }
.codehilite .c { color: #3D7B7B; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #FF0000 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666666 } /* Operator */
.codehilite .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #9C6500 } /* Comment.Preproc */
.codehilite .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.codehilite .gr { color: #E40000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #008400 } /* Generic.Inserted */
.codehilite .go { color: #717171 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #0044DD } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #687822 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.codehilite .no { color: #880000 } /* Name.Constant */
.codehilite .nd { color: #AA22FF } /* Name.Decorator */
.codehilite .ni { color: #717171; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #0000FF } /* Name.Function */
.codehilite .nl { color: #767600 } /* Name.Label */
.codehilite .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #bbbbbb } /* Text.Whitespace */
.codehilite .mb { color: #666666 } /* Literal.Number.Bin */
.codehilite .mf { color: #666666 } /* Literal.Number.Float */
.codehilite .mh { color: #666666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666666 } /* Literal.Number.Oct */
.codehilite .sa { color: #BA2121 } /* Literal.String.Affix */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .dl { color: #BA2121 } /* Literal.String.Delimiter */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #A45A77 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .fm { color: #0000FF } /* Name.Function.Magic */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .vm { color: #19177C } /* Name.Variable.Magic */
.codehilite .il { color: #666666 } /* Literal.Number.Integer.Long */

        /* Base CSS from markdown_styles.py */
        
        /* Basic reset and fonts */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            padding: 0;
            background-color: #f8f9fa;
        }

        /* Navigation styling */
        .nav {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            padding-bottom: 0.8rem;
            border-bottom: 1px solid #e1e4e8;
        }

        .nav span {
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .nav .activenav {
            background-color: #f1f8ff;
        }

        .nav .activenav a {
            color: #0366d6;
            text-decoration: none;
        }

        .nav .activenav a:hover {
            text-decoration: underline;
        }

        .nav .inactivenav {
            color: #959da5;
            background-color: #f6f8fa;
        }

        /* Center column layout */
        .container {
            max-width: 800px;
            margin: 2rem auto;
            background-color: white;
            padding: 2rem 3rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Typography */
        h1 {
            font-size: 2.2rem;
            margin-bottom: 1.5rem;
            color: #2c3e50;
            border-bottom: 2px solid #eee;
            padding-bottom: 0.5rem;
        }

        h2 {
            font-size: 1.8rem;
            margin: 2rem 0 1rem;
            color: #34495e;
        }

        h3 {
            font-size: 1.5rem;
            margin: 1.8rem 0 1rem;
            color: #34495e;
        }

        h4 {
            font-size: 1.3rem;
            margin: 1.5rem 0 0.8rem;
            color: #34495e;
        }

        h5 {
            font-size: 1.1rem;
            margin: 1.2rem 0 0.8rem;
            color: #34495e;
        }

        /* Table of Contents styling */
        .table-of-contents {
            margin: 0 0 0;
            line-height: 1;
        }

        .toc-list {
            margin: 0;
            padding-left: 20px;
        }

        .toc-list li {
            margin-bottom: 2px;
        }
        .toc-list ul {
            margin-bottom: 2px;
        }

        .exercise-list {
            margin: 0;
            padding-left: 0;
            font-size: 0.95em;
            display: inline;
        }

        .exercise-container {
            display: inline-block;
            margin-top: 2px;
            line-height: 1.2;
        }

        .toc-exercises {
            font-style: italic;
            color: #555;
        }

        .exercise-list a {
            text-decoration: none;
            color: #2070b0;
            margin-right: 0;
        }

        .exercise-list a:hover {
            text-decoration: underline;
        }

        .exercise-list span:not(:last-child):after {
            content: ", ";
            color: #777;
            margin-right: 0;
        }

        /* Blockquote styling */
        blockquote {
            border-left: 4px solid #dfe2e5;
            color: #6a737d;
            padding: 0 1rem;
            margin: 1rem 0 1.5rem;
            background-color: #f6f8fa;
            border-radius: 0 3px 3px 0;
        }

        blockquote p {
            padding: 0.8rem 0;
        }

        blockquote p:first-child {
            margin-top: 0;
        }

        blockquote p:last-child {
            margin-bottom: 0;
        }

        /* Solution styling */
        h5:has(+p:contains("Solution")) {
            margin-bottom: 0;
        }

        h5:has(+p:contains("Solution")) + p {
            font-weight: bold;
            color: #3c8dbc;
            border-left: 3px solid #3c8dbc;
            padding-left: 0.8rem;
            margin: 0.5rem 0 1rem;
        }

        p {
            margin-bottom: 1rem;
        }

        /* List styling */
        ul, ol {
            margin-bottom: 1rem;
            padding-left: 2.5rem;
        }

        ul li, ol li {
            margin-bottom: 0.5rem;
        }

        /* Code blocks */
        .code-box {
            background-color: #f6f8fa;
            border-radius: 6px;
            overflow: hidden;
            margin: 1rem 0 1.5rem;
            border: 1px solid #e1e4e8;
        }

        .code-header {
            font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.75rem;
            color: #6a737d;
            padding: 0.3rem 0 0rem 0.3rem;
            border-bottom: 1px solid #e1e4e8;
            background-color: #fafbfc;
        }

        .code-header a {
            color: #6a737d;
            text-decoration: none;
        }

        .code-header a:hover {
            text-decoration: underline;
            color: #0366d6;
        }

        /* Standalone code blocks (triple backticks) */
        .codehilite {
            background-color: #f6f8fa;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1rem 0 1.5rem;
            border: 1px solid #e1e4e8;
        }

        /* When inside a code-box, remove default styling */
        .code-box .codehilite {
            margin: 0;
            padding: 0;
            border: none;
            border-radius: 0;
        }

        /* Adjust padding for code blocks inside code-box */
        .code-box .codehilite pre {
            padding: 0.2rem 0 0.3rem 0.3rem;
            overflow-x: auto;
            margin: 0;
        }

        /* Normal padding for standalone code blocks */
        .codehilite pre {
            padding: 1rem;
            overflow-x: auto;
            margin: 0;
        }

        .code-output {
            font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.75rem;
            color: #6a737d;
            padding: 0.2rem 0 0.3rem 0.3rem;
            border-top: 1px solid #e1e4e8;
            background-color: #fafbfc;
        }
        .code-output span {
            color: #de37cc;
        }

        .code-output pre {
            margin: 0;
            white-space: pre-wrap;
            font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
        }
        /* --- Styles for Collapsible Code Blocks --- */
        .collapsible-code {
            border: none; /* Remove default border from details */
            margin-top: 0; /* Adjust spacing if needed */
            margin-bottom: 0; /* Adjust spacing if needed */
        }

        .code-summary {
            font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.75rem;
            color: #6a737d;
            padding: 0.5rem 0.8rem; /* Adjusted padding */
            border-bottom: 1px solid #e1e4e8;
            background-color: #fafbfc;
            cursor: pointer;
            list-style: none; /* Hide default marker */
            display: block; /* Make it block level */
            border-radius: 6px 6px 0 0; /* Round top corners like header */
            position: relative; /* For positioning the marker */
            transition: background-color 0.1s ease-in-out;
        }

        .code-summary:hover {
            background-color: #f1f3f5; /* Slight hover effect */
        }

        /* Add custom marker */
        .code-summary::before {
            content: '►'; /* Collapsed marker */
            position: absolute;
            left: 0.8rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.6em;
            color: #6a737d;
            margin-right: 0.5rem;
            transition: transform 0.2s ease-in-out;
        }

        .collapsible-code[open] > .code-summary::before {
            transform: translateY(-50%) rotate(90deg); /* Expanded marker */
        }

        .collapsible-code[open] > .code-summary {
             border-bottom: 1px solid #e1e4e8; /* Ensure border shows when open */
             border-radius: 6px 6px 0 0; /* Keep top rounding when open */
        }

        /* Adjust summary content positioning relative to marker */
        .code-summary a {
            margin-left: 1.2rem; /* Space for the marker */
            color: #6a737d;
            text-decoration: none;
        }
        .code-summary a:hover {
            text-decoration: underline;
            color: #0366d6;
        }

        /* New style for the expand hint */
        .expand-hint {
            font-style: italic;
            font-size: 0.85em;
            color: #888;
            margin-left: 0.5rem;
        }

        /* Ensure content inside details has appropriate spacing/styling */
        .collapsible-code > .codehilite {
            margin: 0;
            border-radius: 0 0 6px 6px; /* Round bottom corners */
            border: none; /* Remove border from codehilite itself */
            border-top: none; /* Remove top border */
        }

        /* Since code output is now outside the details element,
           we need to adjust its styling */
        .collapsible-code + .code-output {
            border-radius: 0 0 6px 6px; /* Round bottom corners */
            margin-top: 0; /* Remove gap */
            border-top: 1px solid #e1e4e8;
        }

        /* Ensure code output has proper border when outside details */
        .code-box > .code-output {
            border-top: 1px solid #e1e4e8;
        }

        .collapsible-code > .run-racket {
             margin-left: 1rem; /* Indent run button */
             margin-bottom: 1rem; /* Add bottom margin */
        }
        /* --- End Collapsible Styles --- */

        code {
            font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.9em;
            padding: 0.2em 0.4em;
            background-color: #f6f8fa;
            border-radius: 3px;
        }

        .codehilite code {
            padding: 0;
            background-color: transparent;
        }

        /* Links */
        a {
            color: #0366d6;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        /* Run button */
        .run-racket {
            display: inline-block;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.4rem 0.8rem;
            background-color: #3c8dbc;
            color: white;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .run-racket:hover {
            background-color: #367fa9;
            text-decoration: none;
        }

        /* Make LaTeX display nicely */
        .MathJax {
            overflow-x: auto;
            overflow-y: hidden;
        }
    
    </style>
</head>
<body>
    <div class="container">
        <div class="nav">
    <span class="activenav"><a href="notes-ch2-2.html">← Previous</a></span>
    <span class="activenav"><a href="../index.html">↑ Up</a></span>
    <span class="activenav"><a href="notes-ch2-4.html">Next →</a></span>
</div>

<p><a href="https://sarabander.github.io/sicp/html/2_002e3.xhtml#g_t2_002e3">HTML Book Chapter 2.3 Link</a></p>
<p><div class="table-of-contents">
<h2>Directory</h2>
<ul class="toc-list">
<ul>
<li><a href="#section-23">Section 2.3</a></li>
<ul>
<li><a href="#meeting-04-20-2025">Meeting 04-20-2025</a></li>
<li><a href="#note-on-my-confusion-with-wolfram-language">Note on my confusion with Wolfram Language</a></li>
<li><a href="#experimenting-w-derivatives">Experimenting w/ derivatives</a></li>
<li><a href="#exercises" class="toc-exercises">Exercises</a>
<div class="exercise-container">(
<span class="exercise-list">
<span><a href="#exercise-253">Exercise 2.53</a></span>
<span><a href="#exercise-254">Exercise 2.54</a></span>
<span><a href="#exercise-255">Exercise 2.55</a></span>
<span><a href="#exercise-256">Exercise 2.56</a></span>
<span><a href="#exercise-257">Exercise 2.57</a></span>
<span><a href="#exercise-258">Exercise 2.58</a></span>
<span><a href="#exercise-259">Exercise 2.59</a></span>
<span><a href="#exercise-260">Exercise 2.60</a></span>
<span><a href="#exercise-261">Exercise 2.61</a></span>
<span><a href="#exercise-262">Exercise 2.62</a></span>
<span><a href="#exercise-263">Exercise 2.63</a></span>
<span><a href="#exercise-264">Exercise 2.64</a></span>
<span><a href="#exercise-265">Exercise 2.65</a></span>
<span><a href="#exercise-266">Exercise 2.66</a></span>
<span><a href="#exercise-267">Exercise 2.67</a></span>
<span><a href="#exercise-268">Exercise 2.68</a></span>
<span><a href="#exercise-269">Exercise 2.69</a></span>
<span><a href="#exercise-270">Exercise 2.70</a></span>
<span><a href="#exercise-271">Exercise 2.71</a></span>
<span><a href="#exercise-272">Exercise 2.72</a></span>
</span>)
</div></li>
</ul>
</ul>
</ul>
</div></p>
<h2 id="section-23">Section 2.3</h2>
<h3 id="meeting-04-20-2025">Meeting 04-20-2025</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>
<span class="c1">;; true</span>
<span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">b</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">c</span><span class="p">))</span>

<span class="c1">;; false</span>
<span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="p">))</span>

<span class="c1">;; These three are equivalent: </span>
<span class="n">nil</span>
<span class="o">&#39;</span><span class="p">()</span>
<span class="p">(</span><span class="nb">list</span><span class="p">)</span>

<span class="c1">;; These are ~equivalent ...?</span>
<span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="p">)</span>
<span class="p">(</span><span class="k">quote</span><span class="w"> </span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="p">))</span>
<span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">b</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">c</span><span class="p">)</span>
<span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="k">quote</span><span class="w"> </span><span class="ss">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">quote</span><span class="w"> </span><span class="ss">b</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">quote</span><span class="w"> </span><span class="ss">c</span><span class="p">))</span>
</code></pre></div>

<p>My solution to problem 2.54 was bad and had exceptions. Also, <code>symbol?</code> wasn't introduced until after this problem, so it really is probably not be the intended way.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol?</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol?</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">pair?</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">pair?</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span>
<span class="w">           </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="w">           </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">b</span><span class="p">)))))</span>

<span class="c1">;;Some test cases:</span>
<span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">this</span><span class="w"> </span><span class="ss">is</span><span class="w"> </span><span class="ss">a</span><span class="w"> </span><span class="ss">list</span><span class="p">)</span><span class="w"> </span>
<span class="w">        </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">this</span><span class="w"> </span><span class="ss">is</span><span class="w"> </span><span class="ss">a</span><span class="w"> </span><span class="ss">list</span><span class="p">))</span>
<span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">this</span><span class="w"> </span><span class="ss">is</span><span class="w"> </span><span class="ss">a</span><span class="w"> </span><span class="ss">list</span><span class="p">)</span><span class="w"> </span>
<span class="w">        </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">this</span><span class="w"> </span><span class="p">(</span><span class="ss">is</span><span class="w"> </span><span class="ss">a</span><span class="p">)</span><span class="w"> </span><span class="ss">list</span><span class="p">))</span>
<span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">this</span><span class="w"> </span><span class="p">(</span><span class="ss">is</span><span class="w"> </span><span class="ss">a</span><span class="p">)</span><span class="w"> </span><span class="ss">list</span><span class="p">)</span><span class="w"> </span>
<span class="w">        </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">this</span><span class="w"> </span><span class="p">(</span><span class="ss">is</span><span class="w"> </span><span class="ss">a</span><span class="p">)</span><span class="w"> </span><span class="ss">list</span><span class="p">))</span>
<span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="p">))</span>

<span class="c1">;; Failure case! </span>
<span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span>
</code></pre></div>

<p>Here was Erik's solution which might be a bit better or be the intended way:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">myequal?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">b</span><span class="p">))</span><span class="w"> </span><span class="no">#t</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">b</span><span class="p">))</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nb">pair?</span><span class="w"> </span><span class="n">a</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nb">pair?</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nb">pair?</span><span class="w"> </span><span class="n">a</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nb">pair?</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span>
<span class="w">         </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">myequal?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">b</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">myequal?</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">b</span><span class="p">))))))</span>
</code></pre></div>

<p>More conversation about eq:</p>
<ul>
<li>
<p>"If obj1 and obj2 are both aggregate types, equal? compares its elements recursively."</p>
</li>
<li>
<p>https://practical-scheme.net/gauche/man/gauche-refe/Equality-and-comparison.html</p>
</li>
<li>
<p>https://www.gnu.org/software/guile/manual/html_node/Equality.html</p>
</li>
<li>
<p>https://beautifulracket.com/explainer/equality.html</p>
</li>
</ul>
<p>Back to the chapter:</p>
<ul>
<li>
<p>Autodiff and problem 2.58. I found it interesting that the shunting yard algorithm wasn't used. Animation of the shunting yard algo: https://somethingorotherwhatever.com/shunting-yard-animation/</p>
</li>
<li>
<p>Guile is the GNU implementation of scheme. You could say scheme is a minimal lisp.</p>
</li>
<li>
<p>https://github.com/zv/SICP-guile</p>
</li>
<li>
<p>For the proof of the optimality of huffman encoding, https://static.ias.edu/pitp/archive/2012files/Hamming_CHs1-3.pdf</p>
</li>
<li>
<p>https://norvig.com/ngrams/</p>
</li>
<li>
<p>https://news.ycombinator.com/item?id=13918465 - useful links in here! Some of the links are dead but can be accessed with internet archive.</p>
</li>
<li>
<p>https://www.youtube.com/watch?v=ZtTqRH1uwu4</p>
</li>
</ul>
<h3 id="note-on-my-confusion-with-wolfram-language">Note on my confusion with Wolfram Language</h3>
<p>So far I have been able to identify WL expressions like <code>f[x,y]</code> 
with LISP expressions <code>(f x y)</code>. But this nice correspondence is slightly 
broken in this chapter. </p>
<p>In Mathematica, <code>List[Quote[a],Quote[b],Quote[c]]</code> is different from <code>Quote[List[a,b,c]]</code> (you could compare them using <code>===</code>).</p>
<p>But in Scheme, it appears <code>(list 'a 'b 'c)</code> and <code>'(a b c)</code> are the same (compare with <code>equal?</code>).</p>
<p>If we had the perfect correspondence</p>
<p><code>(f x y)</code> &lt;=&gt; <code>f[x,y]</code></p>
<p>Then I would assume quoting might give something like this:</p>
<p><code>'(f x y)</code> &lt;=&gt; <code>"f"["x","y"]</code> (because <code>"f[x,y]"</code> seems too boring)</p>
<p>But in fact it seems like the correspondence is more akin to:</p>
<p><code>'(f x y)</code> &lt;=&gt; <code>List["f","x","y"]</code>.</p>
<p>This might be the first thing that is a strict difference in convention between WL and Lisp.</p>
<p><em>Note to reader:</em> I'm not sure of this! Those are just my thoughts while learning.</p>
<div class="code-box">
<div class="code-header"><a href="code/ex2-53b.rkt">code/ex2-53b.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">racket</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">quoted-list</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">list-of-quotes</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">b</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">c</span><span class="p">))</span>

<span class="p">(</span><span class="nb">displayln</span><span class="w"> </span><span class="s2">&quot;Are (list &#39;a &#39;b &#39;c) and &#39;(a b c) structurally equal?&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">displayln</span><span class="w"> </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">b</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">c</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="p">)))</span><span class="w"> </span><span class="c1">; =&gt; #t</span>
<span class="p">(</span><span class="nb">displayln</span><span class="w"> </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="k">quote</span><span class="w"> </span><span class="ss">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">quote</span><span class="w"> </span><span class="ss">b</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">quote</span><span class="w"> </span><span class="ss">c</span><span class="p">))</span><span class="w"> </span>
<span class="w">                   </span><span class="p">(</span><span class="k">quote</span><span class="w"> </span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="p">))))</span><span class="w"> </span><span class="c1">; =&gt; #t</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>Are (list &#x27;a &#x27;b &#x27;c) and &#x27;(a b c) structurally equal?
#t
#t
</pre>
</div>
</div>

<div class="code-box">
<div class="code-header"><a href="code/ex2-53b.wl">code/ex2-53b.wl</a></div>

<div class="codehilite"><pre><span></span><code><span class="n">expr1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">List</span><span class="o">[</span><span class="n">Quote[a</span><span class="o">]</span><span class="p">,</span><span class="n">Quote</span><span class="o">[</span><span class="n">b</span><span class="o">]</span><span class="p">,</span><span class="n">Quote</span><span class="o">[</span><span class="n">c</span><span class="o">]</span><span class="err">]</span><span class="p">;</span>
<span class="n">expr2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Quote</span><span class="o">[</span><span class="n">List[a,b,c</span><span class="o">]</span><span class="err">]</span><span class="p">;</span>
<span class="n">expr1</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">expr2</span>
</code></pre></div>


</div>

<p>Silly aside about @@:</p>
<div class="code-box">
<div class="code-header"><a href="code/ex2-53c.rkt">code/ex2-53c.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">@@</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="n">lst</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">lst</span><span class="p">)))</span>

<span class="p">(</span><span class="n">@@</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">g</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">f</span><span class="w"> </span><span class="ss">x</span><span class="w"> </span><span class="ss">y</span><span class="p">))</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>(g x y)
</pre>
</div>
</div>

<p>Tamwile in twitch chat says this is the equivalent in prolog:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">% Request to prolog.</span>
<span class="s s-Atom">?-</span> <span class="nf">foo</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span><span class="nv">Y</span><span class="p">)</span> <span class="s s-Atom">=..</span> <span class="p">[</span><span class="nv">Head</span><span class="p">|</span><span class="nv">Tail</span><span class="p">],</span> <span class="nv">New</span> <span class="s s-Atom">=..</span> <span class="p">[</span><span class="s s-Atom">bar</span><span class="p">|</span><span class="nv">Tail</span><span class="p">].</span>
<span class="c1">% Answer of prolog</span>
   <span class="nv">Head</span> <span class="o">=</span> <span class="s s-Atom">foo</span><span class="p">,</span> <span class="nv">Tail</span> <span class="o">=</span> <span class="p">[</span><span class="nv">X</span><span class="p">,</span><span class="nv">Y</span><span class="p">],</span> <span class="nv">New</span> <span class="o">=</span> <span class="nf">bar</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span><span class="nv">Y</span><span class="p">).</span>
</code></pre></div>

<h3 id="experimenting-w-derivatives">Experimenting w/ derivatives</h3>
<div class="code-box">
<div class="code-header"><a href="code/symbolic-deriv.rkt">code/symbolic-deriv.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol?</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="n">a2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="n">=number?</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">a2</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="n">=number?</span><span class="w"> </span><span class="n">a2</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">a1</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="n">a1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="n">a2</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="n">a2</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">+</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="n">a2</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="n">m2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="n">=number?</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="n">=number?</span><span class="w"> </span><span class="n">m2</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">         </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="n">=number?</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">m2</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="n">=number?</span><span class="w"> </span><span class="n">m2</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">m1</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="n">m1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="n">m2</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="n">m2</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">*</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="n">m2</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=number?</span><span class="w"> </span><span class="nb">exp</span><span class="w"> </span><span class="n">num</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="nb">exp</span><span class="w"> </span><span class="n">num</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sum?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">pair?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">+</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">addend</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">s</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">augend</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">caddr</span><span class="w"> </span><span class="n">s</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">product?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">pair?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">*</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">multiplier</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">multiplicand</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">caddr</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">exponentiation?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">pair?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">**</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">base</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">exponent</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">caddr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-exponentiation</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="n">=number?</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="n">=number?</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="n">=number?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">**</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))))</span>


<span class="w"> </span><span class="c1">;(list &#39;^ a b))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="nb">exp</span><span class="w"> </span><span class="n">var</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="n">variable?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="nb">exp</span><span class="w"> </span><span class="n">var</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="n">sum?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">addend</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="p">)</span>
<span class="w">                   </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">augend</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="p">)))</span>
<span class="w">        </span><span class="p">((</span><span class="n">product?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-sum</span>
<span class="w">          </span><span class="p">(</span><span class="n">make-product</span>
<span class="w">           </span><span class="p">(</span><span class="n">multiplier</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">multiplicand</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="n">make-product</span>
<span class="w">           </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">multiplier</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="n">multiplicand</span><span class="w"> </span><span class="nb">exp</span><span class="p">))))</span>
<span class="w">        </span><span class="p">((</span><span class="n">exponentiation?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-product</span>
<span class="w">          </span><span class="p">(</span><span class="n">make-product</span>
<span class="w">           </span><span class="p">(</span><span class="n">exponent</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="n">make-exponentiation</span><span class="w"> </span><span class="p">(</span><span class="n">base</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="p">(</span><span class="n">exponent</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="mi">-1</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">base</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;unknown expression</span>
<span class="s2">                      type: DERIV&quot;</span><span class="w"> </span><span class="nb">exp</span><span class="p">))))</span>
<span class="c1">;; (1+a)*b*b</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">b</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">b</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">b</span><span class="p">)</span>
<span class="c1">;; (+ (* (+ 1 a) b) (* (+ 1 a) b))</span>
<span class="c1">;; = 2(1+a)b. Correct!</span>

<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-exponentiation</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-exponentiation</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-exponentiation</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>

<span class="c1">;;d((y*(x+2))**2)/dx = 2y**2 * (x+2)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-exponentiation</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>(+ (* (+ 1 a) b) (* (+ 1 a) b))
(* 3 (** x 2))
(* 2 x)
1
(* (* 2 (* y (+ x 2))) y)
</pre>
</div>
</div>

<h3 id="exercises">Exercises</h3>
<h4 id="exercise-253">Exercise 2.53</h4>
<p>What would the interpreter print
in response to evaluating each of the following expressions?</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">b</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">c</span><span class="p">)</span>
<span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">george</span><span class="p">))</span>
<span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="ss">x1</span><span class="w"> </span><span class="ss">x2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">y1</span><span class="w"> </span><span class="ss">y2</span><span class="p">)))</span>
<span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="ss">x1</span><span class="w"> </span><span class="ss">x2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">y1</span><span class="w"> </span><span class="ss">y2</span><span class="p">)))</span>
<span class="p">(</span><span class="nb">pair?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">short</span><span class="w"> </span><span class="ss">list</span><span class="p">)))</span>
<span class="p">(</span><span class="nb">memq</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">red</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="ss">red</span><span class="w"> </span><span class="ss">shoes</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">blue</span><span class="w"> </span><span class="ss">socks</span><span class="p">)))</span>
<span class="p">(</span><span class="nb">memq</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">red</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">red</span><span class="w"> </span><span class="ss">shoes</span><span class="w"> </span><span class="ss">blue</span><span class="w"> </span><span class="ss">socks</span><span class="p">))</span>
</code></pre></div>

<h5>Solution</h5>
<div class="code-box">
<div class="code-header"><a href="code/ex2-53.rkt">code/ex2-53.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">b</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">c</span><span class="p">)</span>
<span class="c1">;; (a b c)</span>

<span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">george</span><span class="p">))</span>
<span class="c1">;; ((george))</span>

<span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="ss">x1</span><span class="w"> </span><span class="ss">x2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">y1</span><span class="w"> </span><span class="ss">y2</span><span class="p">)))</span>
<span class="c1">;; ((y1 y2)), a list with one element &#39;(y1 y2)</span>

<span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="ss">x1</span><span class="w"> </span><span class="ss">x2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">y1</span><span class="w"> </span><span class="ss">y2</span><span class="p">)))</span>
<span class="c1">;; (y1 y2), the car of the previous result</span>

<span class="p">(</span><span class="nb">pair?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">short</span><span class="w"> </span><span class="ss">list</span><span class="p">)))</span>
<span class="c1">;; false, (car &#39;(a short list)) is just &#39;a</span>

<span class="p">(</span><span class="nb">memq</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">red</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="ss">red</span><span class="w"> </span><span class="ss">shoes</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">blue</span><span class="w"> </span><span class="ss">socks</span><span class="p">)))</span>
<span class="c1">;; false, &#39;red is not a member of the list, &#39;(red shoes) is.</span>

<span class="p">(</span><span class="nb">memq</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">red</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">red</span><span class="w"> </span><span class="ss">shoes</span><span class="w"> </span><span class="ss">blue</span><span class="w"> </span><span class="ss">socks</span><span class="p">))</span>
<span class="c1">;; (red shoes blue socks), the element is found so memq returns the list </span>
<span class="c1">;; after and including &#39;red.</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>(a b c)
((george))
((y1 y2))
(y1 y2)
#f
#f
(red shoes blue socks)
</pre>
</div>
</div>

<h4 id="exercise-254">Exercise 2.54</h4>
<p>Two lists are said to be
<code>equal?</code> if they contain equal elements arranged in the same order.  For
example,</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">this</span><span class="w"> </span><span class="ss">is</span><span class="w"> </span><span class="ss">a</span><span class="w"> </span><span class="ss">list</span><span class="p">)</span><span class="w"> </span>
<span class="w">        </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">this</span><span class="w"> </span><span class="ss">is</span><span class="w"> </span><span class="ss">a</span><span class="w"> </span><span class="ss">list</span><span class="p">))</span>
</code></pre></div>

<p>is true, but</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">this</span><span class="w"> </span><span class="ss">is</span><span class="w"> </span><span class="ss">a</span><span class="w"> </span><span class="ss">list</span><span class="p">)</span><span class="w"> </span>
<span class="w">        </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">this</span><span class="w"> </span><span class="p">(</span><span class="ss">is</span><span class="w"> </span><span class="ss">a</span><span class="p">)</span><span class="w"> </span><span class="ss">list</span><span class="p">))</span>
</code></pre></div>

<p>is false.  To be more precise, we can define <code>equal?</code>  recursively in
terms of the basic <code>eq?</code> equality of symbols by saying that <code>a</code> and
<code>b</code> are <code>equal?</code> if they are both symbols and the symbols are
<code>eq?</code>, or if they are both lists such that <code>(car a)</code> is <code>equal?</code>
to <code>(car b)</code> and <code>(cdr a)</code> is <code>equal?</code> to <code>(cdr b)</code>.  Using
this idea, implement <code>equal?</code> as a procedure.</p>
<h5>Solution</h5>
<div class="code-box">
<div class="code-header"><a href="code/ex2-54.rkt">code/ex2-54.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol?</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol?</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">pair?</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">pair?</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span>
<span class="w">           </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="w">           </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">b</span><span class="p">)))))</span>

<span class="c1">;;Some test cases:</span>
<span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">this</span><span class="w"> </span><span class="ss">is</span><span class="w"> </span><span class="ss">a</span><span class="w"> </span><span class="ss">list</span><span class="p">)</span><span class="w"> </span>
<span class="w">        </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">this</span><span class="w"> </span><span class="ss">is</span><span class="w"> </span><span class="ss">a</span><span class="w"> </span><span class="ss">list</span><span class="p">))</span>
<span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">this</span><span class="w"> </span><span class="ss">is</span><span class="w"> </span><span class="ss">a</span><span class="w"> </span><span class="ss">list</span><span class="p">)</span><span class="w"> </span>
<span class="w">        </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">this</span><span class="w"> </span><span class="p">(</span><span class="ss">is</span><span class="w"> </span><span class="ss">a</span><span class="p">)</span><span class="w"> </span><span class="ss">list</span><span class="p">))</span>
<span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">this</span><span class="w"> </span><span class="p">(</span><span class="ss">is</span><span class="w"> </span><span class="ss">a</span><span class="p">)</span><span class="w"> </span><span class="ss">list</span><span class="p">)</span><span class="w"> </span>
<span class="w">        </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">this</span><span class="w"> </span><span class="p">(</span><span class="ss">is</span><span class="w"> </span><span class="ss">a</span><span class="p">)</span><span class="w"> </span><span class="ss">list</span><span class="p">))</span>
<span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="p">))</span>

<span class="c1">;; Failure case! </span>
<span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>#t
#f
#t
#f
#f
</pre>
</div>
</div>

<p>This bugs me, because it will fail when comparing non-symbol lists like
<code>(equal? (list 1 2 3) (list 1 2 3))</code>. But we're doing what the problems says
so let's just move on.</p>
<h4 id="exercise-255">Exercise 2.55</h4>
<p>Eva Lu Ator types to the interpreter the expression</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="o">&#39;&#39;</span><span class="ss">abracadabra</span><span class="p">)</span>
</code></pre></div>

<p>To her surprise, the interpreter prints back <code>quote</code>.  Explain.</p>
<h5>Solution</h5>
<p>We have <code>(quote (quote abracadabra))</code> in the inner expression.
The first quote is evaluated leaving the inner expression
<code>(list 'quote 'abracadabra)</code>. Of course the car of this is <code>'quote</code>!</p>
<h4 id="exercise-256">Exercise 2.56</h4>
<p>Show how to extend the basic
differentiator to handle more kinds of expressions.  For instance, implement
the differentiation rule</p>
<p>$${d(u^{\kern0.1ex n}) \over dx} \,=\, {nu^{\kern0.1ex n-1} \, {du \over dx}}  $$</p>
<p>by adding a new clause to the <code>deriv</code> program and defining appropriate
procedures <code>exponentiation?</code>, <code>base</code>, <code>exponent</code>, and
<code>make-exponentiation</code>.  (You may use the symbol <code>**</code> to denote
exponentiation.)  Build in the rules that anything raised to the power 0 is 1
and anything raised to the power 1 is the thing itself.</p>
<h5>Solution</h5>
<p>Differentiation with respect to something in the exponent will be incorrect silently! (We'd need logs)</p>
<div class="code-box">
<div class="code-header"><a href="code/ex2-56.rkt">code/ex2-56.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol?</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="n">a2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="n">=number?</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">a2</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="n">=number?</span><span class="w"> </span><span class="n">a2</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">a1</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="n">a1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="n">a2</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="n">a2</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">+</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="n">a2</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="n">m2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="n">=number?</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="n">=number?</span><span class="w"> </span><span class="n">m2</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">         </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="n">=number?</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">m2</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="n">=number?</span><span class="w"> </span><span class="n">m2</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">m1</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="n">m1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="n">m2</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="n">m2</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">*</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="n">m2</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=number?</span><span class="w"> </span><span class="nb">exp</span><span class="w"> </span><span class="n">num</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="nb">exp</span><span class="w"> </span><span class="n">num</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sum?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">pair?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">+</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">addend</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">s</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">augend</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">caddr</span><span class="w"> </span><span class="n">s</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">product?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">pair?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">*</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">multiplier</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">multiplicand</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">caddr</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">exponentiation?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">pair?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">**</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">base</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">exponent</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">caddr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-exponentiation</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="n">=number?</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="n">=number?</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="n">=number?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">**</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))))</span>


<span class="w"> </span><span class="c1">;(list &#39;^ a b))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="nb">exp</span><span class="w"> </span><span class="n">var</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="n">variable?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="nb">exp</span><span class="w"> </span><span class="n">var</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="n">sum?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">addend</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="p">)</span>
<span class="w">                   </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">augend</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="p">)))</span>
<span class="w">        </span><span class="p">((</span><span class="n">product?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-sum</span>
<span class="w">          </span><span class="p">(</span><span class="n">make-product</span>
<span class="w">           </span><span class="p">(</span><span class="n">multiplier</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">multiplicand</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="n">make-product</span>
<span class="w">           </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">multiplier</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="n">multiplicand</span><span class="w"> </span><span class="nb">exp</span><span class="p">))))</span>
<span class="w">        </span><span class="p">((</span><span class="n">exponentiation?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-product</span>
<span class="w">          </span><span class="p">(</span><span class="n">make-product</span>
<span class="w">           </span><span class="p">(</span><span class="n">exponent</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="n">make-exponentiation</span><span class="w"> </span><span class="p">(</span><span class="n">base</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="p">(</span><span class="n">exponent</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="mi">-1</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">base</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;unknown expression</span>
<span class="s2">                      type: DERIV&quot;</span><span class="w"> </span><span class="nb">exp</span><span class="p">))))</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-exponentiation</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-exponentiation</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-exponentiation</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>

<span class="c1">;;d((y*(x+2))**2)/dx = 2y**2 * (x+2)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-exponentiation</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>(* 3 (** x 2))
(* 2 x)
1
(* (* 2 (* y (+ x 2))) y)
</pre>
</div>
</div>

<h4 id="exercise-257">Exercise 2.57</h4>
<p>Extend the differentiation
program to handle sums and products of arbitrary numbers of (two or more)
terms.  Then the last example above could be expressed as</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">*</span><span class="w"> </span><span class="ss">x</span><span class="w"> </span><span class="ss">y</span><span class="w"> </span><span class="p">(</span><span class="ss">+</span><span class="w"> </span><span class="ss">x</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
</code></pre></div>

<p>Try to do this by changing only the representation for sums and products,
without changing the <code>deriv</code> procedure at all.  For example, the
<code>addend</code> of a sum would be the first term, and the <code>augend</code> would be
the sum of the rest of the terms.</p>
<h5>Solution</h5>
<p>Some stuff we're not going to handle:</p>
<ul>
<li><code>make-sum</code> and <code>make-product</code> with multiple arguments and dotted tail notation,</li>
<li>Sorting expressions. ie without too much work we could automatically simplify
<code>(+ (* x 2) (* 2 y))</code> by sorting arguments and combining when equal.</li>
</ul>
<div class="code-box">
<div class="code-header"><a href="code/ex2-57.rkt">code/ex2-57.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol?</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">numorvar?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="n">a2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="n">=number?</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">a2</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="n">=number?</span><span class="w"> </span><span class="n">a2</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">a1</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="n">a1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="n">a2</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="n">a2</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">sum?</span><span class="w"> </span><span class="n">a1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numorvar?</span><span class="w"> </span><span class="n">a2</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">a2</span><span class="p">)))</span>
<span class="w">        </span><span class="p">((</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">sum?</span><span class="w"> </span><span class="n">a2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numorvar?</span><span class="w"> </span><span class="n">a1</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">+</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">a1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">a2</span><span class="p">))))</span>
<span class="w">        </span><span class="p">((</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">sum?</span><span class="w"> </span><span class="n">a1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">sum?</span><span class="w"> </span><span class="n">a2</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">a2</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">+</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="n">a2</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="n">m2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="n">=number?</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="n">=number?</span><span class="w"> </span><span class="n">m2</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">         </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="n">=number?</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">m2</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="n">=number?</span><span class="w"> </span><span class="n">m2</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">m1</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="n">m1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="n">m2</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="n">m2</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">product?</span><span class="w"> </span><span class="n">m1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numorvar?</span><span class="w"> </span><span class="n">m2</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">m2</span><span class="p">)))</span>
<span class="w">        </span><span class="p">((</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">product?</span><span class="w"> </span><span class="n">m2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">numorvar?</span><span class="w"> </span><span class="n">m1</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">*</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">m1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">m2</span><span class="p">))))</span>
<span class="w">        </span><span class="p">((</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">product?</span><span class="w"> </span><span class="n">m1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">product?</span><span class="w"> </span><span class="n">m2</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">m2</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">*</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="n">m2</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=number?</span><span class="w"> </span><span class="nb">exp</span><span class="w"> </span><span class="n">num</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="nb">exp</span><span class="w"> </span><span class="n">num</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sum?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">pair?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">+</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">addend</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">s</span><span class="p">))</span>
<span class="c1">;; (define (augend s) (caddr s))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">augend</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">cddr</span><span class="w"> </span><span class="n">s</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">r</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">+</span><span class="p">)</span><span class="w"> </span><span class="n">r</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">r</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">product?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">pair?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">*</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">multiplier</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>

<span class="c1">;; Now this is going to return...</span>
<span class="c1">;;   A number if it&#39;s a list of length 2</span>
<span class="c1">;;   A (&#39;* p) if it&#39;s a longer list</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">multiplicand</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb">cddr</span><span class="w"> </span><span class="n">p</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">r</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">*</span><span class="p">)</span><span class="w"> </span><span class="n">r</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">r</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="nb">exp</span><span class="w"> </span><span class="n">var</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="n">variable?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="nb">exp</span><span class="w"> </span><span class="n">var</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="n">sum?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">addend</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="p">)</span>
<span class="w">                   </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">augend</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="p">)))</span>
<span class="w">        </span><span class="p">((</span><span class="n">product?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-sum</span>
<span class="w">          </span><span class="p">(</span><span class="n">make-product</span>
<span class="w">           </span><span class="p">(</span><span class="n">multiplier</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">multiplicand</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="n">make-product</span>
<span class="w">           </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">multiplier</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="n">multiplicand</span><span class="w"> </span><span class="nb">exp</span><span class="p">))))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;unknown expression</span>
<span class="s2">                      type: DERIV&quot;</span><span class="w"> </span><span class="nb">exp</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;make-product tests&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="p">)</span>
<span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">z</span><span class="p">))</span>
<span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">))</span>
<span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">))</span>

<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;make-sum tests&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="p">)</span>
<span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">z</span><span class="p">))</span>
<span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">))</span>
<span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">))</span>

<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;deriv and make-product tests&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">z</span><span class="p">))</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">))</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">))</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>

<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;sum and make-sum tests&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">z</span><span class="p">))</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">))</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">))</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>
make-product tests
(* x y)
(* x y z)
(* 4 2 x)
(* a x 2 x)

make-sum tests
(+ x y)
(+ x y z)
(+ 4 2 x)
(+ a x 2 x)

deriv and make-product tests
y
(* y z)
8
(* a (+ (* x 2) (* 2 x)))

sum and make-sum tests
1
1
1
2
</pre>
</div>
</div>

<h4 id="exercise-258">Exercise 2.58</h4>
<p>Suppose we want to modify the
differentiation program so that it works with ordinary mathematical notation,
in which <code>+</code> and <code>*</code> are infix rather than prefix operators.  Since
the differentiation program is defined in terms of abstract data, we can modify
it to work with different representations of expressions solely by changing the
predicates, selectors, and constructors that define the representation of the
algebraic expressions on which the differentiator is to operate.</p>
<p><strong>1.</strong> Show how to do this in order to differentiate algebraic expressions presented
in infix form, such as <code>(x + (3 * (x + (y + 2))))</code>.  To simplify the task,
assume that <code>+</code> and <code>*</code> always take two arguments and that
expressions are fully parenthesized.</p>
<p><strong>2.</strong> The problem becomes substantially harder if we allow standard algebraic
notation, such as <code>(x + 3 * (x + y + 2))</code>, which drops unnecessary
parentheses and assumes that multiplication is done before addition.  Can you
design appropriate predicates, selectors, and constructors for this notation
such that our derivative program still works?</p>
<h5>Solution</h5>
<p>For part 1, it's easy, we just have to adjust <code>make-***</code> and <code>augend,addend,multiplier,multiplicand</code>. </p>
<div class="code-box">
<div class="code-header"><a href="code/ex2-58.rkt">code/ex2-58.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol?</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">numorvar?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="n">a2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="n">=number?</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">a2</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="n">=number?</span><span class="w"> </span><span class="n">a2</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">a1</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="n">a1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="n">a2</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="n">a2</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">+</span><span class="w"> </span><span class="n">a2</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="n">m2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="n">=number?</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="n">=number?</span><span class="w"> </span><span class="n">m2</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">         </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="n">=number?</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">m2</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="n">=number?</span><span class="w"> </span><span class="n">m2</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">m1</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="n">m1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="n">m2</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="n">m2</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">*</span><span class="w"> </span><span class="n">m2</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=number?</span><span class="w"> </span><span class="nb">exp</span><span class="w"> </span><span class="n">num</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="nb">exp</span><span class="w"> </span><span class="n">num</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sum?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">pair?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">+</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">addend</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">s</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">augend</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">caddr</span><span class="w"> </span><span class="n">s</span><span class="p">))</span><span class="w"> </span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">product?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">pair?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">*</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">multiplier</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">multiplicand</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">caddr</span><span class="w"> </span><span class="n">p</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="nb">exp</span><span class="w"> </span><span class="n">var</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="n">variable?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="nb">exp</span><span class="w"> </span><span class="n">var</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="n">sum?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">addend</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="p">)</span>
<span class="w">                   </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">augend</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="p">)))</span>
<span class="w">        </span><span class="p">((</span><span class="n">product?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-sum</span>
<span class="w">          </span><span class="p">(</span><span class="n">make-product</span>
<span class="w">           </span><span class="p">(</span><span class="n">multiplier</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">multiplicand</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="n">make-product</span>
<span class="w">           </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">multiplier</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="n">multiplicand</span><span class="w"> </span><span class="nb">exp</span><span class="p">))))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;unknown expression</span>
<span class="s2">                      type: DERIV&quot;</span><span class="w"> </span><span class="nb">exp</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;make-product tests&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="p">)</span>
<span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">z</span><span class="p">))</span>
<span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">))</span>
<span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">))</span>

<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;make-sum tests&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="p">)</span>
<span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">z</span><span class="p">))</span>
<span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">))</span>
<span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">))</span>

<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;deriv and make-product tests&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">z</span><span class="p">))</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">))</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">))</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>

<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;sum and make-sum tests&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">z</span><span class="p">))</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">))</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">))</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>
make-product tests
(x * y)
(x * (y * z))
(4 * (2 * x))
((a * x) * (2 * x))

make-sum tests
(x + y)
(x + (y + z))
(4 + (2 + x))
((a + x) + (2 + x))

deriv and make-product tests
y
(y * z)
8
(((a * x) * 2) + (a * (2 * x)))

sum and make-sum tests
1
1
1
2
</pre>
</div>
</div>

<p>For part 2, we can definitely just modify the accessors to get the correct results.</p>
<div class="code-box">
<div class="code-header"><a href="code/ex2-58b.rkt">code/ex2-58b.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol?</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="n">v2</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">numorvar?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="n">variable?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="n">a2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="n">=number?</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">a2</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="n">=number?</span><span class="w"> </span><span class="n">a2</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">a1</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="n">a1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="n">a2</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="n">a2</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">+</span><span class="w"> </span><span class="n">a2</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="n">m2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="n">=number?</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="n">=number?</span><span class="w"> </span><span class="n">m2</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">         </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="n">=number?</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">m2</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="n">=number?</span><span class="w"> </span><span class="n">m2</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">m1</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="n">m1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="n">m2</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="n">m2</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">*</span><span class="w"> </span><span class="n">m2</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">=number?</span><span class="w"> </span><span class="nb">exp</span><span class="w"> </span><span class="n">num</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">number?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="nb">exp</span><span class="w"> </span><span class="n">num</span><span class="p">)))</span>

<span class="c1">;; Return false if element doesn&#39;t exist</span>
<span class="c1">;; Return list otherwise.</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">take-after</span><span class="w"> </span><span class="n">elem</span><span class="w"> </span><span class="n">lst</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">rst</span><span class="w"> </span><span class="p">(</span><span class="nb">memq</span><span class="w"> </span><span class="n">elem</span><span class="w"> </span><span class="n">lst</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="n">rst</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span><span class="w"> </span><span class="n">rst</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">rst</span><span class="p">))))</span>

<span class="c1">;; Return false if element doesn&#39;t exist</span>
<span class="c1">;; Return list otherwise.</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">take-before</span><span class="w"> </span><span class="n">elem</span><span class="w"> </span><span class="n">lst</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">lst</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">eq?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">lst</span><span class="p">)</span><span class="w"> </span><span class="n">elem</span><span class="p">)</span><span class="w"> </span><span class="n">nil</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">rst</span><span class="w"> </span><span class="p">(</span><span class="n">take-before</span><span class="w"> </span><span class="n">elem</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">lst</span><span class="p">))))</span>
<span class="w">                </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="n">rst</span><span class="p">)</span><span class="w"> </span>
<span class="w">                  </span><span class="n">rst</span><span class="w"> </span>
<span class="w">                  </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">lst</span><span class="p">)</span><span class="w"> </span><span class="n">rst</span><span class="p">))))))</span>

<span class="c1">;; True if a &#39;+ exists in our expression.</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">sum?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">pair?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="p">(</span><span class="nb">memq</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">+</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">))))</span>
<span class="c1">;; Take from the first symbol, up to but excluding &#39;+</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">addend</span><span class="w"> </span><span class="n">s</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">rst</span><span class="w"> </span><span class="p">(</span><span class="n">take-before</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">+</span><span class="w"> </span><span class="n">s</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">rst</span><span class="p">))</span><span class="w"> </span><span class="n">rst</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">rst</span><span class="p">))))</span>
<span class="c1">;; Exclude the first terms up to &#39;+ and return the rest (?)</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">augend</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">rst</span><span class="w"> </span><span class="p">(</span><span class="n">take-after</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">+</span><span class="w"> </span><span class="n">s</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">rst</span><span class="p">))</span><span class="w"> </span><span class="n">rst</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">rst</span><span class="p">))))</span>
<span class="c1">;; True if no &#39;+ exists in our expression, but &#39;* does.</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">product?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">pair?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="n">sum?</span><span class="w"> </span><span class="n">x</span><span class="p">))</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="p">(</span><span class="nb">memq</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">*</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">))))</span>
<span class="c1">;; take up to and excluding the first &#39;*</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">multiplier</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">rst</span><span class="w"> </span><span class="p">(</span><span class="n">take-before</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">*</span><span class="w"> </span><span class="n">p</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">rst</span><span class="p">))</span><span class="w"> </span><span class="n">rst</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">rst</span><span class="p">))))</span>
<span class="c1">;; Get the rest after the first &#39;*</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">multiplicand</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">rst</span><span class="w"> </span><span class="p">(</span><span class="n">take-after</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">*</span><span class="w"> </span><span class="n">p</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">rst</span><span class="p">))</span><span class="w"> </span><span class="n">rst</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">rst</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="nb">exp</span><span class="w"> </span><span class="n">var</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">number?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="n">variable?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same-variable?</span><span class="w"> </span><span class="nb">exp</span><span class="w"> </span><span class="n">var</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="n">sum?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">addend</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="p">)</span>
<span class="w">                   </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">augend</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="p">)))</span>
<span class="w">        </span><span class="p">((</span><span class="n">product?</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-sum</span>
<span class="w">          </span><span class="p">(</span><span class="n">make-product</span>
<span class="w">           </span><span class="p">(</span><span class="n">multiplier</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">multiplicand</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="n">make-product</span>
<span class="w">           </span><span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">multiplier</span><span class="w"> </span><span class="nb">exp</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="n">multiplicand</span><span class="w"> </span><span class="nb">exp</span><span class="p">))))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;unknown expression</span>
<span class="s2">                      type: DERIV&quot;</span><span class="w"> </span><span class="nb">exp</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;make-product tests&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="p">)</span>
<span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">z</span><span class="p">))</span>
<span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">))</span>
<span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">))</span>

<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;make-sum tests&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="p">)</span>
<span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">z</span><span class="p">))</span>
<span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">))</span>
<span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">))</span>

<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;deriv and make-product tests&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">z</span><span class="p">))</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">))</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-product</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">))</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>

<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;sum and make-sum tests&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">z</span><span class="p">))</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">))</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">a</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-sum</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">))</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>


<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Another example&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">x</span><span class="w"> </span><span class="ss">+</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="ss">*</span><span class="w"> </span><span class="p">(</span><span class="ss">x</span><span class="w"> </span><span class="ss">*</span><span class="w"> </span><span class="ss">x</span><span class="w"> </span><span class="ss">+</span><span class="w"> </span><span class="ss">y</span><span class="w"> </span><span class="ss">+</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">x</span><span class="p">)</span>
<span class="p">(</span><span class="n">deriv</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">x</span><span class="w"> </span><span class="ss">+</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="ss">*</span><span class="w"> </span><span class="p">(</span><span class="ss">x</span><span class="w"> </span><span class="ss">*</span><span class="w"> </span><span class="ss">x</span><span class="w"> </span><span class="ss">+</span><span class="w"> </span><span class="ss">y</span><span class="w"> </span><span class="ss">+</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">y</span><span class="p">)</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>
make-product tests
(x * y)
(x * (y * z))
(4 * (2 * x))
((a * x) * (2 * x))

make-sum tests
(x + y)
(x + (y + z))
(4 + (2 + x))
((a + x) + (2 + x))

deriv and make-product tests
y
(y * z)
8
(((a * x) * 2) + (a * (2 * x)))

sum and make-sum tests
1
1
1
2

Another example
(1 + (3 * (x + x)))
3
</pre>
</div>
</div>

<!-- For part 2, One way we can easily do this is: On the top level of a list, make a list of all summands and recurse `(deriv term sym)`. If there are no sums. make a list of all products and recurse in the more complicated product rule form. -->

<h4 id="exercise-259">Exercise 2.59</h4>
<p>Implement the <code>union-set</code>
operation for the unordered-list representation of sets.</p>
<h5>Solution</h5>
<p>My impl reverses the order of elements, which is ugly, but whatever.</p>
<div class="code-box">
<div class="code-header"><a href="code/ex2-59.rkt">code/ex2-59.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">element-of-set?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span><span class="w"> </span><span class="k">false</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nb">set</span><span class="p">))</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">element-of-set?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nb">set</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">element-of-set?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span>
<span class="w">      </span><span class="nb">set</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">set</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">intersection-set</span><span class="w"> </span><span class="n">set1</span><span class="w"> </span><span class="n">set2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">set2</span><span class="p">))</span><span class="w"> </span>
<span class="w">         </span><span class="o">&#39;</span><span class="p">())</span>
<span class="w">        </span><span class="p">((</span><span class="n">element-of-set?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span><span class="w"> </span><span class="n">set2</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="n">intersection-set</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span><span class="w"> </span>
<span class="w">                                 </span><span class="n">set2</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">intersection-set</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span><span class="w"> </span>
<span class="w">                                </span><span class="n">set2</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">union-set</span><span class="w"> </span><span class="n">gset1</span><span class="w"> </span><span class="n">gset2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">union-set-helper</span><span class="w"> </span><span class="n">set1</span><span class="w"> </span><span class="n">set2</span><span class="w"> </span><span class="n">ret</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">set2</span><span class="p">))</span><span class="w"> </span><span class="n">ret</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">union-set-helper</span><span class="w"> </span><span class="n">set2</span><span class="w"> </span><span class="n">set1</span><span class="w"> </span><span class="n">ret</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">element-of-set?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span><span class="w"> </span><span class="n">ret</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">union-set-helper</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span><span class="w"> </span><span class="n">set2</span><span class="w"> </span><span class="n">ret</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="n">union-set-helper</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span><span class="w"> </span><span class="n">set2</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span><span class="w"> </span><span class="n">ret</span><span class="p">))))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">union-set-helper</span><span class="w"> </span><span class="n">gset1</span><span class="w"> </span><span class="n">gset2</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">set1</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="w"> </span><span class="ss">d</span><span class="w"> </span><span class="ss">e</span><span class="w"> </span><span class="ss">f</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">set2</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">c</span><span class="w"> </span><span class="ss">d</span><span class="w"> </span><span class="ss">e</span><span class="w"> </span><span class="ss">f</span><span class="w"> </span><span class="ss">g</span><span class="w"> </span><span class="ss">h</span><span class="w"> </span><span class="ss">i</span><span class="p">))</span>

<span class="p">(</span><span class="n">intersection-set</span><span class="w"> </span><span class="n">set1</span><span class="w"> </span><span class="n">set2</span><span class="p">)</span>
<span class="p">(</span><span class="n">union-set</span><span class="w"> </span><span class="n">set1</span><span class="w"> </span><span class="n">set2</span><span class="p">)</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>(c d e f)
(i h g f e d c b a)
</pre>
</div>
</div>

<h4 id="exercise-260">Exercise 2.60</h4>
<p>We specified that a set would be
represented as a list with no duplicates.  Now suppose we allow duplicates.
For instance, the set ${1, 2, 3}$ could be represented as the list <code>(2 3 2 1
3 2 2)</code>.  Design procedures <code>element-of-set?</code>, <code>adjoin-set</code>,
<code>union-set</code>, and <code>intersection-set</code> that operate on this
representation.  How does the efficiency of each compare with the corresponding
procedure for the non-duplicate representation?  Are there applications for
which you would use this representation in preference to the non-duplicate one?</p>
<h5>Solution</h5>
<div class="code-box">
<div class="code-header"><a href="code/ex2-60.rkt">code/ex2-60.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">element-of-set?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span><span class="w"> </span><span class="k">false</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nb">set</span><span class="p">))</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">element-of-set?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nb">set</span><span class="p">)))))</span>

<span class="c1">; Theta(1)</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">set</span><span class="p">))</span>

<span class="c1">;; Theta(n^2)</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">intersection-set</span><span class="w"> </span><span class="n">set1</span><span class="w"> </span><span class="n">set2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">set2</span><span class="p">))</span><span class="w"> </span>
<span class="w">         </span><span class="o">&#39;</span><span class="p">())</span>
<span class="w">        </span><span class="p">((</span><span class="n">element-of-set?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span><span class="w"> </span><span class="n">set2</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="n">intersection-set</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span><span class="w"> </span>
<span class="w">                                 </span><span class="n">set2</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">intersection-set</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span><span class="w"> </span>
<span class="w">                                </span><span class="n">set2</span><span class="p">))))</span>

<span class="c1">;; Theta(1) (or, if append is implemented with (length gset1) calls to cons, it&#39;s Theta(n))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">union-set</span><span class="w"> </span><span class="n">gset1</span><span class="w"> </span><span class="n">gset2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="n">gset1</span><span class="w"> </span><span class="n">gset2</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">set1</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">a</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="ss">c</span><span class="w"> </span><span class="ss">d</span><span class="w"> </span><span class="ss">e</span><span class="w"> </span><span class="ss">f</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">set2</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">c</span><span class="w"> </span><span class="ss">d</span><span class="w"> </span><span class="ss">e</span><span class="w"> </span><span class="ss">f</span><span class="w"> </span><span class="ss">g</span><span class="w"> </span><span class="ss">h</span><span class="w"> </span><span class="ss">i</span><span class="p">))</span>

<span class="p">(</span><span class="n">intersection-set</span><span class="w"> </span><span class="n">set1</span><span class="w"> </span><span class="n">set2</span><span class="p">)</span>
<span class="p">(</span><span class="n">union-set</span><span class="w"> </span><span class="n">set1</span><span class="w"> </span><span class="n">set2</span><span class="p">)</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>(c d e f)
(a b c d e f c d e f g h i)
</pre>
</div>
</div>

<h4 id="exercise-261">Exercise 2.61</h4>
<p>Give an implementation of
<code>adjoin-set</code> using the ordered representation.  By analogy with
<code>element-of-set?</code> show how to take advantage of the ordering to produce a
procedure that requires on the average about half as many steps as with the
unordered representation.</p>
<h5>Solution</h5>
<div class="code-box">
<div class="code-header"><a href="code/ex2-61.rkt">code/ex2-61.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nb">set</span><span class="p">))</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nb">set</span><span class="p">))))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nb">set</span><span class="p">))</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">set</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">set0</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="mi">12</span><span class="p">))</span>

<span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">set0</span><span class="p">)</span>
<span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">set0</span><span class="p">)</span>
<span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">set0</span><span class="p">)</span>
<span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="n">set0</span><span class="p">)</span>
<span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">set0</span><span class="p">)</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>(0 4 8 12)
(0 4 5 8 12)
(0 1 4 8 12)
(-1 0 4 8 12)
(0 4 8 12 16)
</pre>
</div>
</div>

<h4 id="exercise-262">Exercise 2.62</h4>
<p>Give a $\Theta(n)$
implementation of <code>union-set</code> for sets represented as ordered lists.</p>
<h5>Solution</h5>
<div class="code-box">
<div class="code-header"><a href="code/ex2-62.rkt">code/ex2-62.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">element-of-set?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span><span class="w"> </span><span class="k">false</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nb">set</span><span class="p">))</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nb">set</span><span class="p">))</span><span class="w"> </span><span class="k">false</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">element-of-set?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nb">set</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nb">set</span><span class="p">))</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nb">set</span><span class="p">))))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nb">set</span><span class="p">))</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">set</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">intersection-set</span><span class="w"> </span><span class="n">set1</span><span class="w"> </span><span class="n">set2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">set2</span><span class="p">))</span>
<span class="w">      </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">x1</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">set1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">x2</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">set2</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="n">x2</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="p">(</span><span class="n">intersection-set</span>
<span class="w">                         </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span>
<span class="w">                         </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">set2</span><span class="p">))))</span>
<span class="w">              </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="n">x2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">intersection-set</span>
<span class="w">                          </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span>
<span class="w">                          </span><span class="n">set2</span><span class="p">))</span>
<span class="w">              </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">x2</span><span class="w"> </span><span class="n">x1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">intersection-set</span>
<span class="w">                          </span><span class="n">set1</span>
<span class="w">                          </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">set2</span><span class="p">)))))))</span>

<span class="c1">;; set1 is an ordered set, set2 is an ordered set,</span>
<span class="c1">;; both with no duplicates</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">union-set</span><span class="w"> </span><span class="n">set1</span><span class="w"> </span><span class="n">set2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span><span class="w"> </span><span class="n">set2</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">set2</span><span class="p">)</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">x1</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">set1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">x2</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">set2</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="n">x2</span><span class="p">)</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="p">(</span><span class="n">union-set</span>
<span class="w">                           </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span>
<span class="w">                           </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">set2</span><span class="p">))))</span>
<span class="w">                </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="n">x2</span><span class="p">)</span><span class="w"> </span>
<span class="w">                 </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="p">(</span><span class="n">union-set</span><span class="w"> </span>
<span class="w">                            </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span>
<span class="w">                            </span><span class="n">set2</span><span class="p">)))</span>
<span class="w">                </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">x2</span><span class="w"> </span><span class="n">x1</span><span class="p">)</span><span class="w"> </span>
<span class="w">                 </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x2</span><span class="w"> </span><span class="p">(</span><span class="n">union-set</span>
<span class="w">                            </span><span class="n">set1</span>
<span class="w">                            </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">set2</span><span class="p">)))))))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">set0</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="mi">12</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">set1</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="mi">-4</span><span class="w"> </span><span class="mi">-3</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">set2</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="mi">20</span><span class="p">))</span>

<span class="p">(</span><span class="n">intersection-set</span><span class="w"> </span><span class="n">set0</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span>
<span class="p">(</span><span class="n">union-set</span><span class="w"> </span><span class="n">set0</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span>
<span class="p">(</span><span class="n">union-set</span><span class="w"> </span><span class="n">set1</span><span class="w"> </span><span class="n">set0</span><span class="p">)</span>
<span class="p">(</span><span class="n">union-set</span><span class="w"> </span><span class="n">set1</span><span class="w"> </span><span class="n">set2</span><span class="p">)</span>
<span class="p">(</span><span class="n">union-set</span><span class="w"> </span><span class="n">set2</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>(0 4)
(-4 -3 0 1 4 8 12)
(-4 -3 0 1 4 8 12)
(-4 -3 0 1 4 16 18 20)
(-4 -3 0 1 4 16 18 20)
</pre>
</div>
</div>

<h4 id="exercise-263">Exercise 2.63</h4>
<p>Each of the following two
procedures converts a binary tree to a list.</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">tree-&gt;list-1</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">      </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">      </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="n">tree-&gt;list-1</span><span class="w"> </span>
<span class="w">        </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>
<span class="w">       </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="n">tree-&gt;list-1</span><span class="w"> </span>
<span class="w">              </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">))))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">tree-&gt;list-2</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">copy-to-list</span><span class="w"> </span><span class="n">tree</span><span class="w"> </span><span class="n">result-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">        </span><span class="n">result-list</span>
<span class="w">        </span><span class="p">(</span><span class="n">copy-to-list</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="n">copy-to-list</span><span class="w"> </span>
<span class="w">                </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">                </span><span class="n">result-list</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">copy-to-list</span><span class="w"> </span><span class="n">tree</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()))</span>
</code></pre></div>

<p><strong>1.</strong> Do the two procedures produce the same result for every tree?  If not, how do
the results differ?  What lists do the two procedures produce for the trees in
Figure 2.16?</p>
<p><strong>2.</strong> Do the two procedures have the same order of growth in the number of steps
required to convert a balanced tree with $n$ elements to a list?  If not,
which one grows more slowly?</p>
<h5>Solution</h5>
<p>An animation of these algorithms would be nice!</p>
<ol>
<li>They both produce the same result for every tree. The implementation below constructs
the different trees and demonstrates this.</li>
<li>The two procedures don't have the same order of growth. The second algorithm is $\Theta(n)$ where $n$ is the number of nodes. The issue with the first algorithm is the append operation,
which first has to traverse a linked list before appending the second list. This sets up a bit 
of a weird recursion. For a perfectly balanced tree, I first thought this is $\Theta(n^2)$ where
$n$ is the number of nodes, but in fact it's $\Theta(n\log(n))$. We can set up a recursion:</li>
</ol>
<p>The time taken for a tree, $T(\text{tree})$ is the sum of...</p>
<ul>
<li>the time taken to append the left tree, $\textrm{Length}(\textrm{left-tree})$</li>
<li>the time taken to construct the left tree, $T(\textrm{left-tree})$</li>
<li>the time taken to construct the right tree, $T(\textrm{right-tree})$</li>
</ul>
<p>So 
$$T(\textrm{tree})=\textrm{Length}(\textrm{left-tree})+T(\textrm{left-tree})+T(\textrm{right-tree})$$</p>
<p>For a perfectly balanced tree of length n, this gives recursion
$$T(n)=\frac{n}{2}+2T(\frac{n}{2})$$
Whose solution is $T(n)=\Theta(n\log(n))$</p>
<div class="code-box">
<div class="code-header"><a href="code/ex2-63.rkt">code/ex2-63.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">caddr</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-tree</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="n">right</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="n">right</span><span class="p">))</span>
<span class="c1">;; trivial tree</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">tt</span><span class="w"> </span><span class="n">entry</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="p">(</span><span class="n">tt</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">three</span><span class="w"> </span><span class="p">(</span><span class="n">tt</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">five</span><span class="w"> </span><span class="p">(</span><span class="n">tt</span><span class="w"> </span><span class="mi">5</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">seven</span><span class="w"> </span><span class="p">(</span><span class="n">tt</span><span class="w"> </span><span class="mi">7</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">nine</span><span class="w"> </span><span class="p">(</span><span class="n">tt</span><span class="w"> </span><span class="mi">9</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">eleven</span><span class="w"> </span><span class="p">(</span><span class="n">tt</span><span class="w"> </span><span class="mi">11</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">tree-one</span><span class="w"> </span><span class="p">(</span><span class="n">make-tree</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="p">(</span><span class="n">make-tree</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">five</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-tree</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()</span><span class="w"> </span><span class="n">eleven</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">tree-two</span><span class="w"> </span><span class="p">(</span><span class="n">make-tree</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="p">(</span><span class="n">make-tree</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">five</span><span class="w"> </span><span class="p">(</span><span class="n">make-tree</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()</span><span class="w"> </span><span class="n">eleven</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">tree-three</span><span class="w"> </span><span class="p">(</span><span class="n">make-tree</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="p">(</span><span class="n">make-tree</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="o">&#39;</span><span class="p">())</span><span class="w"> </span><span class="p">(</span><span class="n">make-tree</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">seven</span><span class="w"> </span><span class="n">eleven</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">element-of-set?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span><span class="w"> </span><span class="k">false</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="nb">set</span><span class="p">))</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="nb">set</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="n">element-of-set?</span><span class="w"> </span>
<span class="w">          </span><span class="n">x</span><span class="w"> </span>
<span class="w">          </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="nb">set</span><span class="p">)))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="nb">set</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="n">element-of-set?</span><span class="w"> </span>
<span class="w">          </span><span class="n">x</span><span class="w"> </span>
<span class="w">          </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="nb">set</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">make-tree</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="nb">set</span><span class="p">))</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="nb">set</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-tree</span>
<span class="w">          </span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="nb">set</span><span class="p">))</span>
<span class="w">          </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="nb">set</span><span class="p">)))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="nb">set</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-tree</span>
<span class="w">          </span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="nb">set</span><span class="p">))))))</span>

<span class="c1">;; Each time we do an append we have to traverse a linked list, </span>
<span class="c1">;; which is of length n, so I think</span>

<span class="c1">;; If it&#39;s a balanced tree, at step 1 we do (n/2) steps</span>
<span class="c1">;; T(tree) = Length(left-tree) + T(left-tree)+ 1 + T(right-tree)</span>
<span class="c1">;; T(N) = N/2 + 2 T(N/2) + 1</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">tree-&gt;list-1</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">      </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">      </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="n">tree-&gt;list-1</span><span class="w"> </span>
<span class="w">        </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>
<span class="w">       </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="n">tree-&gt;list-1</span><span class="w"> </span>
<span class="w">              </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">))))))</span>

<span class="c1">;; Theta(# of nodes?)</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">tree-&gt;list-2</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; Invariant: tree &lt; result-list (for all elements)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">copy-to-list</span><span class="w"> </span><span class="n">tree</span><span class="w"> </span><span class="n">result-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">        </span><span class="n">result-list</span>
<span class="w">        </span><span class="p">(</span><span class="n">copy-to-list</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="n">copy-to-list</span><span class="w"> </span>
<span class="w">                </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">                </span><span class="n">result-list</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">copy-to-list</span><span class="w"> </span><span class="n">tree</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()))</span>

<span class="p">(</span><span class="n">tree-&gt;list-1</span><span class="w"> </span><span class="n">tree-one</span><span class="p">)</span>
<span class="p">(</span><span class="n">tree-&gt;list-2</span><span class="w"> </span><span class="n">tree-one</span><span class="p">)</span>
<span class="p">(</span><span class="n">tree-&gt;list-1</span><span class="w"> </span><span class="n">tree-two</span><span class="p">)</span>
<span class="p">(</span><span class="n">tree-&gt;list-2</span><span class="w"> </span><span class="n">tree-two</span><span class="p">)</span>
<span class="p">(</span><span class="n">tree-&gt;list-1</span><span class="w"> </span><span class="n">tree-three</span><span class="p">)</span>
<span class="p">(</span><span class="n">tree-&gt;list-2</span><span class="w"> </span><span class="n">tree-three</span><span class="p">)</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>(1 3 5 7 9 11)
(1 3 5 7 9 11)
(1 3 5 7 9 11)
(1 3 5 7 9 11)
(1 3 5 7 9 11)
(1 3 5 7 9 11)
</pre>
</div>
</div>

<h4 id="exercise-264">Exercise 2.64</h4>
<p>The following procedure
<code>list-&gt;tree</code> converts an ordered list to a balanced binary tree.  The
helper procedure <code>partial-tree</code> takes as arguments an integer $n$ and
list of at least $n$ elements and constructs a balanced tree containing the
first $n$ elements of the list.  The result returned by <code>partial-tree</code>
is a pair (formed with <code>cons</code>) whose <code>car</code> is the constructed tree
and whose <code>cdr</code> is the list of elements not included in the tree.</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">list-&gt;tree</span><span class="w"> </span><span class="n">elements</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="p">(</span><span class="n">partial-tree</span><span class="w"> </span>
<span class="w">        </span><span class="n">elements</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">elements</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">partial-tree</span><span class="w"> </span><span class="n">elts</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()</span><span class="w"> </span><span class="n">elts</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">left-size</span><span class="w"> </span>
<span class="w">             </span><span class="p">(</span><span class="nb">quotient</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="mi">2</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">left-result</span><span class="w"> </span>
<span class="w">               </span><span class="p">(</span><span class="n">partial-tree</span><span class="w"> </span>
<span class="w">                </span><span class="n">elts</span><span class="w"> </span><span class="n">left-size</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">left-tree</span><span class="w"> </span>
<span class="w">                 </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">left-result</span><span class="p">))</span>
<span class="w">                </span><span class="p">(</span><span class="n">non-left-elts</span><span class="w"> </span>
<span class="w">                 </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">left-result</span><span class="p">))</span>
<span class="w">                </span><span class="p">(</span><span class="n">right-size</span><span class="w"> </span>
<span class="w">                 </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">left-size</span><span class="w"> </span><span class="mi">1</span><span class="p">))))</span>
<span class="w">            </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">this-entry</span><span class="w"> </span>
<span class="w">                   </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">non-left-elts</span><span class="p">))</span>
<span class="w">                  </span><span class="p">(</span><span class="n">right-result</span><span class="w"> </span>
<span class="w">                   </span><span class="p">(</span><span class="n">partial-tree</span><span class="w"> </span>
<span class="w">                    </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">non-left-elts</span><span class="p">)</span>
<span class="w">                    </span><span class="n">right-size</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">right-tree</span><span class="w"> </span>
<span class="w">                     </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">right-result</span><span class="p">))</span>
<span class="w">                    </span><span class="p">(</span><span class="n">remaining-elts</span><span class="w"> </span>
<span class="w">                     </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">right-result</span><span class="p">)))</span>
<span class="w">                </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="n">make-tree</span><span class="w"> </span><span class="n">this-entry</span><span class="w"> </span>
<span class="w">                                 </span><span class="n">left-tree</span><span class="w"> </span>
<span class="w">                                 </span><span class="n">right-tree</span><span class="p">)</span>
<span class="w">                      </span><span class="n">remaining-elts</span><span class="p">))))))))</span>
</code></pre></div>

<p><strong>1.</strong> Write a short paragraph explaining as clearly as you can how
<code>partial-tree</code> works.  Draw the tree produced by <code>list-&gt;tree</code> for
the list <code>(1 3 5 7 9 11)</code>.</p>
<p><strong>2.</strong> What is the order of growth in the number of steps required by
<code>list-&gt;tree</code> to convert a list of $n$ elements?</p>
<h5>Solution</h5>
<p>The key is that we want to be able to write this line:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="n">make-tree</span><span class="w"> </span><span class="n">this-entry</span>
<span class="w">       </span><span class="n">left-tree</span>
<span class="w">       </span><span class="n">right-tree</span><span class="p">)</span>
<span class="w"> </span><span class="n">remaining-elts</span><span class="p">)</span>
</code></pre></div>

<p>In Javascript we'd use something like <code>.slice()</code> to get the first ~n/2
elements, the middle element, and the last ~n/2 elements. The purpose of the 
remaining-elts list basically implements this slicing in a clever way.</p>
<p>For question 2, we don't have any calls to things like <code>length</code> or <code>append</code> 
in our recursion. So our growth should just be linear.</p>
<h4 id="exercise-265">Exercise 2.65</h4>
<p>Use the results of Exercise 2.63 
and Exercise 2.64 to give $\Theta(n)$ implementations of
<code>union-set</code> and <code>intersection-set</code> for sets implemented as (balanced)
binary trees.</p>
<h5>Solution</h5>
<p>We can just combine our previous algorithms:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">union-set-tree</span><span class="w"> </span><span class="n">set1</span><span class="w"> </span><span class="n">set2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">list-&gt;tree</span><span class="w"> </span><span class="p">(</span><span class="n">union-set</span>
<span class="w">               </span><span class="p">(</span><span class="n">tree-&gt;list</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span><span class="w"> </span>
<span class="w">               </span><span class="p">(</span><span class="n">tree-&gt;list</span><span class="w"> </span><span class="n">set2</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">intersection-set-tree</span><span class="w"> </span><span class="n">set1</span><span class="w"> </span><span class="n">set2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">list-&gt;tree</span><span class="w"> </span><span class="p">(</span><span class="n">intersection-set</span><span class="w"> </span>
<span class="w">               </span><span class="p">(</span><span class="n">tree-&gt;list</span><span class="w"> </span><span class="n">set1</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="n">tree-&gt;list</span><span class="w"> </span><span class="n">set2</span><span class="p">))))</span>
</code></pre></div>

<h4 id="exercise-266">Exercise 2.66</h4>
<p>Implement the <code>lookup</code>
procedure for the case where the set of records is structured as a binary tree,
ordered by the numerical values of the keys.</p>
<h5>Solution</h5>
<p>We'll assume we have the same functions like <code>entry, left-branch, right-branch</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">lookup</span><span class="w"> </span><span class="n">given-key</span><span class="w"> </span><span class="n">records</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="k">false</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">given-key</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="n">records</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="n">record</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">given-key</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="n">records</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="n">lookup</span><span class="w"> </span><span class="n">given-key</span><span class="w"> </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="n">records</span><span class="p">)))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">&gt;</span><span class="w"> </span><span class="n">given-key</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="n">records</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="n">lookup</span><span class="w"> </span><span class="n">given-key</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="n">records</span><span class="p">))))))</span>
</code></pre></div>

<h4 id="exercise-267">Exercise 2.67</h4>
<p>Define an encoding tree and a
sample message:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">sample-tree</span>
<span class="w">  </span><span class="p">(</span><span class="n">make-code-tree</span><span class="w"> </span>
<span class="w">   </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">A</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="n">make-code-tree</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">B</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-code-tree</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">D</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">     </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">C</span><span class="w"> </span><span class="mi">1</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">sample-message</span><span class="w"> </span>
<span class="w">  </span><span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
</code></pre></div>

<p>Use the <code>decode</code> procedure to decode the message, and give the result.</p>
<h5>Solution</h5>
<p><code>(A D A B B C A)</code></p>
<div class="code-box">
<div class="code-header"><a href="code/ex2-67.rkt">code/ex2-67.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="n">weight</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">leaf</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="n">weight</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">leaf?</span><span class="w"> </span><span class="n">object</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">object</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">leaf</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">symbol-leaf</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">weight-leaf</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">caddr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">symbols</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">leaf?</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">symbol-leaf</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">caddr</span><span class="w"> </span><span class="n">tree</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">leaf?</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">weight-leaf</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cadddr</span><span class="w"> </span><span class="n">tree</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-code-tree</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="n">right</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">left</span>
<span class="w">        </span><span class="n">right</span>
<span class="w">        </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="p">(</span><span class="nb">symbols</span><span class="w"> </span><span class="n">left</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="nb">symbols</span><span class="w"> </span><span class="n">right</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="n">left</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="n">right</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">decode</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">decode-1</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="n">current-branch</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span>
<span class="w">        </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">next-branch</span>
<span class="w">               </span><span class="p">(</span><span class="n">choose-branch</span>
<span class="w">                </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span>
<span class="w">                </span><span class="n">current-branch</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">leaf?</span><span class="w"> </span><span class="n">next-branch</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="nb">cons</span>
<span class="w">               </span><span class="p">(</span><span class="n">symbol-leaf</span><span class="w"> </span><span class="n">next-branch</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="n">decode-1</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="n">decode-1</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span>
<span class="w">                        </span><span class="n">next-branch</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">decode-1</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">choose-branch</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">branch</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="n">branch</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="n">branch</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;bad bit:</span>
<span class="s2">               CHOOSE-BRANCH&quot;</span><span class="w"> </span><span class="n">bit</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nb">set</span><span class="p">)))</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">set</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nb">set</span><span class="p">))))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-leaf-set</span><span class="w"> </span><span class="n">pairs</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">pairs</span><span class="p">)</span>
<span class="w">      </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">pair</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">pairs</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">pair</span><span class="p">)</span><span class="w">    </span><span class="c1">; symbol</span>
<span class="w">                    </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">pair</span><span class="p">))</span><span class="w">  </span><span class="c1">; frequency</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-leaf-set</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">pairs</span><span class="p">))))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">sample-tree</span>
<span class="w">  </span><span class="p">(</span><span class="n">make-code-tree</span><span class="w"> </span>
<span class="w">   </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">A</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="n">make-code-tree</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">B</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-code-tree</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">D</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">     </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">C</span><span class="w"> </span><span class="mi">1</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">sample-message</span><span class="w"> </span>
<span class="w">  </span><span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>

<span class="p">(</span><span class="n">decode</span><span class="w"> </span><span class="n">sample-message</span><span class="w"> </span><span class="n">sample-tree</span><span class="p">)</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>(A D A B B C A)
</pre>
</div>
</div>

<h4 id="exercise-268">Exercise 2.68</h4>
<p>The <code>encode</code> procedure takes
as arguments a message and a tree and produces the list of bits that gives the
encoded message.</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">encode</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">message</span><span class="p">)</span>
<span class="w">      </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">      </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="n">encode-symbol</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span>
<span class="w">                      </span><span class="n">tree</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">encode</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="n">tree</span><span class="p">))))</span>
</code></pre></div>

<p><code>Encode-symbol</code> is a procedure, which you must write, that returns the
list of bits that encodes a given symbol according to a given tree.  You should
design <code>encode-symbol</code> so that it signals an error if the symbol is not in
the tree at all.  Test your procedure by encoding the result you obtained in
Exercise 2.67 with the sample tree and seeing whether it is the same as
the original sample message.</p>
<h5>Solution</h5>
<p>Encoding the decoded message returns the correct thing.</p>
<div class="code-box">
<div class="code-header"><a href="code/ex2-68.rkt">code/ex2-68.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="n">weight</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">leaf</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="n">weight</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">leaf?</span><span class="w"> </span><span class="n">object</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">object</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">leaf</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">symbol-leaf</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">weight-leaf</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">caddr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">symbols</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">leaf?</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">symbol-leaf</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">caddr</span><span class="w"> </span><span class="n">tree</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">leaf?</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">weight-leaf</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cadddr</span><span class="w"> </span><span class="n">tree</span><span class="p">)))</span>


<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">element-of-list?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">lst</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">lst</span><span class="p">)</span><span class="w"> </span><span class="k">false</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">lst</span><span class="p">))</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">element-of-list?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">lst</span><span class="p">)))))</span>


<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-code-tree</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="n">right</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">left</span>
<span class="w">        </span><span class="n">right</span>
<span class="w">        </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="p">(</span><span class="nb">symbols</span><span class="w"> </span><span class="n">left</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="nb">symbols</span><span class="w"> </span><span class="n">right</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="n">left</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="n">right</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">decode</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">decode-1</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="n">current-branch</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span>
<span class="w">        </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">next-branch</span>
<span class="w">               </span><span class="p">(</span><span class="n">choose-branch</span>
<span class="w">                </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span>
<span class="w">                </span><span class="n">current-branch</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">leaf?</span><span class="w"> </span><span class="n">next-branch</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="nb">cons</span>
<span class="w">               </span><span class="p">(</span><span class="n">symbol-leaf</span><span class="w"> </span><span class="n">next-branch</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="n">decode-1</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="n">decode-1</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span>
<span class="w">                        </span><span class="n">next-branch</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">decode-1</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">choose-branch</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">branch</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="n">branch</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="n">branch</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;bad bit:</span>
<span class="s2">               CHOOSE-BRANCH&quot;</span><span class="w"> </span><span class="n">bit</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nb">set</span><span class="p">)))</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">set</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nb">set</span><span class="p">))))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-leaf-set</span><span class="w"> </span><span class="n">pairs</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">pairs</span><span class="p">)</span>
<span class="w">      </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">pair</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">pairs</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">pair</span><span class="p">)</span><span class="w">    </span><span class="c1">; symbol</span>
<span class="w">                    </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">pair</span><span class="p">))</span><span class="w">  </span><span class="c1">; frequency</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-leaf-set</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">pairs</span><span class="p">))))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">sample-tree</span>
<span class="w">  </span><span class="p">(</span><span class="n">make-code-tree</span><span class="w"> </span>
<span class="w">   </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">A</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="n">make-code-tree</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">B</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-code-tree</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">D</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">     </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">C</span><span class="w"> </span><span class="mi">1</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">sample-message</span><span class="w"> </span>
<span class="w">  </span><span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">encode</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">message</span><span class="p">)</span>
<span class="w">      </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">      </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="n">encode-symbol</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span>
<span class="w">                      </span><span class="n">tree</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">encode</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="n">tree</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">encode-symbol</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span>
<span class="w">    </span><span class="p">((</span><span class="n">leaf?</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span><span class="w"> </span>
<span class="w">                </span><span class="p">(</span><span class="k">if</span><span class="w"> </span>
<span class="w">                  </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="p">(</span><span class="n">symbol-leaf</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span><span class="w"> </span><span class="n">symbol</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()</span><span class="w"> </span>
<span class="w">                  </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;symbol not in tree &quot;</span><span class="w"> </span><span class="n">symbol</span><span class="p">)))</span>
<span class="w">    </span><span class="p">((</span><span class="n">element-of-list?</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="p">(</span><span class="nb">symbols</span><span class="w"> </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">)))</span><span class="w"> </span>
<span class="w">                    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="o">&#39;</span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="n">encode-symbol</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">))))</span>
<span class="w">    </span><span class="p">((</span><span class="n">element-of-list?</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="p">(</span><span class="nb">symbols</span><span class="w"> </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">)))</span><span class="w"> </span>
<span class="w">                    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="o">&#39;</span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">encode-symbol</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">))))</span>
<span class="w">    </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;symbol not in tree&quot;</span><span class="w"> </span><span class="n">symbol</span><span class="p">))))</span>

<span class="n">sample-message</span>

<span class="p">(</span><span class="n">decode</span><span class="w"> </span><span class="n">sample-message</span><span class="w"> </span><span class="n">sample-tree</span><span class="p">)</span>

<span class="p">(</span><span class="n">encode</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">A</span><span class="w"> </span><span class="ss">D</span><span class="w"> </span><span class="ss">A</span><span class="w"> </span><span class="ss">B</span><span class="w"> </span><span class="ss">B</span><span class="w"> </span><span class="ss">C</span><span class="w"> </span><span class="ss">A</span><span class="p">)</span><span class="w"> </span><span class="n">sample-tree</span><span class="p">)</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>(0 1 1 0 0 1 0 1 0 1 1 1 0)
(A D A B B C A)
(0 1 1 0 0 1 0 1 0 1 1 1 0)
</pre>
</div>
</div>

<h4 id="exercise-269">Exercise 2.69</h4>
<p>The following procedure takes as
its argument a list of symbol-frequency pairs (where no symbol appears in more
than one pair) and generates a Huffman encoding tree according to the Huffman
algorithm.</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">generate-huffman-tree</span><span class="w"> </span><span class="n">pairs</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">successive-merge</span><span class="w"> </span>
<span class="w">   </span><span class="p">(</span><span class="n">make-leaf-set</span><span class="w"> </span><span class="n">pairs</span><span class="p">)))</span>
</code></pre></div>

<p><code>Make-leaf-set</code> is the procedure given above that transforms the list of
pairs into an ordered set of leaves.  <code>Successive-merge</code> is the procedure
you must write, using <code>make-code-tree</code> to successively merge the
smallest-weight elements of the set until there is only one element left, which
is the desired Huffman tree.  (This procedure is slightly tricky, but not
really complicated.  If you find yourself designing a complex procedure, then
you are almost certainly doing something wrong.  You can take significant
advantage of the fact that we are using an ordered set representation.)</p>
<h5>Solution</h5>
<div class="code-box">
<div class="code-header"><a href="code/ex2-69.rkt">code/ex2-69.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="n">weight</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">leaf</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="n">weight</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">leaf?</span><span class="w"> </span><span class="n">object</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">object</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">leaf</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">symbol-leaf</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">weight-leaf</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">caddr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">symbols</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">leaf?</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">symbol-leaf</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">caddr</span><span class="w"> </span><span class="n">tree</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">leaf?</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">weight-leaf</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cadddr</span><span class="w"> </span><span class="n">tree</span><span class="p">)))</span>


<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">element-of-list?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">lst</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">lst</span><span class="p">)</span><span class="w"> </span><span class="k">false</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">lst</span><span class="p">))</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">element-of-list?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">lst</span><span class="p">)))))</span>


<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-code-tree</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="n">right</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">left</span>
<span class="w">        </span><span class="n">right</span>
<span class="w">        </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="p">(</span><span class="nb">symbols</span><span class="w"> </span><span class="n">left</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="nb">symbols</span><span class="w"> </span><span class="n">right</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="n">left</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="n">right</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">decode</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">decode-1</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="n">current-branch</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span>
<span class="w">        </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">next-branch</span>
<span class="w">               </span><span class="p">(</span><span class="n">choose-branch</span>
<span class="w">                </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span>
<span class="w">                </span><span class="n">current-branch</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">leaf?</span><span class="w"> </span><span class="n">next-branch</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="nb">cons</span>
<span class="w">               </span><span class="p">(</span><span class="n">symbol-leaf</span><span class="w"> </span><span class="n">next-branch</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="n">decode-1</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="n">decode-1</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span>
<span class="w">                        </span><span class="n">next-branch</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">decode-1</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">choose-branch</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">branch</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="n">branch</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="n">branch</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;bad bit:</span>
<span class="s2">               CHOOSE-BRANCH&quot;</span><span class="w"> </span><span class="n">bit</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nb">set</span><span class="p">)))</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">set</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nb">set</span><span class="p">))))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-leaf-set</span><span class="w"> </span><span class="n">pairs</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">pairs</span><span class="p">)</span>
<span class="w">      </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">pair</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">pairs</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">pair</span><span class="p">)</span><span class="w">    </span><span class="c1">; symbol</span>
<span class="w">                    </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">pair</span><span class="p">))</span><span class="w">  </span><span class="c1">; frequency</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-leaf-set</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">pairs</span><span class="p">))))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">sample-tree</span>
<span class="w">  </span><span class="p">(</span><span class="n">make-code-tree</span><span class="w"> </span>
<span class="w">   </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">A</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="n">make-code-tree</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">B</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-code-tree</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">D</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">     </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">C</span><span class="w"> </span><span class="mi">1</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">sample-message</span><span class="w"> </span>
<span class="w">  </span><span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">encode</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">message</span><span class="p">)</span>
<span class="w">      </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">      </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="n">encode-symbol</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span>
<span class="w">                      </span><span class="n">tree</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">encode</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="n">tree</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">encode-symbol</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span>
<span class="w">    </span><span class="p">((</span><span class="n">leaf?</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span><span class="w"> </span>
<span class="w">                </span><span class="p">(</span><span class="k">if</span><span class="w"> </span>
<span class="w">                  </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="p">(</span><span class="n">symbol-leaf</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span><span class="w"> </span><span class="n">symbol</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()</span><span class="w"> </span>
<span class="w">                  </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;symbol not in tree &quot;</span><span class="w"> </span><span class="n">symbol</span><span class="p">)))</span>
<span class="w">    </span><span class="p">((</span><span class="n">element-of-list?</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="p">(</span><span class="nb">symbols</span><span class="w"> </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">)))</span><span class="w"> </span>
<span class="w">                    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="o">&#39;</span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="n">encode-symbol</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">))))</span>
<span class="w">    </span><span class="p">((</span><span class="n">element-of-list?</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="p">(</span><span class="nb">symbols</span><span class="w"> </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">)))</span><span class="w"> </span>
<span class="w">                    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="o">&#39;</span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">encode-symbol</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">))))</span>
<span class="w">    </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;symbol not in tree&quot;</span><span class="w"> </span><span class="n">symbol</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">generate-huffman-tree</span><span class="w"> </span><span class="n">pairs</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">successive-merge</span>
<span class="w">   </span><span class="p">(</span><span class="n">make-leaf-set</span><span class="w"> </span><span class="n">pairs</span><span class="p">)))</span>

<span class="w">    </span><span class="c1">;; merge the symbols of the first two elements of the list</span>
<span class="w">    </span><span class="c1">;; add the weights</span>
<span class="w">    </span><span class="c1">;; make the tree</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">successive-merge</span><span class="w"> </span><span class="n">tree-list</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">tree-list</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">tree-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">a</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">tree-list</span><span class="p">))</span><span class="w"> </span>
<span class="w">          </span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">tree-list</span><span class="p">))</span><span class="w"> </span>
<span class="w">          </span><span class="p">(</span><span class="nb">rest</span><span class="w"> </span><span class="p">(</span><span class="nb">cddr</span><span class="w"> </span><span class="n">tree-list</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">successive-merge</span><span class="w"> </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="p">(</span><span class="n">make-code-tree</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="nb">rest</span><span class="p">)))))</span>

<span class="n">sample-message</span>

<span class="p">(</span><span class="n">decode</span><span class="w"> </span><span class="n">sample-message</span><span class="w"> </span><span class="n">sample-tree</span><span class="p">)</span>

<span class="p">(</span><span class="n">encode</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">A</span><span class="w"> </span><span class="ss">D</span><span class="w"> </span><span class="ss">A</span><span class="w"> </span><span class="ss">B</span><span class="w"> </span><span class="ss">B</span><span class="w"> </span><span class="ss">C</span><span class="w"> </span><span class="ss">A</span><span class="p">)</span><span class="w"> </span><span class="n">sample-tree</span><span class="p">)</span>


<span class="p">(</span><span class="n">generate-huffman-tree</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="ss">a</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">b</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">c</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">d</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">e</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">f</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">g</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">h</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>(0 1 1 0 0 1 0 1 0 1 1 1 0)
(A D A B B C A)
(0 1 1 0 0 1 0 1 0 1 1 1 0)
((leaf a 8) ((((leaf h 1) (leaf g 1) (h g) 2) ((leaf f 1) (leaf e 1) (f e) 2) (h g f e) 4) (((leaf d 1) (leaf c 1) (d c) 2) (leaf b 3) (d c b) 5) (h g f e d c b) 9) (a h g f e d c b) 17)
</pre>
</div>
</div>

<p>After staring long enough, this tree is not quite the same as the one given earlier in the chapter (for example <code>b</code> is encoded as <code>111</code> instead of <code>100</code>), but that's fine.</p>
<div style="text-align: center; margin: 20px 0;">
  <img src="media/ex2-69-light.svg" style="width: 70%; max-width: 800px;" alt="It's the answer to the question. David gets an A+">
</div>

<h4 id="exercise-270">Exercise 2.70</h4>
<p>The following eight-symbol
alphabet with associated relative frequencies was designed to efficiently
encode the lyrics of 1950s rock songs.  (Note that the <code>symbols'' of an</code>alphabet'' need not be individual letters.)</p>
<table>
  <tr><td>A</td><td>2</td><td>NA</td><td>16</td></tr>
  <tr><td>BOOM</td><td>1</td><td>SHA</td><td>3</td></tr>
  <tr><td>GET</td><td>2</td><td>YIP</td><td>9</td></tr>
  <tr><td>JOB</td><td>2</td><td>WAH</td><td>1</td></tr>
</table>

<p>Use <code>generate-huffman-tree</code> (Exercise 2.69) to generate a
corresponding Huffman tree, and use <code>encode</code> (Exercise 2.68) to
encode the following message:</p>
<div class="codehilite"><pre><span></span><code>Get a job
Sha na na na na na na na na

Get a job
Sha na na na na na na na na

Wah yip yip yip yip 
yip yip yip yip yip
Sha boom
</code></pre></div>

<p>How many bits are required for the encoding?  What is the smallest number of
bits that would be needed to encode this song if we used a fixed-length code
for the eight-symbol alphabet?</p>
<h5>Solution</h5>
<div class="code-box">
<div class="code-header"><a href="code/ex2-70.rkt">code/ex2-70.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="n">weight</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">leaf</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="n">weight</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">leaf?</span><span class="w"> </span><span class="n">object</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">object</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">leaf</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">symbol-leaf</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">weight-leaf</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">caddr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">symbols</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">leaf?</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">symbol-leaf</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">caddr</span><span class="w"> </span><span class="n">tree</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">leaf?</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">weight-leaf</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cadddr</span><span class="w"> </span><span class="n">tree</span><span class="p">)))</span>


<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">element-of-list?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">lst</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">lst</span><span class="p">)</span><span class="w"> </span><span class="k">false</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">lst</span><span class="p">))</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">element-of-list?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">lst</span><span class="p">)))))</span>


<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-code-tree</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="n">right</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">left</span>
<span class="w">        </span><span class="n">right</span>
<span class="w">        </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="p">(</span><span class="nb">symbols</span><span class="w"> </span><span class="n">left</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="nb">symbols</span><span class="w"> </span><span class="n">right</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="n">left</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="n">right</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">decode</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">decode-1</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="n">current-branch</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span>
<span class="w">        </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">next-branch</span>
<span class="w">               </span><span class="p">(</span><span class="n">choose-branch</span>
<span class="w">                </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span>
<span class="w">                </span><span class="n">current-branch</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">leaf?</span><span class="w"> </span><span class="n">next-branch</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="nb">cons</span>
<span class="w">               </span><span class="p">(</span><span class="n">symbol-leaf</span><span class="w"> </span><span class="n">next-branch</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="n">decode-1</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="n">decode-1</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span>
<span class="w">                        </span><span class="n">next-branch</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">decode-1</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">choose-branch</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">branch</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="n">branch</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="n">branch</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;bad bit:</span>
<span class="s2">               CHOOSE-BRANCH&quot;</span><span class="w"> </span><span class="n">bit</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nb">set</span><span class="p">)))</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">set</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nb">set</span><span class="p">))))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-leaf-set</span><span class="w"> </span><span class="n">pairs</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">pairs</span><span class="p">)</span>
<span class="w">      </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">pair</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">pairs</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">pair</span><span class="p">)</span><span class="w">    </span><span class="c1">; symbol</span>
<span class="w">                    </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">pair</span><span class="p">))</span><span class="w">  </span><span class="c1">; frequency</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-leaf-set</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">pairs</span><span class="p">))))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">sample-tree</span>
<span class="w">  </span><span class="p">(</span><span class="n">make-code-tree</span><span class="w"> </span>
<span class="w">   </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">A</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="n">make-code-tree</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">B</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-code-tree</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">D</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">     </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">C</span><span class="w"> </span><span class="mi">1</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">sample-message</span><span class="w"> </span>
<span class="w">  </span><span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">encode</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">message</span><span class="p">)</span>
<span class="w">      </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">      </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="n">encode-symbol</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span>
<span class="w">                      </span><span class="n">tree</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">encode</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="n">tree</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">encode-symbol</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span>
<span class="w">    </span><span class="p">((</span><span class="n">leaf?</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span><span class="w"> </span>
<span class="w">                </span><span class="p">(</span><span class="k">if</span><span class="w"> </span>
<span class="w">                  </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="p">(</span><span class="n">symbol-leaf</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span><span class="w"> </span><span class="n">symbol</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()</span><span class="w"> </span>
<span class="w">                  </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;symbol not in tree &quot;</span><span class="w"> </span><span class="n">symbol</span><span class="p">)))</span>
<span class="w">    </span><span class="p">((</span><span class="n">element-of-list?</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="p">(</span><span class="nb">symbols</span><span class="w"> </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">)))</span><span class="w"> </span>
<span class="w">                    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="o">&#39;</span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="n">encode-symbol</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">))))</span>
<span class="w">    </span><span class="p">((</span><span class="n">element-of-list?</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="p">(</span><span class="nb">symbols</span><span class="w"> </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">)))</span><span class="w"> </span>
<span class="w">                    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="o">&#39;</span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">encode-symbol</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">))))</span>
<span class="w">    </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;symbol not in tree&quot;</span><span class="w"> </span><span class="n">symbol</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">generate-huffman-tree</span><span class="w"> </span><span class="n">pairs</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">successive-merge</span>
<span class="w">   </span><span class="p">(</span><span class="n">make-leaf-set</span><span class="w"> </span><span class="n">pairs</span><span class="p">)))</span>

<span class="w">    </span><span class="c1">;; merge the symbols of the first two elements of the list</span>
<span class="w">    </span><span class="c1">;; add the weights</span>
<span class="w">    </span><span class="c1">;; make the tree</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">successive-merge</span><span class="w"> </span><span class="n">tree-list</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">tree-list</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">tree-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">a</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">tree-list</span><span class="p">))</span><span class="w"> </span>
<span class="w">          </span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">tree-list</span><span class="p">))</span><span class="w"> </span>
<span class="w">          </span><span class="p">(</span><span class="nb">rest</span><span class="w"> </span><span class="p">(</span><span class="nb">cddr</span><span class="w"> </span><span class="n">tree-list</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">successive-merge</span><span class="w"> </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="p">(</span><span class="n">make-code-tree</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="nb">rest</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">my-tree</span><span class="w"> </span><span class="p">(</span><span class="n">generate-huffman-tree</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="ss">a</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">na</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">boom</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">sha</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">get</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">yip</span><span class="w"> </span><span class="mi">9</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">job</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">wah</span><span class="w"> </span><span class="mi">1</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">lyrics</span>
<span class="w">  </span><span class="o">&#39;</span><span class="p">(</span><span class="ss">get</span><span class="w"> </span><span class="ss">a</span><span class="w"> </span><span class="ss">job</span><span class="w"> </span><span class="ss">sha</span><span class="w"> </span><span class="ss">na</span><span class="w"> </span><span class="ss">na</span><span class="w"> </span><span class="ss">na</span><span class="w"> </span><span class="ss">na</span><span class="w"> </span><span class="ss">na</span><span class="w"> </span><span class="ss">na</span><span class="w"> </span><span class="ss">na</span><span class="w"> </span><span class="ss">na</span><span class="w"> </span><span class="ss">get</span><span class="w"> </span><span class="ss">a</span><span class="w"> </span><span class="ss">job</span><span class="w"> </span>
<span class="w">    </span><span class="ss">sha</span><span class="w"> </span><span class="ss">na</span><span class="w"> </span><span class="ss">na</span><span class="w"> </span><span class="ss">na</span><span class="w"> </span><span class="ss">na</span><span class="w"> </span><span class="ss">na</span><span class="w"> </span><span class="ss">na</span><span class="w"> </span><span class="ss">na</span><span class="w"> </span><span class="ss">na</span><span class="w"> </span><span class="ss">wah</span><span class="w"> </span><span class="ss">yip</span><span class="w"> </span><span class="ss">yip</span><span class="w"> </span><span class="ss">yip</span><span class="w"> </span><span class="ss">yip</span><span class="w"> </span><span class="ss">yip</span><span class="w"> </span><span class="ss">yip</span><span class="w"> </span><span class="ss">yip</span><span class="w"> </span><span class="ss">yip</span><span class="w"> </span><span class="ss">yip</span>
<span class="w">    </span><span class="ss">sha</span><span class="w"> </span><span class="ss">boom</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">encoded-lyrics</span><span class="w"> </span><span class="p">(</span><span class="n">encode</span><span class="w"> </span><span class="n">lyrics</span><span class="w"> </span><span class="n">my-tree</span><span class="p">))</span>

<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Encoded sequence:&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="n">encoded-lyrics</span>
<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Encoded sequence length:&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">encoded-lyrics</span><span class="p">)</span>
<span class="p">(</span><span class="nb">newline</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="s2">&quot;Decoding of the encoding:&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
<span class="p">(</span><span class="n">decode</span><span class="w"> </span><span class="n">encoded-lyrics</span><span class="w"> </span><span class="n">my-tree</span><span class="p">)</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>
Encoded sequence:
(1 1 1 1 1 1 1 0 0 1 1 1 1 0 1 1 1 0 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 0 0 1 1 1 1 0 1 1 1 0 0 0 0 0 0 0 0 0 1 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 1 1 0 1 1 0 1 1)

Encoded sequence length:
84

Decoding of the encoding:
(get a job sha na na na na na na na na get a job sha na na na na na na na na wah yip yip yip yip yip yip yip yip yip sha boom)
</pre>
</div>
</div>

<h4 id="exercise-271">Exercise 2.71</h4>
<p>Suppose we have a Huffman tree
for an alphabet of $n$ symbols, and that the relative frequencies of the
symbols are $1, 2, 4, \dots, 2^{n-1}$.  Sketch the tree for $n=5$; for
$n=10$.  In such a tree (for general $n$) how many bits are required to
encode the most frequent symbol?  The least frequent symbol?</p>
<h5>Solution</h5>
<p>In my implementation it's a left-heavy tree, $2^{n-1}$ is encoded as <code>1</code>, 
0 (with a frequency of $2^0=1$) is encoded as $0\ldots 0$. </p>
<div class="code-box">
<div class="code-header"><a href="code/ex2-71.rkt">code/ex2-71.rkt</a></div>

<div class="codehilite"><pre><span></span><code><span class="kn">#lang </span><span class="nn">sicp</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="n">weight</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">leaf</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="n">weight</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">leaf?</span><span class="w"> </span><span class="n">object</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">eq?</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">object</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">leaf</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">symbol-leaf</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">weight-leaf</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">caddr</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">symbols</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">leaf?</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="n">symbol-leaf</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">caddr</span><span class="w"> </span><span class="n">tree</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">leaf?</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">weight-leaf</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cadddr</span><span class="w"> </span><span class="n">tree</span><span class="p">)))</span>


<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">element-of-list?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">lst</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="n">lst</span><span class="p">)</span><span class="w"> </span><span class="k">false</span><span class="p">)</span>
<span class="w">        </span><span class="p">((</span><span class="nb">equal?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">lst</span><span class="p">))</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">element-of-list?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">lst</span><span class="p">)))))</span>


<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-code-tree</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="n">right</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">left</span>
<span class="w">        </span><span class="n">right</span>
<span class="w">        </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="p">(</span><span class="nb">symbols</span><span class="w"> </span><span class="n">left</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="nb">symbols</span><span class="w"> </span><span class="n">right</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="n">left</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="n">right</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">decode</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">decode-1</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="n">current-branch</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span>
<span class="w">        </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">next-branch</span>
<span class="w">               </span><span class="p">(</span><span class="n">choose-branch</span>
<span class="w">                </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span>
<span class="w">                </span><span class="n">current-branch</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">leaf?</span><span class="w"> </span><span class="n">next-branch</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="nb">cons</span>
<span class="w">               </span><span class="p">(</span><span class="n">symbol-leaf</span><span class="w"> </span><span class="n">next-branch</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="n">decode-1</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="n">decode-1</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span>
<span class="w">                        </span><span class="n">next-branch</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">decode-1</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="n">tree</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">choose-branch</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">branch</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="n">branch</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="n">branch</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;bad bit:</span>
<span class="s2">               CHOOSE-BRANCH&quot;</span><span class="w"> </span><span class="n">bit</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null?</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">        </span><span class="p">((</span><span class="nb">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nb">set</span><span class="p">)))</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">set</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="k">else</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nb">set</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nb">set</span><span class="p">))))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">make-leaf-set</span><span class="w"> </span><span class="n">pairs</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">pairs</span><span class="p">)</span>
<span class="w">      </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">pair</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">pairs</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">pair</span><span class="p">)</span><span class="w">    </span><span class="c1">; symbol</span>
<span class="w">                    </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">pair</span><span class="p">))</span><span class="w">  </span><span class="c1">; frequency</span>
<span class="w">         </span><span class="p">(</span><span class="n">make-leaf-set</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">pairs</span><span class="p">))))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">sample-tree</span>
<span class="w">  </span><span class="p">(</span><span class="n">make-code-tree</span><span class="w"> </span>
<span class="w">   </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">A</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="n">make-code-tree</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">B</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">make-code-tree</span><span class="w"> </span>
<span class="w">     </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">D</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">     </span><span class="p">(</span><span class="n">make-leaf</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">C</span><span class="w"> </span><span class="mi">1</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">sample-message</span><span class="w"> </span>
<span class="w">  </span><span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">encode</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null?</span><span class="w"> </span><span class="n">message</span><span class="p">)</span>
<span class="w">      </span><span class="o">&#39;</span><span class="p">()</span>
<span class="w">      </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span>
<span class="w">       </span><span class="p">(</span><span class="n">encode-symbol</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span>
<span class="w">                      </span><span class="n">tree</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="n">encode</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="n">tree</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">encode-symbol</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span>
<span class="w">    </span><span class="p">((</span><span class="n">leaf?</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span><span class="w"> </span>
<span class="w">                </span><span class="p">(</span><span class="k">if</span><span class="w"> </span>
<span class="w">                  </span><span class="p">(</span><span class="nb">equal?</span><span class="w"> </span><span class="p">(</span><span class="n">symbol-leaf</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span><span class="w"> </span><span class="n">symbol</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">()</span><span class="w"> </span>
<span class="w">                  </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;symbol not in tree &quot;</span><span class="w"> </span><span class="n">symbol</span><span class="p">)))</span>
<span class="w">    </span><span class="p">((</span><span class="n">element-of-list?</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="p">(</span><span class="nb">symbols</span><span class="w"> </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">)))</span><span class="w"> </span>
<span class="w">                    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="o">&#39;</span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="n">encode-symbol</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">))))</span>
<span class="w">    </span><span class="p">((</span><span class="n">element-of-list?</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="p">(</span><span class="nb">symbols</span><span class="w"> </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">)))</span><span class="w"> </span>
<span class="w">                    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="o">&#39;</span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">encode-symbol</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="p">(</span><span class="n">right-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">))))</span>
<span class="w">    </span><span class="p">(</span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s2">&quot;symbol not in tree&quot;</span><span class="w"> </span><span class="n">symbol</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">generate-huffman-tree</span><span class="w"> </span><span class="n">pairs</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">successive-merge</span>
<span class="w">   </span><span class="p">(</span><span class="n">make-leaf-set</span><span class="w"> </span><span class="n">pairs</span><span class="p">)))</span>

<span class="w">    </span><span class="c1">;; merge the symbols of the first two elements of the list</span>
<span class="w">    </span><span class="c1">;; add the weights</span>
<span class="w">    </span><span class="c1">;; make the tree</span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">successive-merge</span><span class="w"> </span><span class="n">tree-list</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="n">tree-list</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">tree-list</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="n">a</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="n">tree-list</span><span class="p">))</span><span class="w"> </span>
<span class="w">          </span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="n">tree-list</span><span class="p">))</span><span class="w"> </span>
<span class="w">          </span><span class="p">(</span><span class="nb">rest</span><span class="w"> </span><span class="p">(</span><span class="nb">cddr</span><span class="w"> </span><span class="n">tree-list</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">successive-merge</span><span class="w"> </span><span class="p">(</span><span class="n">adjoin-set</span><span class="w"> </span><span class="p">(</span><span class="n">make-code-tree</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="nb">rest</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">my-tree</span><span class="w"> </span><span class="p">(</span><span class="n">generate-huffman-tree</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="ss">a</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">na</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">boom</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">sha</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">get</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">yip</span><span class="w"> </span><span class="mi">9</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">job</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">wah</span><span class="w"> </span><span class="mi">1</span><span class="p">))))</span>


<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">pow2-tree</span><span class="w"> </span><span class="n">n2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">pow2-list</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">nil</span>
<span class="w">      </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">n2</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">pow2-list</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">arg</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="n">generate-huffman-tree</span><span class="w"> </span><span class="p">(</span><span class="n">pow2-list</span><span class="w"> </span><span class="n">n2</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span>

<span class="p">(</span><span class="n">pow2-tree</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<span class="p">(</span><span class="n">pow2-tree</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
</code></pre></div>


<div class="code-output">
<span>Output:</span>
<pre>(((((leaf 0 1) (leaf 1 2) (0 1) 3) (leaf 2 4) (0 1 2) 7) (leaf 3 8) (0 1 2 3) 15) (leaf 4 16) (0 1 2 3 4) 31)
((((((((((leaf 0 1) (leaf 1 2) (0 1) 3) (leaf 2 4) (0 1 2) 7) (leaf 3 8) (0 1 2 3) 15) (leaf 4 16) (0 1 2 3 4) 31) (leaf 5 32) (0 1 2 3 4 5) 63) (leaf 6 64) (0 1 2 3 4 5 6) 127) (leaf 7 128) (0 1 2 3 4 5 6 7) 255) (leaf 8 256) (0 1 2 3 4 5 6 7 8) 511) (leaf 9 512) (0 1 2 3 4 5 6 7 8 9) 1023)
</pre>
</div>
</div>

<h4 id="exercise-272">Exercise 2.72</h4>
<p>Consider the encoding procedure
that you designed in Exercise 2.68.  What is the order of growth in the
number of steps needed to encode a symbol?  Be sure to include the number of
steps needed to search the symbol list at each node encountered.  To answer
this question in general is difficult.  Consider the special case where the
relative frequencies of the $n$ symbols are as described in Exercise 2.71, 
and give the order of growth (as a function of $n$) of the number of
steps needed to encode the most frequent and least frequent symbols in the
alphabet.</p>
<h5>Solution</h5>
<p>For encoding the most common symbol, it's actually going to be $\Theta(n)$
specifically because of the element checking in the line:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="n">element-of-list?</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="p">(</span><span class="nb">symbols</span><span class="w"> </span><span class="p">(</span><span class="n">left-branch</span><span class="w"> </span><span class="n">tree</span><span class="p">)))</span>
</code></pre></div>

<p>For encoding the least common symbol, I could have been fancy and sorted the symbols list during construction, so that each lookup would also be $\Theta(1)$ 
(it would be the first symbol tested). But if I assume the symbols are in a random order, each lookup will be $\Theta(n)$. We have to do $n$ of these, so 
in fact this is a worst case situation, and the encoding is $\Theta(n^2)$! </p>
<p>If we're encoding symbol $k$, on the first step we search a list of size
$n-1$, then $n-2$, ... to $n-k$. This is 
$$\sum_{i=1}^k (n-i) = \frac{k (2n-1-k)}{2}$$</p>
<p>If each $k$ is weighted by $2^{n-k-1}$ (meaning, the symbol with $k=0$ 
has frequency $2^{n-1}$) then the expectation value is...</p>
<div class="codehilite"><pre><span></span><code><span class="n">In</span><span class="p">[</span><span class="mi">29</span><span class="p">]</span><span class="o">:=</span><span class="w"> </span>
<span class="w">  </span><span class="n">weight</span><span class="p">[</span><span class="nv">k_</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">^</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="n">P</span><span class="p">[</span><span class="nv">k_</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">weight</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="n">Sum</span><span class="p">[</span><span class="n">weight</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">}];</span>
<span class="w">  </span><span class="n">Sum</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="n">P</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">}]</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">FullSimplify</span>

<span class="n">Out</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mi">-2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">((</span><span class="mi">-3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="mi">-1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="o">^</span><span class="n">n</span><span class="p">))</span>
</code></pre></div>

<p>Which means that we have an expected encoding time of order $\Theta(n)$, 
but the worst case encoding time is $\Theta(n^2)$.</p>
<!--
$n$ is the number of symbols. 
Let's look at my impl of successive-merge. 
For the tree in exercise 2.71, `car tree-list` contains the rest of the tree
and `cadr tree-list` contains the current leaf.


<div class="codehilite"><pre><span></span><code><span class="ss">(</span><span class="nv">define</span><span class="w"> </span><span class="ss">(</span><span class="nv">successive</span><span class="o">-</span><span class="nv">merge</span><span class="w"> </span><span class="nv">tree</span><span class="o">-</span><span class="nv">list</span><span class="ss">)</span><span class="w"> </span>
<span class="w">  </span><span class="ss">(</span><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ss">(</span><span class="nv">length</span><span class="w"> </span><span class="nv">tree</span><span class="o">-</span><span class="nv">list</span><span class="ss">))</span><span class="w"> </span><span class="ss">(</span><span class="nv">car</span><span class="w"> </span><span class="nv">tree</span><span class="o">-</span><span class="nv">list</span><span class="ss">)</span>
<span class="w">    </span><span class="ss">(</span><span class="nv">let</span><span class="w"> </span><span class="ss">((</span><span class="nv">a</span><span class="w"> </span><span class="ss">(</span><span class="nv">car</span><span class="w"> </span><span class="nv">tree</span><span class="o">-</span><span class="nv">list</span><span class="ss">))</span><span class="w"> </span>
<span class="w">          </span><span class="ss">(</span><span class="nv">b</span><span class="w"> </span><span class="ss">(</span><span class="nv">cadr</span><span class="w"> </span><span class="nv">tree</span><span class="o">-</span><span class="nv">list</span><span class="ss">))</span><span class="w"> </span>
<span class="w">          </span><span class="ss">(</span><span class="nv">rest</span><span class="w"> </span><span class="ss">(</span><span class="nv">cddr</span><span class="w"> </span><span class="nv">tree</span><span class="o">-</span><span class="nv">list</span><span class="ss">)))</span>
<span class="w">      </span><span class="ss">(</span><span class="nv">successive</span><span class="o">-</span><span class="nv">merge</span><span class="w"> </span><span class="ss">(</span><span class="nv">adjoin</span><span class="o">-</span><span class="nv">set</span><span class="w"> </span><span class="ss">(</span><span class="nv">make</span><span class="o">-</span><span class="nv">code</span><span class="o">-</span><span class="nv">tree</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">b</span><span class="ss">)</span><span class="w"> </span><span class="nv">rest</span><span class="ss">)))))</span>
</code></pre></div>



The time taken to execute successive-merge will depend on the number of 
symbols in the list. Each time we call adjoin, we decrease the number of 
symbols by one. In fact the very special form of the frequencies means we
never have to worry about re-sorting the list; we expect adjoin-set to always
append at the beginning. This is because when we adjoin frequencies (1+2), this 
is still less than 4. Frequencies (1+2+4) is less than 8, and so on. 
So adjoin-set is going to be O(1) in all cases.

So this is easy, it's just $\Theta(n)$ to build the tree, 
-->
    </div>
</body>
</html>
